<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>שיבוץ חודשי - סיגלית</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="header-functions.js"></script>
    <style>
        /* Container spacing for header and footer */
        body {
            padding-bottom: 80px; /* Space for footer */
        }
        
        .container {
            margin-top: 20px; /* Space for header */
        }
        
        #main-footer .footer-icon {
            font-size: 1.3em;
            margin-left: 7px;
          color: #4891ca;
          filter: drop-shadow(0 0 2px #e3f1fb);
        }
        
        @media (max-width: 700px) {
            #main-footer { font-size: 0.98em; padding: 12px 0 7px 0; }
        }
        body {
            font-family: 'Heebo', Arial, sans-serif;
            background: #f8fafd;
            margin: 0;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Header Section */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .month-selector select {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            color: #333;
            min-width: 100px;
        }
        
        /* Toolbar */
        .toolbar {
            background: #f8fafc;
            padding: 10px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .toolbar-section {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toolbar-section h3 {
            margin: 0;
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            margin-left: 8px;
        }
        
        /* Button Styles */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }
        
        /* Draft Management */
        .draft-section {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .draft-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            min-width: 120px;
        }
        
        /* Main Content */
        .main-content {
            padding: 20px 30px;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            table-layout: auto;
        }
        
        .schedule-table th,
        .schedule-table td {
            width: 14.28%; /* 100% / 7 days = 14.28% */
            box-sizing: border-box;
        }
        
        .schedule-table tr {
            height: 35px;
        }
        
        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 6px;
            text-align: center;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            font-size: 11px;
            line-height: 1.2;
        }
        
        .schedule-table td {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 4px 2px;
            text-align: center;
            vertical-align: top;
            height: 35px;
            border-radius: 4px;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }
        
        .schedule-table td:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .day-number {
            font-weight: 700;
            font-size: 12px;
            color: #1e293b;
            margin-bottom: 1px;
            line-height: 1;
        }
        
        .day-guides {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-bottom: 1px;
        }
        
        .guide-item-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            padding: 1px 3px;
            font-size: 9px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .guide-item-display:hover {
            background: #e2e8f0;
            transform: scale(1.02);
        }
        
        .guide-overlap {
            border-color: #3b82f6;
            color: #1e40af;
            font-weight: 600;
        }
        
        .guide-regular {
            border-color: #10b981;
            color: #065f46;
            font-weight: 500;
        }
        
        .guide-conan-friday {
            border-color: #f59e0b;
            color: #92400e;
            font-weight: 600;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        /* Individual guide colors - maintaining role distinction but with personal tones */
        .guide-dana.guide-overlap { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .guide-dana.guide-regular { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
        
        .guide-michal.guide-overlap { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .guide-michal.guide-regular { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
        
        .guide-yossi.guide-overlap { background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); }
        .guide-yossi.guide-regular { background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); }
        
        .guide-ronit.guide-overlap { background: linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 100%); }
        .guide-ronit.guide-regular { background: linear-gradient(135deg, #f7fee7 0%, #ecfccb 100%); }
        
        .guide-uri.guide-overlap { background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%); }
        .guide-uri.guide-regular { background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); }
        
        .guide-sara.guide-overlap { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
        .guide-sara.guide-regular { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        
        .guide-tal.guide-overlap { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .guide-tal.guide-regular { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); }
        
        .guide-roni.guide-overlap { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); }
        .guide-roni.guide-regular { background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); }
        
        .guide-noa.guide-overlap { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        .guide-noa.guide-regular { background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); }
        
        .guide-amit.guide-overlap { background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); }
        .guide-amit.guide-regular { background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); }
        
        .guide-role-label {
            font-size: 9px;
            opacity: 0.8;
            font-weight: 400;
            display: block;
        }
        
        .guide-name {
            font-weight: 600;
            display: block;
        }
        
        .edit-day-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        /* Weekend styles */
        .weekend-open {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
        }
        
        .weekend-closed {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #ef4444;
        }
        
        .sabbath {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #f59e0b;
        }
        
        /* Status Bar */
        .status-bar {
            background: #f8fafc;
            padding: 15px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #64748b;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-success { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        
        /* Traffic Light System */
        .traffic-light {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .traffic-light-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .traffic-light-green {
            background: #10b981;
        }
        
        .traffic-light-yellow {
            background: #f59e0b;
        }
        
        .traffic-light-red {
            background: #ef4444;
        }
        
        .availability-reason {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            padding: 4px 8px;
            background: #f1f5f9;
            border-radius: 4px;
            border-left: 3px solid #94a3b8;
        }
        
        .override-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 6px;
        }
        
        .override-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .override-toggle label {
            font-size: 12px;
            color: #92400e;
            font-weight: 500;
        }
        
        .manual-badge, .auto-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            margin-top: 4px;
            display: inline-block;
        }
        
        .manual-badge {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .auto-badge {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .no-assignments {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 20px;
        }
        
        /* Constraint Tags */
        .constraint-tags {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }
        
        .constraint-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            max-width: 100%;
        }
        
        .constraint-icon {
            font-size: 12px;
        }
        
        .constraint-text {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Constraint Type Colors */
        .constraint-vacation {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-constraint {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .constraint-fixed_constraint {
            background-color: #e0e7ff;
            color: #3730a3;
            border: 1px solid #a5b4fc;
        }
        
        .constraint-consecutive {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-blocked {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .constraint-workload_high {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .constraint-workload_medium {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-weekly_rule {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-coordinator_rule {
            background-color: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c084fc;
        }
        
        .constraint-info {
            background-color: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }
        
        /* Enhanced traffic light colors */
        .traffic-light-indicator.yellow {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .traffic-light-indicator.red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .traffic-light-indicator.green {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        /* Section headers for traffic light categories */
        .section-header {
            margin: 15px 0 10px 0;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            border: 2px solid;
        }
        
        .section-header.recommended {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }
        
        .section-header.not-recommended {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-color: #f59e0b;
        }
        
        .section-header h5 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Icons */
        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }
        
        /* Side Panel Styles */
        .side-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .side-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 380px;
            max-width: 90vw;
            background: white;
            box-shadow: -6px 0 24px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        .side-panel.open {
            transform: translateX(0);
        }
        
        .side-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            position: relative;
        }
        
        .side-panel-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .side-panel-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .side-panel-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
        }
        
        .side-panel-date {
            text-align: center;
            margin-top: 4px;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .side-panel-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        
        .panel-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        /* Selected Guides */
        .selected-guides-container {
            margin-bottom: 12px;
        }
        
        .selected-guide-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
        }
        
        .guide-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .guide-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }
        
        .guide-role {
            font-size: 12px;
            color: #64748b;
        }
        
        .remove-guide-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .remove-guide-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.1);
        }
        
        .assignment-status {
            text-align: center;
            margin-top: 8px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-complete {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .status-partial {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .status-empty {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        /* Guide Items */
        .guides-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .guide-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .guide-item.available {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-color: #e2e8f0;
        }
        
        .guide-item.available:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateX(4px);
            border-color: #94a3b8;
        }
        
        .guide-item.available.selected {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .guide-item.blocked {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fca5a5;
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .guide-item.blocked-override {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fcd34d;
            border-style: dashed;
            cursor: pointer;
        }
        
        .guide-item.blocked-override:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }
        
        .guide-item.blocked-override.selected {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #f59e0b;
            color: white;
        }
        
        .guide-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-available {
            background: #10b981;
        }
        
        .status-blocked {
            background: #ef4444;
        }
        
        .status-warning {
            background: #f59e0b;
        }
        
        /* Override Section */
        .override-section {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid #fcd34d;
            border-radius: 12px;
            padding: 16px;
        }
        
        .override-toggle {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
            color: #92400e;
        }
        
        .toggle-input {
            display: none;
        }
        
        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 24px;
            transition: all 0.3s ease;
        }
        
        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-input:checked + .toggle-slider {
            background: #f59e0b;
        }
        
        .toggle-input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }
        
        .override-description {
            font-size: 12px;
            color: #92400e;
            opacity: 0.8;
        }
        
        /* Side Panel Footer */
        .side-panel-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .side-panel-footer .btn {
            min-width: 100px;
        }
        
        /* Responsive for side panel */
        @media (max-width: 768px) {
            .side-panel {
                width: 100vw;
            }
            
            .side-panel-content {
                padding: 20px 16px;
            }
            
            .side-panel-footer {
                padding: 16px;
                flex-direction: column;
            }
            
            .side-panel-footer .btn {
                width: 100%;
            }
        }

        .weekend-type-control {
            margin-top: 8px;
            padding: 4px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
            max-width: 100%;
            overflow: hidden;
        }

        .weekend-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
        }

        .weekend-checkbox input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #8b5cf6;
        }

        .checkbox-label {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60px;
        }
        
        .flexibility-notice {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #1e40af;
        }
        
        .notice-icon {
            font-size: 14px;
        }
        
        .notice-text {
            font-weight: 500;
            line-height: 1.3;
        }
        
        /* Statistics Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .stats-section {
            margin-bottom: 30px;
        }
        
        .stats-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }
        
        .stat-label {
            font-weight: 500;
            color: #555;
        }
        
        .stat-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        .guides-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        /* Workflow Status Modal Styles */
        .workflow-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.finalized {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.draft {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.editable {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.locked {
            background: #f8d7da;
            color: #721c24;
        }

        .drafts-section {
            margin-top: 20px;
        }

        .drafts-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .drafts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .draft-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .draft-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .draft-info strong {
            color: #333;
            font-size: 14px;
        }

        .draft-meta {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Workflow Status Panel Styles */
        .workflow-status-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 2px solid #667eea;
            padding: 8px 20px;
            margin-bottom: 0;
        }

        .workflow-status.finalized {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .workflow-status.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 6px;
            padding: 8px;
        }

        .workflow-status h4 {
            margin: 0 0 6px 0;
            font-size: 14px;
            font-weight: 700;
        }

        /* Coordinator Rules Modal Styles */
        .rules-section {
            margin-bottom: 20px;
        }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .rules-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
        }

        .rules-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }

        .rule-info {
            flex: 1;
        }

        .rule-type {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .rule-icon {
            font-size: 18px;
        }

        .rule-title {
            font-weight: 600;
            color: #374151;
        }

        .rule-description {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .rule-guides {
            color: #059669;
            font-weight: 500;
            font-size: 14px;
        }

        .rule-actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Form Styles for New Rule */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .guide-stat {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #feb2b2;
        }
        
        .guide-name {
            font-weight: bold;
            color: #c53030;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .guide-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .guide-stats-grid span {
            background: rgba(255, 255, 255, 0.7);
            padding: 5px 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: 500;
        }

        /* Statistics Modal Styles */
        .statistics-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .statistics-modal-content {
            max-width: 900px;
            width: 90vw;
            max-height: 90vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .statistics-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .statistics-modal-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .statistics-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .statistics-close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .statistics-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .statistics-quick-stats {
            padding: 24px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .statistics-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .statistics-stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: transform 0.2s ease;
        }

        .statistics-stat-card:hover {
            transform: translateY(-2px);
        }

        .statistics-stat-card.good { border-color: #10b981; }
        .statistics-stat-card.warning { border-color: #f59e0b; }
        .statistics-stat-card.critical { border-color: #ef4444; }

        .statistics-stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .statistics-stat-number.good { color: #10b981; }
        .statistics-stat-number.warning { color: #f59e0b; }
        .statistics-stat-number.critical { color: #ef4444; }

        .statistics-stat-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .statistics-guides-table-section {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .statistics-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .statistics-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            max-height: 300px;
            overflow-y: auto;
        }

        .statistics-guides-table {
            width: 100%;
            border-collapse: collapse;
        }

        .statistics-guides-table th {
            background: #f1f5f9;
            color: #475569;
            font-weight: 600;
            font-size: 12px;
            padding: 12px 8px;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .statistics-guides-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .statistics-guides-table tr:hover {
            background: #f8fafc;
        }

        .statistics-guide-name {
            font-weight: 600;
            color: #1e293b;
            text-align: right;
            padding-right: 12px;
        }

        .statistics-balance-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .statistics-balance-good {
            background: #d1fae5;
            color: #065f46;
        }

        .statistics-balance-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .statistics-balance-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .statistics-recommendations {
            padding: 24px;
            background: #f8fafc;
        }

        .statistics-recommendation-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .statistics-recommendation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border-right: 4px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .statistics-recommendation-icon {
            font-size: 18px;
            min-width: 24px;
        }

        .statistics-recommendation-text {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }

        .statistics-recommendation-action {
            font-size: 12px;
            color: #3b82f6;
            cursor: pointer;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #3b82f6;
            background: transparent;
            transition: all 0.2s ease;
        }

        .statistics-recommendation-action:hover {
            background: #3b82f6;
            color: white;
        }

        .statistics-loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .statistics-loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .statistics-guide-btn {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .statistics-guide-btn:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .statistics-modal-content {
                margin: 10px;
                width: calc(100vw - 20px);
                max-width: none;
            }
            
            .statistics-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .statistics-guides-table {
                font-size: 11px;
            }
            
            .statistics-guides-table th,
            .statistics-guides-table td {
                padding: 8px 4px;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Individual Guide Modal Styles */
        .individual-guide-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .individual-guide-content {
            max-width: 1000px;
            width: 95vw;
            max-height: 95vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .guide-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            position: relative;
        }

        .guide-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .guide-back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .guide-info {
            text-align: center;
            margin: 20px 0;
        }

        .guide-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .guide-name {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }

        .guide-role {
            font-size: 16px;
            opacity: 0.9;
            margin: 0;
        }

        .guide-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 12px;
        }

        .individual-guide-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .guide-quick-stats {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .guide-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .guide-stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            position: relative;
            transition: transform 0.2s ease;
        }

        .guide-stat-card:hover {
            transform: translateY(-2px);
        }

        .guide-stat-card.highlight { border-color: #3b82f6; }
        .guide-stat-card.warning { border-color: #f59e0b; }
        .guide-stat-card.critical { border-color: #ef4444; }
        .guide-stat-card.balanced { border-color: #10b981; }

        .guide-stat-main {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1e293b;
        }

        .guide-stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .guide-stat-comparison {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .guide-stat-comparison.above {
            background: #fee2e2;
            color: #991b1b;
        }

        .guide-stat-comparison.below {
            background: #fef3c7;
            color: #92400e;
        }

        .guide-stat-comparison.balanced {
            background: #d1fae5;
            color: #065f46;
        }

        .guide-calendar-section {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-mini {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-header-day {
            background: #e2e8f0;
            color: #475569;
            font-weight: 600;
            cursor: default;
        }

        .calendar-day.empty {
            background: #f8fafc;
            color: #94a3b8;
            cursor: default;
        }

        .calendar-day.regular {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }

        .calendar-day.overlap {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #10b981;
        }

        .calendar-day.conan {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }

        .calendar-day.weekend {
            background: #f3e8ff;
            color: #7c3aed;
            border: 2px solid #8b5cf6;
        }

        .calendar-day.manual::after {
            content: '🔒';
            position: absolute;
            top: -2px;
            right: -2px;
            font-size: 8px;
        }

        .calendar-legend {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .guide-breakdown-section {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .breakdown-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .breakdown-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-item {
            margin-bottom: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-regular { background: #3b82f6; }
        .progress-overlap { background: #10b981; }
        .progress-conan { background: #f59e0b; }
        .progress-weekend { background: #8b5cf6; }

        .guide-constraints-section {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .constraints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .constraint-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .constraint-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .constraint-item:last-child {
            border-bottom: none;
        }

        .constraint-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .constraint-vacation { background: #fef3c7; color: #92400e; }
        .constraint-fixed { background: #fee2e2; color: #991b1b; }
        .constraint-temp { background: #e0e7ff; color: #3730a3; }

        .constraint-details {
            flex: 1;
        }

        .constraint-type {
            font-weight: 500;
            font-size: 13px;
            color: #374151;
        }

        .constraint-dates {
            font-size: 11px;
            color: #6b7280;
        }

        .guide-actions-section {
            padding: 24px;
            background: #f8fafc;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .guide-action-btn {
            background: white;
            border: 2px solid #e2e8f0;
            color: #374151;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .guide-action-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .guide-action-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .guide-action-btn.primary:hover {
            background: #2563eb;
        }

        .guide-action-btn.warning {
            background: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }

        .guide-action-btn.danger {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        @media (max-width: 768px) {
            .individual-guide-content {
                margin: 10px;
                max-width: none;
                width: calc(100vw - 20px);
            }
            
            .guide-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .breakdown-grid,
            .constraints-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                gap: 4px;
            }
            
            .calendar-day {
                font-size: 10px;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="main-header"></div>

    <!-- Load header and footer -->
    <script>
        // Load header and footer
        fetch('header.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('main-header').innerHTML = html;
                renderHeaderUser();
            });
        
        fetch('footer.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('main-footer').innerHTML = html;
            });

        // Check if user is coordinator
        function checkCoordinatorAccess() {
            const role = localStorage.getItem('role');
            console.log('Checking coordinator access, role:', role);
            
            // Check if user is logged in
            if (!role) {
                console.log('No role found, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            
            // Check if user is coordinator
            if (role !== 'רכז' && role !== 'רכזת') {
                console.log('User is not coordinator, redirecting to dashboard');
                window.location.href = 'dashboard.html';
                return false;
            }
            
            console.log('Coordinator access granted');
            return true;
        }
        
        // Show/hide coordinator links
        function showCoordinatorLinks() {
            const role = localStorage.getItem('role');
            const schedulerLink = document.getElementById('scheduler-link');
            const reportsLink = document.getElementById('reports-link');
            
            if (schedulerLink) {
                schedulerLink.style.display = (role === 'רכז' || role === 'רכזת') ? 'inline-block' : 'none';
            }
            if (reportsLink) {
                reportsLink.style.display = (role === 'רכז' || role === 'רכזת') ? 'inline-block' : 'none';
            }
        }
        
        // Check access on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkCoordinatorAccess();
            showCoordinatorLinks();
        });
    </script>

    <div class="container">
        <!-- Header with Month Selection -->
        <div class="header">
            <h1>שיבוץ חודשי - סיגלית</h1>
            <div class="month-selector">
                <label>בחירת חודש:</label>
                <select id="month-select">
                    <option value="2025-01">ינואר 2025</option>
                    <option value="2025-02">פברואר 2025</option>
                    <option value="2025-03">מרץ 2025</option>
                    <option value="2025-04">אפריל 2025</option>
                    <option value="2025-05">מאי 2025</option>
                    <option value="2025-06">יוני 2025</option>
                    <option value="2025-07">יולי 2025</option>
                    <option value="2025-08" selected>אוגוסט 2025</option>
                    <option value="2025-09">ספטמבר 2025</option>
                    <option value="2025-10">אוקטובר 2025</option>
                    <option value="2025-11">נובמבר 2025</option>
                    <option value="2025-12">דצמבר 2025</option>
                </select>
                <button class="btn btn-primary">טען חודש</button>
            </div>
        </div>

        <!-- Toolbar with organized buttons -->
        <div class="toolbar">
            <!-- Automatic Scheduling -->
            <div class="toolbar-section">
                <h3>שיבוץ אוטומטי</h3>
                <button class="btn btn-success" onclick="runAutoScheduling()">
                    <span class="icon">🤖</span>
                    שבץ אוטומטית
                </button>
                <button class="btn btn-primary" onclick="openAIScheduler()" style="display: none;">
                    <span class="icon">🧠</span>
                    שבץ אוטומטית עם סוכן
                </button>
                <button class="btn btn-danger" onclick="removeAutoScheduled()">
                    <span class="icon">🗑️</span>
                    מחק שיבוץ אוטומטי
                </button>
            </div>

            <!-- Workflow Process (will be added dynamically) -->
            <!-- This section will be managed by updateWorkflowButtons() function -->



            <!-- Rules & Settings -->
            <div class="toolbar-section">
                <h3>חוקים והגדרות</h3>
                <button class="btn btn-secondary" onclick="handleToolbarAction('חוקי שיבוץ')">
                    <span class="icon">📋</span>
                    חוקי שיבוץ
                </button>
                <button class="btn btn-info" onclick="handleToolbarAction('סטטיסטיקות')">
                    <span class="icon">📈</span>
                    סטטיסטיקות
                </button>
            </div>

            <!-- Actions -->
            <div class="toolbar-section">
                <h3>פעולות</h3>
                <button class="btn btn-warning" onclick="handleToolbarAction('נקה הכל')">
                    <span class="icon">🗑️</span>
                    נקה הכל
                </button>
                <button class="btn btn-primary" onclick="handleToolbarAction('ייצא לאקסל')">
                    <span class="icon">📤</span>
                    ייצא לאקסל
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Mock static table (kept for design reference only). Hidden to avoid flicker before dynamic render. -->
            <table class="schedule-table" id="main-schedule-table" style="visibility: hidden;">
                <thead>
                    <tr>
                        <th>ראשון</th>
                        <th>שני</th>
                        <th>שלישי</th>
                        <th>רביעי</th>
                        <th>חמישי</th>
                        <th>שישי</th>
                        <th>שבת</th>
                    </tr>
                </thead>
                <tbody id="calendarBody">
                    <tr>
                        <td>
                            <div class="day-number">1</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-dana">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">דנה</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-michal">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">מיכל</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">2</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-yossi">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">יוסי</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-ronit">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">רונית</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">3</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-uri">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">אורי</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-sara">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">שרה</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">4</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-tal">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">טל</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-roni">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">רוני</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">5</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-noa">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">נועה</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-amit">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">עמית</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td class="weekend-open">
                            <div class="day-number">6</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-dana">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">דנה</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-yossi">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">יוסי</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td class="sabbath">
                            <div class="day-number">7</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-michal">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">מיכל</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-uri">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">אורי</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="day-number">8</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-sara">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">שרה</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-tal">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">טל</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">9</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-roni">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">רוני</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-noa">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">נועה</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">10</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-amit">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">עמית</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-dana">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">דנה</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">11</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-yossi">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">יוסי</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-michal">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">מיכל</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td>
                            <div class="day-number">12</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-uri">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">אורי</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-sara">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">שרה</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td class="weekend-open">
                            <div class="day-number">13</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-tal">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">טל</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-roni">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">רוני</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                        <td class="sabbath">
                            <div class="day-number">14</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-noa">
                                    <span class="guide-role-label">מדריך חפיפה</span>
                                    <span class="guide-name">נועה</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-amit">
                                    <span class="guide-role-label">מדריך רגיל</span>
                                    <span class="guide-name">עמית</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">ערוך</button>
                        </td>
                    </tr>
                    <!-- More rows would be generated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-success"></div>
                <span>28 ימים שובצו</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-warning"></div>
                <span>2 ימים עם חריגות</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-error"></div>
                <span>1 יום לא שובץ</span>
            </div>
            <div class="status-item">
                <span>עדכון אחרון: 15:30</span>
            </div>
        </div>
    </div>

    <!-- Side Panel Overlay -->
    <div id="side-panel-overlay" class="side-panel-overlay"></div>
    
    <!-- Side Panel -->
    <div id="side-panel" class="side-panel">
        <div class="side-panel-header">
            <button class="side-panel-close" id="side-panel-close">×</button>
            <h3 class="side-panel-title">עריכת שיבוץ יומי</h3>
            <div class="side-panel-date">יום רביעי, 11 ביוני 2025</div>
        </div>
        
        <div class="side-panel-content">
            <!-- Current Assignment -->
            <div class="panel-section">
                <h4 class="section-title">מדריכים נבחרים</h4>
                <div class="flexibility-notice">
                    <span class="notice-icon">💡</span>
                    <span class="notice-text">אפשר לשבץ מדריך אחד או שניים - השיבוץ האוטומטי ישלים את השאר</span>
                </div>
                <div class="selected-guides-container">
                    <div class="selected-guide-item">
                        <div class="guide-info">
                            <span class="guide-name">יוסי כהן</span>
                            <span class="guide-role">מדריך בכיר</span>
                        </div>
                        <button class="remove-guide-btn">×</button>
                    </div>
                    <div class="selected-guide-item">
                        <div class="guide-info">
                            <span class="guide-name">מיכל לוי</span>
                            <span class="guide-role">מדריכה</span>
                        </div>
                        <button class="remove-guide-btn">×</button>
                    </div>
                </div>
                <div class="assignment-status">
                    <span class="status-badge status-complete">שיבוץ מלא (2/2)</span>
                </div>
            </div>

            <!-- Available Guides -->
            <div class="panel-section">
                <h4 class="section-title">מדריכים זמינים לשיבוץ</h4>
                <div class="guides-list">
                    <!-- Available guides will be populated by JavaScript -->
                </div>
            </div>

            <!-- Blocked Guides -->
            <div class="panel-section">
                <h4 class="section-title">מדריכים חסומים</h4>
                <div class="guides-list">
                    <!-- Blocked guides will be populated by JavaScript -->
                </div>
            </div>

            <!-- Override Section -->
            <div class="panel-section override-section">
                <div class="override-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="manual-override" class="toggle-input">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Manual Override - עקוף חסימות</span>
                    </label>
                    <div class="override-description">
                        מאפשר לשבץ מדריכים חסומים בהתעלמות מחוקי המערכת
                    </div>
                </div>
            </div>
        </div>

        <!-- Side Panel Footer -->
        <div class="side-panel-footer">
            <button class="btn btn-secondary" onclick="closeSidePanel()">ביטול</button>
            <button class="btn btn-primary" onclick="saveChanges()">שמור שינויים</button>
        </div>
    </div>

    <script>
        // Phase 1 Task 3: Frontend Integration with Backend API
        // Auto-detect API base: when served from dev static server (8080) use localhost:4000, otherwise same-origin '/api'
        // Use centralized API base from header-functions.js
        const API_BASE = `${window.API_BASE_URL}/api`;
        let sidePanelOpen = false;
        let currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
        let currentDate = null;
        let selectedGuides = [];
        let guidesData = [];
        let assignmentTypes = [];
        let shiftTypes = [];

        // Add these variables at the top of your script section
        let workflowStatus = null;
        let availableDrafts = [];
        let isFinalized = false;
        let statisticsData = null;

        // Helper function to get first name from full name
        function getFirstName(fullName) {
            if (!fullName) return '';
            // Split by space and take the first part
            return fullName.split(' ')[0];
        }

        // =====================================================
        // API INTEGRATION FUNCTIONS
        // =====================================================

        async function fetchGuides() {
            try {
                const response = await fetch(`${API_BASE}/guides/enhanced`);
                guidesData = await response.json();
                console.log('Guides loaded:', guidesData);
                return guidesData;
            } catch (error) {
                console.error('Error fetching guides:', error);
                showNotification('שגיאה בטעינת המדריכים', 'error');
            }
        }

        async function fetchGuideAvailability(date) {
            try {
                const response = await fetch(`${API_BASE}/guides/availability/${date}`);
                const availability = await response.json();
                console.log('Availability for', date, ':', availability);
                return availability;
            } catch (error) {
                console.error('Error fetching availability:', error);
                showNotification('שגיאה בטעינת זמינות', 'error');
            }
        }

        async function fetchMonthlySchedule(year, month) {
            try {
                const response = await fetch(`${API_BASE}/schedule/enhanced/${year}/${month}`);
                const schedule = await response.json();
                // Normalize all date fields to YYYY-MM-DD using date_str when available
                const normalized = Array.isArray(schedule) ? schedule.map(d => {
                    const ds = d.date_str || (d.date || '').split('T')[0];
                    return { ...d, date: ds };
                }) : schedule;
                console.log('Schedule loaded (normalized):', normalized);
                return normalized;
            } catch (error) {
                console.error('Error fetching schedule:', error);
                showNotification('שגיאה בטעינת לוח השנה', 'error');
            }
        }

        async function fetchAssignmentTypes() {
            try {
                const response = await fetch(`${API_BASE}/assignment-types`);
                assignmentTypes = await response.json();
                console.log('Assignment types loaded:', assignmentTypes);
                return assignmentTypes;
            } catch (error) {
                console.error('Error fetching assignment types:', error);
            }
        }

        async function fetchShiftTypes() {
            try {
                const response = await fetch(`${API_BASE}/shift-types`);
                shiftTypes = await response.json();
                console.log('Shift types loaded:', shiftTypes);
                return shiftTypes;
            } catch (error) {
                console.error('Error fetching shift types:', error);
            }
        }

        async function saveManualAssignment(date, guide1Id, guide2Id, type) {
            try {
                const requestData = {
                    date: date,
                    guide1_id: guide1Id,
                    guide2_id: guide2Id,
                    type: type,
                    created_by: 1 // TODO: Get from user session
                };
                
                console.log('Sending request data:', requestData);
                
                const response = await fetch(`${API_BASE}/schedule/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                console.log('Response status:', response.status);
                console.log('Response data:', result);
                
                if (result.success) {
                    showNotification('השיבוץ נשמר בהצלחה', 'success');
                    return true;
                } else {
                    showNotification(`שגיאה בשמירת השיבוץ: ${result.error || 'שגיאה לא ידועה'}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving manual assignment:', error);
                showNotification('שגיאה בשמירת השיבוץ', 'error');
                return false;
            }
        }

        async function saveDraft(month, name, data) {
            try {
                const response = await fetch(`${API_BASE}/drafts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        month: month,
                        name: name,
                        data: data,
                        created_by: 1 // TODO: Get from user session
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('הטיוטה נשמרה בהצלחה', 'success');
                    return result;
                } else {
                    showNotification('שגיאה בשמירת הטיוטה', 'error');
                    return null;
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                showNotification('שגיאה בשמירת הטיוטה', 'error');
                return null;
            }
        }

        // =====================================================
        // UI UPDATE FUNCTIONS
        // =====================================================

        function updateCalendarWithSchedule(schedule) {
            const calendarBody = document.querySelector('#calendarBody');
            const tableEl = document.getElementById('main-schedule-table');
            if (!calendarBody) return;
            if (tableEl) tableEl.style.visibility = 'hidden';

            // Clear existing content
            calendarBody.innerHTML = '';

            // Get current month and year from currentMonth selection
            let year, month;
            [year, month] = currentMonth.split('-').map(Number);
            month = month - 1; // JavaScript months are 0-based

            // Generate calendar days for the month
            const weeks = generateCalendarDays(year, month, schedule);
            
            weeks.forEach(week => {
                const row = document.createElement('tr');
                week.forEach(day => {
                    const cell = document.createElement('td');
                    if (day) {
                        cell.innerHTML = createDayCell(day);
                    } else {
                        cell.innerHTML = '<div class="day-number">-</div>';
                    }
                    row.appendChild(cell);
                });
                calendarBody.appendChild(row);
            });
            if (tableEl) tableEl.style.visibility = 'visible';
        }

        function generateCalendarDays(year, month, schedule) {
            const weeks = [];
            let currentWeek = [];
            
            // Get first day of month and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Get day of week for first day (0 = Sunday, 1 = Monday, etc.)
            const firstDayOfWeek = firstDay.getDay();
            
            // Add empty cells for days before the first day of the month
            console.log(`First day of month ${month + 1}/${year} is ${firstDay.toDateString()}, day of week: ${firstDayOfWeek}`);
            console.log(`Adding ${firstDayOfWeek} empty cells at the start`);
            for (let i = 0; i < firstDayOfWeek; i++) {
                currentWeek.push(null);
            }
            
            // Add all days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                // Use local date formatting to avoid timezone issues
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                console.log(`Generated date for day ${day}: ${dateString} (${date.toDateString()}) - Day of week: ${date.getDay()}`);
            
            // Debug the exact positioning
            if (day <= 5) {
                console.log(`  -> Day ${day} should be in column ${date.getDay()} (0=ראשון, 1=שני, 2=שלישי, 3=רביעי, 4=חמישי, 5=שישי, 6=שבת)`);
            }
                
                // Find if there's schedule data for this day
                const scheduleDay = schedule ? schedule.find(s => {
                    // Handle both ISO format (2025-08-01T21:00:00.000Z) and simple format (2025-08-01)
                    const scheduleDate = (s.date || '').split('T')[0]; // Extract just the date part
                    return scheduleDate === dateString;
                }) : null;
                
                if (scheduleDay) {
                    // Normalize date to the grid's local date string to avoid timezone shifts
                    currentWeek.push({ ...scheduleDay, date: dateString });
                } else {
                    // Create empty day object
                    currentWeek.push({
                        date: dateString,
                        guide1_name: null,
                        guide2_name: null,
                        is_manual: false,
                        is_locked: false
                    });
                }
                
                // If we've reached the end of a week (Saturday=6), start a new week
                if (date.getDay() === 6) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
            }
            
            // Add remaining days to the last week
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            
            return weeks;
        }
        
            // Consistent weekday helper: interpret date string at local midnight
            function getDayOfWeekLocal(dateStr) {
                const d = new Date(dateStr + 'T00:00:00');
                return d.getDay();
            }

            function addDaysLocal(dateStr, deltaDays) {
                const base = new Date(dateStr + 'T00:00:00');
                base.setDate(base.getDate() + deltaDays);
                const y = base.getFullYear();
                const m = String(base.getMonth() + 1).padStart(2, '0');
                const d = String(base.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            function groupScheduleByWeeks(schedule) {
            const weeks = [];
            let currentWeek = [];
            
            schedule.forEach(day => {
                const dayOfWeek = getDayOfWeekLocal(day.date);
                
                // Start new week on Sunday (0)
                if (dayOfWeek === 0 && currentWeek.length > 0) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                
                currentWeek.push(day);
                
                // End week on Saturday (6)
                if (dayOfWeek === 6) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
            });
            
            // Add remaining days
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            
            return weeks;
        }

        function createDayCell(day) {
            const dayNumber = new Date(day.date).getDate();
            const isManual = day.is_manual;
            const isLocked = day.is_locked;
            const dayOfWeek = getDayOfWeekLocal(day.date);
            const isFriday = dayOfWeek === 5; // Friday is day 5
            const isSaturday = dayOfWeek === 6; // Saturday is day 6
            
            // Check if this is a closed Saturday weekend
            let isClosedSaturdayWeekend = false;
            let fridayConanGuide = null;
            
            if (isSaturday) {
                // Check if the previous Friday is marked as closed Saturday
                // Build friday string using local midnight math to avoid UTC rollovers
                const sat = new Date(day.date + 'T00:00:00');
                sat.setDate(sat.getDate() - 1);
                const fridayString = `${sat.getFullYear()}-${String(sat.getMonth()+1).padStart(2,'0')}-${String(sat.getDate()).padStart(2,'0')}`;
                
                // Check if Friday has closed Saturday setting
                const fridayCheckbox = document.querySelector(`input[data-date="${fridayString}"]`);
                if (fridayCheckbox && fridayCheckbox.checked) {
                    isClosedSaturdayWeekend = true;
                    
                    // Get the conan guide from Friday
                    const fridayDay = window.currentMonthSchedule?.find(d => d.date === fridayString);
                    if (fridayDay && fridayDay.guide1_name && fridayDay.guide1_role === 'כונן') {
                        fridayConanGuide = fridayDay.guide1_name;
                    }
                }
            }
            
            let cellHtml = `<div class="day-number">${dayNumber}</div>`;
            
            // For closed Saturday, show the conan guide from Friday with special styling
            if (isClosedSaturdayWeekend && fridayConanGuide) {
                cellHtml += `
                    <div class="guide-item-display guide-conan-friday guide-${fridayConanGuide.toLowerCase()}">
                        <span class="guide-role-label">כונן שישי/שבת (עד 17:00)</span>
                        <span class="guide-name">${getFirstName(fridayConanGuide)}</span>
                    </div>
                `;
            }
            
            // Show regular assignments (excluding the conan guide if it's already shown)
            // Guard: never show Motzash on Friday cells (should appear on Saturday only)
            const guide1IsMotzashOnFriday = isFriday && day.guide1_role && day.guide1_role.includes('מוצ״ש');
            if (day.guide1_name && (!isClosedSaturdayWeekend || day.guide1_name !== fridayConanGuide) && !guide1IsMotzashOnFriday) {
                let guide1Class = isManual ? 'guide-overlap' : 'guide-regular';
                let guide1Role = day.guide1_role;
                
                // For closed Saturday, show the additional guide if exists
                if (isClosedSaturdayWeekend && day.guide1_name !== fridayConanGuide) {
                    guide1Class = 'guide-overlap';
                    guide1Role = 'מוצ״ש (17:00-19:00) + רגיל (19:00-24:00)';
                }
                
                cellHtml += `
                    <div class="guide-item-display ${guide1Class} guide-${day.guide1_name.toLowerCase()}">
                        <span class="guide-role-label">${guide1Role}</span>
                        <span class="guide-name">${getFirstName(day.guide1_name)}</span>
                    </div>
                `;
            }
            
            const guide2IsMotzashOnFriday = isFriday && day.guide2_role && day.guide2_role.includes('מוצ״ש');
            if (day.guide2_name && !guide2IsMotzashOnFriday) {
                const guide2Class = isManual ? 'guide-overlap' : 'guide-regular';
                cellHtml += `
                    <div class="guide-item-display ${guide2Class} guide-${day.guide2_name.toLowerCase()}">
                        <span class="guide-role-label">${day.guide2_role}</span>
                        <span class="guide-name">${getFirstName(day.guide2_name)}</span>
                    </div>
                `;
            }
            
            cellHtml += `<button class="edit-day-btn" onclick="editDay('${day.date}')" data-date="${day.date}">ערוך</button>`;
            
            // Add visual indicators for manual assignments
            if (isManual) {
                cellHtml += '<div class="manual-indicator">🔒</div>';
            }
            
            // Add weekend type checkbox for Fridays
            if (isFriday) {
                cellHtml += `
                    <div class="weekend-type-control">
                        <label class="weekend-checkbox">
                            <input type="checkbox" onchange="toggleWeekendType('${day.date}', this.checked)" data-date="${day.date}">
                            <span class="checkbox-label">סופ״ש סגור</span>
                        </label>
                    </div>
                `;
            }
            
            return cellHtml;
        }

        function updateSidePanelWithAvailability(availability) {
            // Find the available guides section (second panel-section)
            const availableSection = document.querySelector('.panel-section:nth-child(2)');
            const blockedSection = document.querySelector('.panel-section:nth-child(3)');
            
            if (!availableSection || !blockedSection) {
                console.error('Could not find sections:', { availableSection, blockedSection });
                return;
            }
            
            const availableContainer = availableSection.querySelector('.guides-list');
            const blockedContainer = blockedSection.querySelector('.guides-list');
            
            if (!availableContainer || !blockedContainer) {
                console.error('Could not find containers:', { availableContainer, blockedContainer });
                return;
            }
            
            // Clear existing content
            availableContainer.innerHTML = '';
            blockedContainer.innerHTML = '';
            
            
            // Filter out already selected guides and the locked conan (cannot be re-selected)
            const selectedGuideNames = selectedGuides.map(name => name);
            const filteredAvailability = availability.filter(guide => !selectedGuideNames.includes(guide.guide_name) && (!window.lockedConanId || String(guide.guide_id) !== String(window.lockedConanId)) );
            
            console.log('🚦 Processing availability data - Total guides:', availability.length);
            console.log('🚦 Selected guides to filter out:', selectedGuideNames);
            console.log('🚦 Filtered availability - Remaining guides:', filteredAvailability.length);
            
            // Separate guides by traffic light status
            const recommendedGuides = [];
            const notRecommendedGuides = [];
            const blockedGuides = [];
            
            filteredAvailability.forEach(guide => {
                const trafficLightStatus = calculateTrafficLightStatus(guide);
                
                if (trafficLightStatus === 'green') {
                    recommendedGuides.push(guide);
                } else if (trafficLightStatus === 'yellow') {
                    notRecommendedGuides.push(guide);
                } else {
                    blockedGuides.push(guide);
                }
            });
            
            // Create sections with headers
            if (recommendedGuides.length > 0) {
                const recommendedHeader = document.createElement('div');
                recommendedHeader.className = 'section-header recommended';
                recommendedHeader.innerHTML = '<h5>🟢 מומלץ</h5>';
                availableContainer.appendChild(recommendedHeader);
                
                recommendedGuides.forEach(guide => {
                    const guideElement = createGuideElement(guide);
                    availableContainer.appendChild(guideElement);
                });
            }
            
            if (notRecommendedGuides.length > 0) {
                const notRecommendedHeader = document.createElement('div');
                notRecommendedHeader.className = 'section-header not-recommended';
                notRecommendedHeader.innerHTML = '<h5>🟡 לא מומלץ</h5>';
                availableContainer.appendChild(notRecommendedHeader);
                
                notRecommendedGuides.forEach(guide => {
                    const guideElement = createGuideElement(guide);
                    availableContainer.appendChild(guideElement);
                });
            }
            
            if (blockedGuides.length > 0) {
                
                blockedGuides.forEach(guide => {
                    const guideElement = createGuideElement(guide);
                    blockedContainer.appendChild(guideElement);
                });
            }
            
            console.log('Updated containers:', {
                recommended: recommendedGuides.length,
                notRecommended: notRecommendedGuides.length,
                blocked: blockedGuides.length
            });
        }

        function createGuideElement(guide) {
            const div = document.createElement('div');
            div.className = `guide-item ${guide.status}`;
            
            // Calculate traffic light status
            const trafficLightStatus = calculateTrafficLightStatus(guide);
            const availabilityReasons = getAvailabilityReason(guide);
            
            // Generate constraint tags HTML
            let constraintTagsHtml = '';
            if (availabilityReasons && availabilityReasons.length > 0) {
                constraintTagsHtml = '<div class="constraint-tags">';
                availabilityReasons.forEach(reason => {
                    constraintTagsHtml += `
                        <span class="constraint-tag constraint-${reason.type}">
                            <span class="constraint-icon">${reason.icon}</span>
                            <span class="constraint-text">${reason.text}</span>
                        </span>
                    `;
                });
                constraintTagsHtml += '</div>';
            }
            
            div.innerHTML = `
                <div class="guide-info">
                    <span class="guide-name">${guide.guide_name}</span>
                    <span class="guide-role">${guide.guide_role}</span>
                    <div class="traffic-light">
                        <div class="traffic-light-indicator traffic-light-${trafficLightStatus}"></div>
                        <span>${getTrafficLightText(trafficLightStatus)}</span>
                    </div>
                    ${constraintTagsHtml}
                </div>
                <div class="guide-status">
                    <span class="status-indicator status-${guide.status}"></span>
                    ${getStatusText(guide)}
                </div>
                ${guide.status === 'blocked' ? `
                    <div class="override-toggle">
                        <input type="checkbox" id="override-${guide.guide_id}" onchange="toggleOverride(${guide.guide_id})">
                        <label for="override-${guide.guide_id}">אפשר עקיפה</label>
                    </div>
                ` : ''}
            `;
            
            // Add click handler based on status
            if (guide.status === 'available') {
                div.onclick = () => selectGuide(div);
            } else if (guide.status === 'blocked') {
                div.onclick = () => selectGuideOverride(div);
            }
            
            return div;
        }

        function calculateTrafficLightStatus(guide) {
            // Check if guide is blocked (has constraints)
            if (guide.status === 'blocked') {
                return 'red'; // חסום - לא זמין לשיבוץ
            }
            
            // For available guides, check workload
            if (guide.total_shifts > 12) {
                return 'red'; // חסום - עומס גבוה מדי
            }
            if (guide.total_shifts > 8) {
                return 'yellow'; // לא מומלץ - עומס בינוני
            }
            
            // Check weekly scheduling rules
            const weeklyStatus = checkWeeklySchedulingRules(guide);
            if (weeklyStatus === 'red') {
                return 'red'; // חסום - חוקי שיבוץ שבועיים
            }
            if (weeklyStatus === 'yellow') {
                return 'yellow'; // לא מומלץ - חוקי שיבוץ שבועיים
            }
            
            return 'green'; // מומלץ - זמין ועומס נמוך
        }
        
        function checkWeeklySchedulingRules(guide) {
            // Check if guide worked recently (within 2 days)
            const recentWorkStatus = checkRecentWork(guide);
            if (recentWorkStatus === 'red') {
                return 'red'; // חסום - עבד לאחרונה
            }
            if (recentWorkStatus === 'yellow') {
                return 'yellow'; // לא מומלץ - עבד לפני יומיים
            }
            
            return 'green'; // מומלץ - לא עבד לאחרונה
        }
        
        function checkRecentWork(guide) {
            if (!currentDate) return 'green';
            
            const currentDateObj = new Date(currentDate);
            const guideId = guide.guide_id;
            
            // Check if guide worked yesterday (day -1)
            const yesterday = new Date(currentDateObj);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            // Check if guide worked day before yesterday (day -2)
            const dayBeforeYesterday = new Date(currentDateObj);
            dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
            const dayBeforeYesterdayStr = dayBeforeYesterday.toISOString().split('T')[0];
            
            // Check if guide worked tomorrow (day +1)
            const tomorrow = new Date(currentDateObj);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Check if guide worked day after tomorrow (day +2)
            const dayAfterTomorrow = new Date(currentDateObj);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            const dayAfterTomorrowStr = dayAfterTomorrow.toISOString().split('T')[0];
            
            // Check current month schedule for these dates
            const [year, month] = currentMonth.split('-');
            const monthSchedule = getCurrentMonthSchedule();
            
            if (!monthSchedule) return 'green';
            
            // Check if guide worked yesterday or tomorrow (red - too close)
            const workedYesterday = monthSchedule.some(day => 
                day.date === yesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedTomorrow = monthSchedule.some(day => 
                day.date === tomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedYesterday || workedTomorrow) {
                return 'red'; // חסום - עבד אתמול או עובד מחר
            }
            
            // Check if guide worked day before yesterday or day after tomorrow (yellow - 2 days gap)
            const workedDayBeforeYesterday = monthSchedule.some(day => 
                day.date === dayBeforeYesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedDayAfterTomorrow = monthSchedule.some(day => 
                day.date === dayAfterTomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedDayBeforeYesterday || workedDayAfterTomorrow) {
                return 'yellow'; // לא מומלץ - עבד לפני יומיים או עובד בעוד יומיים
            }
            
            return 'green'; // מומלץ - הפרש של לפחות 3 ימים
        }
        
        function getCurrentMonthSchedule() {
            // This should return the current month's schedule data
            // For now, we'll use a simple approach - in a real implementation,
            // this would be cached or fetched from the current month data
            return window.currentMonthSchedule || [];
        }
        
        function getTrafficLightText(status) {
            switch(status) {
                case 'green': return 'מומלץ';
                case 'yellow': return 'לא מומלץ';
                case 'red': return 'חסום';
                default: return 'לא ידוע';
            }
        }
        
        function getAvailabilityReason(guide) {
            if (guide.status === 'blocked') {
                const reasons = [];
                
                // Check for vacation
                if (guide.vacation_id) {
                    reasons.push({
                        type: 'vacation',
                        text: 'חופשה',
                        icon: '🏖️'
                    });
                }
                
                // Check for personal constraint (one-time)
                if (guide.constraint_id) {
                    reasons.push({
                        type: 'constraint',
                        text: 'חד פעמי',
                        icon: '🚫'
                    });
                }
                
                // Check for fixed constraint (recurring)
                if (guide.fixed_constraint_id) {
                    reasons.push({
                        type: 'fixed_constraint',
                        text: 'קבוע',
                        icon: '📅'
                    });
                }
                
                // Check for consecutive days
                if (guide.consecutive_prev_id) {
                    reasons.push({
                        type: 'consecutive',
                        text: 'צמידות',
                        icon: '🔄'
                    });
                }
                
                if (guide.consecutive_next_id) {
                    reasons.push({
                        type: 'consecutive',
                        text: 'צמידות',
                        icon: '🔄'
                    });
                }
                
                // Check for coordinator rules
                            if (guide.coordinator_rule_no_auto_id) {
                reasons.push({
                    type: 'info',
                    text: 'לא באוטומטי',
                    icon: '🤖'
                });
            }
                
                if (guide.coordinator_rule_no_conan_id) {
                    reasons.push({
                        type: 'coordinator_rule',
                        text: 'לא ככונן',
                        icon: '🚫'
                    });
                }
                
                // If no specific constraint type, show generic blocked
                if (reasons.length === 0) {
                    reasons.push({
                        type: 'blocked',
                        text: 'חסום',
                        icon: '🚫'
                    });
                }
                
                return reasons;
            }
            
            // For available guides, check weekly rules first
            const weeklyReasons = getWeeklyRuleReasons(guide);
            if (weeklyReasons && weeklyReasons.length > 0) {
                return weeklyReasons;
            }
            
            // Show workload warnings if no weekly rules
            if (guide.total_shifts > 12) {
                return [{
                    type: 'workload_high',
                    text: `עומס גבוה: ${guide.total_shifts} משמרות החודש`,
                    icon: '⚠️'
                }];
            }
            if (guide.total_shifts > 8) {
                return [{
                    type: 'workload_medium',
                    text: `עומס בינוני: ${guide.total_shifts} משמרות החודש`,
                    icon: '⚖️'
                }];
            }
            
            return null;
        }
        
        function getWeeklyRuleReasons(guide) {
            if (!currentDate) return null;
            
            const currentDateObj = new Date(currentDate);
            const guideId = guide.guide_id;
            const monthSchedule = getCurrentMonthSchedule();
            
            if (!monthSchedule) return null;
            
            const reasons = [];
            
            // Check if guide worked yesterday or tomorrow (red - too close)
            const yesterday = new Date(currentDateObj);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const tomorrow = new Date(currentDateObj);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const workedYesterday = monthSchedule.some(day => 
                day.date === yesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedTomorrow = monthSchedule.some(day => 
                day.date === tomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedYesterday) {
                reasons.push({
                    type: 'weekly_rule',
                    text: 'עבד אתמול',
                    icon: '🔄'
                });
            }
            
            if (workedTomorrow) {
                reasons.push({
                    type: 'weekly_rule',
                    text: 'עובד מחר',
                    icon: '🔄'
                });
            }
            
            // Check if guide worked day before yesterday or day after tomorrow (yellow - 2 days gap)
            const dayBeforeYesterday = new Date(currentDateObj);
            dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
            const dayBeforeYesterdayStr = dayBeforeYesterday.toISOString().split('T')[0];
            
            const dayAfterTomorrow = new Date(currentDateObj);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            const dayAfterTomorrowStr = dayAfterTomorrow.toISOString().split('T')[0];
            
            const workedDayBeforeYesterday = monthSchedule.some(day => 
                day.date === dayBeforeYesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedDayAfterTomorrow = monthSchedule.some(day => 
                day.date === dayAfterTomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedDayBeforeYesterday) {
                reasons.push({
                    type: 'weekly_rule',
                    text: 'עבד לפני יומיים',
                    icon: '⚠️'
                });
            }
            
            if (workedDayAfterTomorrow) {
                reasons.push({
                    type: 'weekly_rule',
                    text: 'עובד בעוד יומיים',
                    icon: '⚠️'
                });
            }
            
            return reasons.length > 0 ? reasons : null;
        }
        
        function getStatusText(guide) {
            switch (guide.status) {
                case 'available':
                    return 'זמין';
                case 'blocked':
                    return guide.reason || 'חסום';
                case 'warning':
                    return guide.reason || 'אזהרה';
                default:
                    return 'לא ידוע';
            }
        }
        
        function toggleOverride(guideId) {
            const checkbox = document.getElementById(`override-${guideId}`);
            const guideElement = checkbox.closest('.guide-item');
            
            if (checkbox.checked) {
                guideElement.classList.remove('blocked');
                guideElement.classList.add('blocked-override');
                guideElement.onclick = () => selectGuide(guideElement);
            } else {
                guideElement.classList.remove('blocked-override');
                guideElement.classList.add('blocked');
                guideElement.onclick = null;
            }
            
            console.log(`Override ${checkbox.checked ? 'enabled' : 'disabled'} for guide ${guideId}`);
        }

        // =====================================================
        // EVENT HANDLERS
        // =====================================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Sigalit Scheduler...');
            
            // Load initial data
            await Promise.all([
                fetchGuides(),
                fetchAssignmentTypes(),
                fetchShiftTypes()
            ]);
            
            // Load current month schedule
            const [year, month] = currentMonth.split('-');
            await loadMonthSchedule(year, month);
            
            // Set up event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Month selector
            document.getElementById('month-select').addEventListener('change', async function() {
                currentMonth = this.value;
                const [year, month] = currentMonth.split('-');
                await loadMonthSchedule(year, month);
            });

            // Toolbar buttons
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', handleToolbarButton);
            });

            // Side panel close
            document.getElementById('side-panel-close').addEventListener('click', closeSidePanel);
            document.getElementById('side-panel-overlay').addEventListener('click', closeSidePanel);

            // Override toggle
            document.getElementById('manual-override').addEventListener('change', function() {
                toggleOverrideMode(this.checked);
            });
        }

        async function loadMonthSchedule(year, month) {
            try {
                showNotification('טוען לוח שנה...', 'info');
                const schedule = await fetchMonthlySchedule(year, month);
                if (schedule) {
                    updateCalendarWithSchedule(schedule);
                    // Load weekend types after calendar is updated
                    await loadWeekendTypes(year, month);
                    showNotification('לוח השנה נטען בהצלחה', 'success');
                }
            } catch (error) {
                console.error('Error loading month schedule:', error);
                showNotification('שגיאה בטעינת לוח השנה', 'error');
            }
            
            // ADD THIS LINE AT THE END:
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            await loadWorkflowStatus(monthStr);
        }

        function handleToolbarButton(event) {
            const buttonText = event.target.textContent.trim();
            
            switch (buttonText) {
                case 'שבץ אוטומטית':
                    runAutoScheduling();
                    break;
                case 'שמור':
                    saveCurrentDraft();
                    break;
                case 'טען':
                    loadDraft();
                    break;
                case 'מחק':
                    deleteDraft();
                    break;
                case 'נקה הכל':
                    console.log('נקה הכל button clicked!');
                    clearAllAssignments();
                    break;
                case 'ייצא לאקסל':
                    exportToExcel();
                    break;
                default:
                    console.log('Button clicked:', buttonText);
            }
        }

        function editDay(date) {
            console.log('editDay called with date:', date);
            currentDate = date;
            loadDayAvailability(date);
            loadCurrentAssignments(date);
            openSidePanel();
        }

        async function loadDayAvailability(date) {
            try {
                console.log('Loading availability for date:', date);
                const availability = await fetchGuideAvailability(date);
                console.log('Received availability data:', availability);
                
                // Load current month schedule for weekly rules
                const [year, month] = currentMonth.split('-');
                const monthSchedule = await fetchMonthlySchedule(year, month);
                window.currentMonthSchedule = monthSchedule; // Cache for weekly rules
                
                if (availability) {
                    updateSidePanelWithAvailability(availability);
                    updateSidePanelDate(date);
                }
            } catch (error) {
                console.error('Error loading day availability:', error);
                showNotification('שגיאה בטעינת זמינות', 'error');
            }
        }
        
        async function loadCurrentAssignments(date) {
            try {
                const schedule = await fetchMonthlySchedule(new Date(date).getFullYear(), String(new Date(date).getMonth() + 1).padStart(2, '0'));
                const dayAssignment = schedule.find(day => day.date === date);
                
                if (dayAssignment) {
                    updateSelectedGuidesDisplay(dayAssignment);
                } else {
                    clearSelectedGuidesDisplay();
                }
            } catch (error) {
                console.error('Error loading current assignments:', error);
            }
        }
        
        function updateSelectedGuidesDisplay(assignment) {
            const container = document.querySelector('.selected-guides-container');
            container.innerHTML = '';
            
            // Clear and repopulate selectedGuides array with current assignments
            selectedGuides = [];
            
            // Reset locked conan by default
            window.lockedConanId = null;
  // If editing a Saturday and Friday has a standby (כונן), show it as a locked, non-editable chip
  try {
    const isSaturday = new Date(assignment.date).getDay() === 6;
    if (isSaturday && Array.isArray(window.currentMonthSchedule)) {
      const friday = new Date(assignment.date);
      friday.setDate(friday.getDate() - 1);
      const fridayStr = friday.toISOString().split('T')[0];
      const fri = window.currentMonthSchedule.find(d => d.date === fridayStr);
      const fridayConan = fri && (fri.guide1_role === 'כונן' ? { id: fri.guide1_id, name: fri.guide1_name } : (fri.guide2_role === 'כונן' ? { id: fri.guide2_id, name: fri.guide2_name } : null));
      if (fridayConan && fridayConan.id) {
        window.lockedConanId = fridayConan.id;
        // Add locked Friday conan to selectedGuides array
        selectedGuides.push(fridayConan.name);
        
        
        container.innerHTML += `
          <div class="selected-guide-item">
            <div class="guide-info">
              <span class="guide-name">${fridayConan.name}</span>
              <span class="guide-role">כונן</span>
              <span class="manual-badge">🔒 נעול משישי</span>
            </div>
          </div>
        `;
      }
    }
  } catch (e) { console.warn('locked conan render failed:', e.message); }
            
            if (assignment.guide1_name) {
                // Only add if not already in selectedGuides (avoid duplicates with locked conan)
                if (!selectedGuides.includes(assignment.guide1_name)) {
                    selectedGuides.push(assignment.guide1_name);
                    
                    container.innerHTML += `
                        <div class="selected-guide-item">
                            <div class="guide-info">
                                <span class="guide-name">${assignment.guide1_name}</span>
                                <span class="guide-role">${assignment.guide1_role}</span>
                                ${assignment.is_manual ? '<span class="manual-badge">🔒 ידני</span>' : '<span class="auto-badge">🤖 אוטומטי</span>'}
                            </div>
            ${ (window.lockedConanId && String(assignment.guide1_id) === String(window.lockedConanId)) ? '' : `<button class="remove-guide-btn" onclick="removeGuide('${assignment.guide1_id}')">×</button>` }
                        </div>
                    `;
                }
            }
            
            if (assignment.guide2_name) {
                // Only add if not already in selectedGuides (avoid duplicates with locked conan)
                if (!selectedGuides.includes(assignment.guide2_name)) {
                    selectedGuides.push(assignment.guide2_name);
                    
                    container.innerHTML += `
                        <div class="selected-guide-item">
                            <div class="guide-info">
                                <span class="guide-name">${assignment.guide2_name}</span>
                                <span class="guide-role">${assignment.guide2_role}</span>
                                ${assignment.is_manual ? '<span class="manual-badge">🔒 ידני</span>' : '<span class="auto-badge">🤖 אוטומטי</span>'}
                            </div>
            ${ (window.lockedConanId && String(assignment.guide2_id) === String(window.lockedConanId)) ? '' : `<button class=\"remove-guide-btn\" onclick=\"removeGuide('${assignment.guide2_id}')\">×</button>` }
                        </div>
                    `;
                }
            }
            
            updateAssignmentStatus();
            
            // Debug log to verify selectedGuides array is populated
            console.log('📋 selectedGuides array updated:', selectedGuides);
        }
        
        function updateSelectedGuidesFromArray() {
            const container = document.querySelector('.selected-guides-container');
            container.innerHTML = '';
            
            if (selectedGuides.length === 0) {
                container.innerHTML = '<div class="no-assignments">אין שיבוצים ליום זה</div>';
            } else {
                selectedGuides.forEach((guideName, index) => {
                    container.innerHTML += `
                        <div class="selected-guide-item">
                            <div class="guide-info">
                                <span class="guide-name">${guideName}</span>
                                <span class="guide-role">מדריך</span>
                                <span class="manual-badge">🔒 ידני</span>
                            </div>
                            <button class="remove-guide-btn" onclick="removeGuideByName('${guideName}')">×</button>
                        </div>
                    `;
                });
            }
            
            updateAssignmentStatus();
        }
        
        function clearSelectedGuidesDisplay() {
            const container = document.querySelector('.selected-guides-container');
            container.innerHTML = '<div class="no-assignments">אין שיבוצים ליום זה</div>';
            updateAssignmentStatus();
        }
        
        function updateAssignmentStatus() {
            const container = document.querySelector('.selected-guides-container');
            const count = container.querySelectorAll('.selected-guide-item').length;
            const statusElement = document.querySelector('.assignment-status');
            
            if (count === 0) {
                statusElement.innerHTML = '<span class="status-badge status-empty">אין שיבוצים</span>';
            } else if (count === 1) {
                statusElement.innerHTML = '<span class="status-badge status-partial">שיבוץ חלקי (1/2)</span>';
            } else {
                statusElement.innerHTML = '<span class="status-badge status-complete">שיבוץ מלא (2/2)</span>';
            }
        }

        function updateSidePanelDate(date) {
            const dateElement = document.querySelector('.side-panel-date');
            if (dateElement) {
                const hebrewDate = new Date(date).toLocaleDateString('he-IL');
                dateElement.textContent = hebrewDate;
            }
        }

        // =====================================================
        // SIDE PANEL FUNCTIONS
        // =====================================================

        function openSidePanel() {
            document.getElementById('side-panel-overlay').style.display = 'block';
            document.getElementById('side-panel').classList.add('open');
            document.body.style.overflow = 'hidden';
            sidePanelOpen = true;
        }

        function closeSidePanel() {
            document.getElementById('side-panel').classList.remove('open');
            setTimeout(() => {
                document.getElementById('side-panel-overlay').style.display = 'none';
                document.body.style.overflow = 'auto';
            }, 300);
            sidePanelOpen = false;
            selectedGuides = [];
        }

        function selectGuide(element) {
            element.classList.toggle('selected');
            const guideName = element.querySelector('.guide-name').textContent;
            
            if (element.classList.contains('selected')) {
                selectedGuides.push(guideName);
            } else {
                selectedGuides = selectedGuides.filter(name => name !== guideName);
            }
            
            console.log('Selected guides:', selectedGuides);
            
            // Update the selected guides display
            updateSelectedGuidesFromArray();
            
            // Refresh availability list to hide/show selected guides
            if (currentDate) {
                loadDayAvailability(currentDate);
            }
        }

        function selectGuideOverride(element) {
            const overrideEnabled = document.getElementById('manual-override').checked;
            if (overrideEnabled) {
                element.classList.toggle('selected');
                const guideName = element.querySelector('.guide-name').textContent;
                
                if (element.classList.contains('selected')) {
                    selectedGuides.push(guideName);
                } else {
                    selectedGuides = selectedGuides.filter(name => name !== guideName);
                }
                
                console.log('Guide selected with override:', guideName);
                
                // Update the selected guides display
                updateSelectedGuidesFromArray();
                
                // Refresh availability list to hide/show selected guides
                if (currentDate) {
                    loadDayAvailability(currentDate);
                }
            } else {
                showNotification('יש להפעיל Manual Override כדי לשבץ מדריך חסום', 'warning');
            }
        }

        function toggleOverrideMode(enabled) {
            const blockedOverrideItems = document.querySelectorAll('.guide-item.blocked-override');
            blockedOverrideItems.forEach(item => {
                if (enabled) {
                    item.style.cursor = 'pointer';
                    item.style.opacity = '1';
                } else {
                    item.style.cursor = 'not-allowed';
                    item.style.opacity = '0.7';
                    item.classList.remove('selected');
                }
            });
        }

        async function saveChanges() {
            if (!currentDate) {
                showNotification('אין תאריך נבחר', 'warning');
                return;
            }

            try {
                let guide1 = null;
                let guide2 = null;
                let assignmentType = 'רגיל';
                
                // Check day type and determine assignment rules
                const dayOfWeek = new Date(currentDate).getDay();
                const isSaturday = dayOfWeek === 6;
                const isFriday = dayOfWeek === 5;
                const isSunday = dayOfWeek === 0;
                
                if (isSaturday) {
                    // Check if this is a closed Saturday
                    const fridayDate = new Date(currentDate);
                    fridayDate.setDate(fridayDate.getDate() - 1);
                    const fridayString = fridayDate.toISOString().split('T')[0];
                    
                    try {
                        const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                        const result = await response.json();
                        
                        if (result.is_closed === 1) {
                            // Closed Saturday - can have 1 additional guide (מוצ״ש) in addition to the conan from Friday
                            if (selectedGuides.length === 0) {
                                showNotification('סופ״ש סגור דורש לפחות מדריך נוסף אחד (מוצ״ש)', 'warning');
                                return;
                            }
                            if (selectedGuides.length > 1) {
                                showNotification('סופ״ש סגור יכול לקבל מדריך נוסף אחד בלבד (מוצ״ש)', 'warning');
                                return;
                            }
                            assignmentType = 'מוצ״ש';
                        } else {
                            // Open Saturday - can have 1 or 2 guides (auto will complete)
                            if (selectedGuides.length > 2) {
                                showNotification('לא ניתן לשבץ יותר מ-2 מדריכים בשבת', 'warning');
                                return;
                            }
                            if (selectedGuides.length === 2) {
                                assignmentType = 'חפיפה';
                            } else {
                                assignmentType = 'רגיל';
                            }
                        }
                    } catch (error) {
                        console.error('Error checking weekend type:', error);
                        // Default to open Saturday if we can't check
                        if (selectedGuides.length > 2) {
                            showNotification('לא ניתן לשבץ יותר מ-2 מדריכים בשבת', 'warning');
                            return;
                        }
                        if (selectedGuides.length === 2) {
                            assignmentType = 'חפיפה';
                        } else {
                            assignmentType = 'רגיל';
                        }
                    }
                } else if (isFriday) {
                    // Check if this Friday is for a closed Saturday
                    try {
                        const response = await fetch(`${API_BASE}/weekend-type/${currentDate}`);
                        const result = await response.json();
                        
                        if (result.is_closed === 1) {
                            // Closed Saturday Friday - requires exactly 1 guide (כונן)
                            if (selectedGuides.length !== 1) {
                                showNotification('שישי לסופ״ש סגור דורש כונן אחד בלבד', 'warning');
                                return;
                            }
                            assignmentType = 'כונן';
                        } else {
                            // Regular Friday - can have 1 or 2 guides (auto will complete)
                            if (selectedGuides.length > 2) {
                                showNotification('לא ניתן לשבץ יותר מ-2 מדריכים ביום חול', 'warning');
                                return;
                            }
                            if (selectedGuides.length === 2) {
                                assignmentType = 'חפיפה';
                            } else {
                                assignmentType = 'רגיל';
                            }
                        }
                    } catch (error) {
                        console.error('Error checking weekend type:', error);
                        // Default to regular Friday
                        if (selectedGuides.length > 2) {
                            showNotification('לא ניתן לשבץ יותר מ-2 מדריכים ביום חול', 'warning');
                            return;
                        }
                        if (selectedGuides.length === 2) {
                            assignmentType = 'חפיפה';
                        } else {
                            assignmentType = 'רגיל';
                        }
                    }
                } else {
                    // Regular weekday (Sunday-Thursday) - can have 1 or 2 guides (auto will complete)
                    if (selectedGuides.length > 2) {
                        showNotification('לא ניתן לשבץ יותר מ-2 מדריכים ביום חול', 'warning');
                        return;
                    }
                    if (selectedGuides.length === 2) {
                        assignmentType = 'חפיפה';
                    } else {
                        assignmentType = 'רגיל';
                    }
                }
                
                if (selectedGuides.length > 0) {
                    console.log('Selected guides:', selectedGuides);
                    console.log('Available guides data:', guidesData.map(g => ({ id: g.id, name: g.name })));
                    
                    guide1 = guidesData.find(g => g.name === selectedGuides[0]);
                    guide2 = selectedGuides[1] ? guidesData.find(g => g.name === selectedGuides[1]) : null;
                    
                    console.log('Found guide1:', guide1);
                    console.log('Found guide2:', guide2);
                }
                
                const success = await saveManualAssignment(
                    currentDate,
                    guide1?.id,
                    guide2?.id,
                    assignmentType
                );
                
                if (success) {
                    console.log('Manual assignment saved successfully');
                    console.log('isFriday:', isFriday, 'assignmentType:', assignmentType, 'guide1?.id:', guide1?.id);
                    
                    // If this is a Friday with closed Saturday and we assigned a conan,
                    // automatically assign the same guide to Saturday as well
                    if (isFriday && assignmentType === 'כונן' && guide1?.id) {
                        console.log('Attempting to auto-assign conan to Saturday...');
                        try {
                            const response = await fetch(`${API_BASE}/weekend-type/${currentDate}`);
                            const result = await response.json();
                            console.log('Weekend type check result:', result);
                            
                            if (result.is_closed === 1) {
                                console.log('This is a closed Saturday Friday, auto-assigning conan to Saturday');
                                // This is a closed Saturday Friday, automatically assign the conan to Saturday
                                const saturdayString = addDaysLocal(currentDate, 1);
                                console.log('Saturday date:', saturdayString);
                                
                                // For closed Saturday, we only register the conan guide from Friday
                                // The conan guide will be available for Saturday until 17:00
                                // Additional guide for Saturday will be assigned separately
                                
                                // Save Saturday assignment with only the conan guide (no second guide yet)
                                console.log('Saving conan to Saturday:', saturdayString, guide1.id, 'כונן');
                                const saturdayResponse = await saveManualAssignment(saturdayString, guide1.id, null, 'כונן');
                                console.log('Saturday assignment response:', saturdayResponse);
                                
                                if (saturdayResponse) {
                                    showNotification('השינויים נשמרו בהצלחה - הכונן נרשם אוטומטית לשבת עד 17:00', 'success');
                                } else {
                                    showNotification('השינויים נשמרו בהצלחה, אך הייתה שגיאה ברישום הכונן לשבת', 'warning');
                                }
                            } else {
                                console.log('This is not a closed Saturday Friday');
                                const guideCount = selectedGuides.length;
                                const message = guideCount === 1 
                                    ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                    : 'השינויים נשמרו בהצלחה';
                                showNotification(message, 'success');
                            }
                        } catch (error) {
                            console.error('Error auto-assigning conan to Saturday:', error);
                            const guideCount = selectedGuides.length;
                            const message = guideCount === 1 
                                ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                : 'השינויים נשמרו בהצלחה';
                            showNotification(message, 'success');
                        }
                    } else if (isSaturday && selectedGuides.length === 0) {
                        // If we're clearing Saturday assignments, check if we need to remove conan from Friday too
                        console.log('Clearing Saturday assignments, checking if conan needs to be removed from Friday');
                        try {
                            const fridayString = addDaysLocal(currentDate, -1);
                            
                            const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                            const result = await response.json();
                            
                            if (result.is_closed === 1) {
                                // This is a closed Saturday, check if Friday has a conan
                                const fridaySchedule = window.currentMonthSchedule?.find(d => d.date === fridayString);
                                if (fridaySchedule && fridaySchedule.guide1_role === 'כונן') {
                                    console.log('Removing conan from Friday as well');
                                    await removeConanFromWeekend(fridayString, fridaySchedule.guide1_id);
                                    showNotification('הכונן הוסר גם מהשישי וגם מהשבת', 'success');
                                } else {
                                    const guideCount = selectedGuides.length;
                                    const message = guideCount === 1 
                                        ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                        : 'השינויים נשמרו בהצלחה';
                                    showNotification(message, 'success');
                                }
                            } else {
                                const guideCount = selectedGuides.length;
                                const message = guideCount === 1 
                                    ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                    : 'השינויים נשמרו בהצלחה';
                                showNotification(message, 'success');
                            }
                        } catch (error) {
                            console.error('Error checking Friday conan removal:', error);
                            const guideCount = selectedGuides.length;
                            const message = guideCount === 1 
                                ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                : 'השינויים נשמרו בהצלחה';
                            showNotification(message, 'success');
                        }
                    } else if (isSaturday && assignmentType === 'מוצ״ש' && guide1?.id) {
                        // If we're adding a מוצ״ש guide to Saturday, make sure the conan from Friday is preserved
                        console.log('Adding מוצ״ש guide to Saturday, ensuring conan from Friday is preserved');
                        try {
                            const fridayString = addDaysLocal(currentDate, -1);
                            
                            const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                            const result = await response.json();
                            
                            if (result.is_closed === 1) {
                                // This is a closed Saturday, check if Friday has a conan
                                const fridaySchedule = window.currentMonthSchedule?.find(d => d.date === fridayString);
                                if (fridaySchedule && fridaySchedule.guide1_role === 'כונן') {
                                    console.log('Conan from Friday is preserved, adding מוצ״ש guide');
                                    showNotification('הכונן נשמר מהשישי, מדריך מוצ״ש נוסף בהצלחה', 'success');
                                } else {
                                    console.log('No conan found on Friday, this might be an error');
                                    showNotification('השינויים נשמרו בהצלחה', 'success');
                                }
                            } else {
                                showNotification('השינויים נשמרו בהצלחה', 'success');
                            }
                        } catch (error) {
                            console.error('Error checking Friday conan preservation:', error);
                            showNotification('השינויים נשמרו בהצלחה', 'success');
                        }
                    } else if (isSaturday && selectedGuides.length === 0) {
                        // If we're clearing Saturday assignments, check if we need to remove conan from Friday too
                        console.log('Clearing Saturday assignments, checking if conan needs to be removed from Friday');
                        try {
                            const fridayString = addDaysLocal(currentDate, -1);
                            
                            const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                            const result = await response.json();
                            
                            if (result.is_closed === 1) {
                                // This is a closed Saturday, check if Friday has a conan
                                const fridaySchedule = window.currentMonthSchedule?.find(d => d.date === fridayString);
                                if (fridaySchedule && fridaySchedule.guide1_role === 'כונן') {
                                    console.log('Removing conan from Friday as well');
                                    await removeConanFromWeekend(fridayString, fridaySchedule.guide1_id);
                                    showNotification('הכונן הוסר גם מהשישי וגם מהשבת', 'success');
                                } else {
                                    const guideCount = selectedGuides.length;
                                    const message = guideCount === 1 
                                        ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                        : 'השינויים נשמרו בהצלחה';
                                    showNotification(message, 'success');
                                }
                            } else {
                                const guideCount = selectedGuides.length;
                                const message = guideCount === 1 
                                    ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                    : 'השינויים נשמרו בהצלחה';
                                showNotification(message, 'success');
                            }
                        } catch (error) {
                            console.error('Error checking Friday conan removal:', error);
                            const guideCount = selectedGuides.length;
                            const message = guideCount === 1 
                                ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                                : 'השינויים נשמרו בהצלחה';
                            showNotification(message, 'success');
                        }
                    } else {
                        console.log('Not a Friday conan assignment or missing conditions');
                        const guideCount = selectedGuides.length;
                        const message = guideCount === 1 
                            ? 'השינויים נשמרו בהצלחה - השיבוץ האוטומטי ישלים את היום'
                            : 'השינויים נשמרו בהצלחה';
                        showNotification(message, 'success');
                    }
                    
                    closeSidePanel();
                    // Reload the month schedule to show changes
                    const [year, month] = currentMonth.split('-');
                    await loadMonthSchedule(year, month);
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                showNotification('שגיאה בשמירת השינויים', 'error');
            }
        }
        
        function removeGuide(guideId) {
            const container = document.querySelector('.selected-guides-container');
            const guideItem = container.querySelector(`[onclick*="${guideId}"]`).closest('.selected-guide-item');
            if (guideItem) {
                const guideName = guideItem.querySelector('.guide-name').textContent;
                guideItem.remove();
                
                // Remove from selectedGuides array
                selectedGuides = selectedGuides.filter(name => name !== guideName);
                
                updateAssignmentStatus();
                
                // Refresh availability list to show the removed guide again
                if (currentDate) {
                    loadDayAvailability(currentDate);
                }
            }
        }
        
        function removeGuideByName(guideName) {
            // Remove from selectedGuides array
            selectedGuides = selectedGuides.filter(name => name !== guideName);
            
            // Update the display
            updateSelectedGuidesFromArray();
            
            // Refresh availability list to show the removed guide again
            if (currentDate) {
                loadDayAvailability(currentDate);
            }
        }
        
        // Function to remove conan guide from both Friday and Saturday
        async function removeConanFromWeekend(fridayDate, guideId) {
            try {
                console.log('Removing conan guide from weekend:', fridayDate, guideId);
                
                // Remove from Friday
                await saveManualAssignment(fridayDate, null, null, null);
                
                // Remove from Saturday
                const saturdayString = addDaysLocal(fridayDate, 1);
                await saveManualAssignment(saturdayString, null, null, null);
                
                console.log('Conan guide removed from both Friday and Saturday');
                
                // Reload the month schedule to show changes
                const [year, month] = currentMonth.split('-');
                await loadMonthSchedule(year, month);
                
            } catch (error) {
                console.error('Error removing conan from weekend:', error);
                showNotification('שגיאה בהסרת הכונן מסוף השבוע', 'error');
            }
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Calculate position based on existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            const topOffset = 20 + (existingNotifications.length * 70); // 70px spacing between notifications
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: ${topOffset}px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            // Set background color based on type
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#10b981';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#ef4444';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#f59e0b';
                    break;
                default:
                    notification.style.backgroundColor = '#3b82f6';
            }
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Weekend type management
        async function toggleWeekendType(date, isClosed) {
            try {
                const response = await fetch(`${API_BASE}/weekend-type/${date}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_closed: isClosed })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification(isClosed ? 'סופ״ש סגור נקבע' : 'סופ״ש פתוח נקבע', 'success');
                    // Reload the month to update availability
                    const [year, month] = currentMonth.split('-');
                    await loadMonthSchedule(year, month);
                } else {
                    showNotification('שגיאה בקביעת סוג השבת', 'error');
                }
            } catch (error) {
                console.error('Error toggling weekend type:', error);
                showNotification('שגיאה בקביעת סוג השבת', 'error');
            }
        }

        // Load weekend types for the month
        async function loadWeekendTypes(year, month) {
            try {
                const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                const endDate = `${year}-${String(month).padStart(2, '0')}-31`;
                
                // Load weekend types for all Fridays in the month
                const fridays = getFridaysInMonth(year, month);
                for (const friday of fridays) {
                    const response = await fetch(`${API_BASE}/weekend-type/${friday}`);
                    const result = await response.json();
                    
                    // Update checkbox state
                    const checkbox = document.querySelector(`input[data-date="${friday}"]`);
                    if (checkbox) {
                        checkbox.checked = result.is_closed === 1;
                    }
                }
            } catch (error) {
                console.error('Error loading weekend types:', error);
            }
        }

        function getFridaysInMonth(year, month) {
            const fridays = [];
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month - 1, day);
                if (date.getDay() === 5) { // Friday
                    fridays.push(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }
            
            return fridays;
        }

        // Toolbar action handler
        function handleToolbarAction(action) {
            console.log('Toolbar action:', action);
            switch (action) {
                case 'נקה הכל':
                    console.log('נקה הכל button clicked!');
                    clearAllAssignments();
                    break;
                // Auto-scheduling case removed - manual scheduling only
                case 'סטטיסטיקות':
                    console.log('סטטיסטיקות button clicked!');
                    showSchedulingStatistics();
                    break;
                case 'חוקי שיבוץ':
                    console.log('חוקי שיבוץ button clicked!');
                    showCoordinatorRules();
                    break;
                case 'ייצא לאקסל':
                    console.log('ייצא לאקסל button clicked!');
                    exportToExcel();
                    break;
                default:
                    console.log('Unknown toolbar action:', action);
            }
        }

        // Navigate to AI scheduler with current month/year parameters
        function openAIScheduler() {
            const [year, month] = currentMonth.split('-');
            window.location.href = `ai_scheduler.html?year=${year}&month=${month}`;
        }

        // Backend-owned auto-scheduling trigger
        async function runAutoScheduling() {
            try {
                showNotification('מתחיל שיבוץ אוטומטי...', 'info');
                
                const [year, month] = currentMonth.split('-');
                console.log('Running auto-scheduling for:', { year, month });
                // Call advanced scheduler with state-of-the-art algorithm
                const response = await fetch(`${API_BASE}/schedule/auto-advanced/${year}/${month}?overwrite=true`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const fairnessMsg = result.fairness_score ? ` | ציון הוגנות: ${result.fairness_score}` : '';
                    showNotification(`שיבוץ מתקדם הושלם בהצלחה! ${result.total_assignments} שיבוצים נוצרו${fairnessMsg}`, 'success');
                    
                    // Log detailed results for debugging
                    console.log('Advanced scheduling result:', result);
                    
                    // Reload the schedule to show changes
                    await loadMonthSchedule(year, month);
                } else {
                    showNotification(`שגיאה בשיבוץ מתקדם: ${result.error || result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error in auto-scheduling:', error);
                showNotification('שגיאה בשיבוץ אוטומטי', 'error');
            }
        }

        // Remove auto-scheduled assignments function
        async function removeAutoScheduled() {
            try {
                // Show confirmation dialog
                const confirmed = confirm('האם אתה בטוח שברצונך למחוק את כל השיבוצים האוטומטיים? שיבוצים ידניים יישארו ללא שינוי.');
                
                if (!confirmed) {
                    showNotification('הפעולה בוטלה', 'info');
                    return;
                }
                
                showNotification('מוחק שיבוצים אוטומטיים...', 'info');
                
                const [year, month] = currentMonth.split('-');
                console.log('Removing auto-scheduled assignments for:', { year, month });
                
                // Call the remove endpoint
                const response = await fetch(`${API_BASE}/schedule/remove-auto-scheduled/${year}/${month}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`נמחקו ${result.removedCount} שיבוצים אוטומטיים בהצלחה`, 'success');
                    
                    // Reload the schedule to show changes
                    await loadMonthSchedule(year, month);
                } else {
                    showNotification(`שגיאה במחיקת שיבוצים אוטומטיים: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error removing auto-scheduled assignments:', error);
                showNotification('שגיאה במחיקת שיבוצים אוטומטיים', 'error');
            }
        }

        // Auto settings dialog removed; logic resides on server

        async function runAutoSchedulingAlgorithm(year, month, guides, currentSchedule, weekendTypes) {
            // Legacy client auto algorithm removed; backend is source of truth
            return { schedule: [], warnings: [] };
            try {
                const days = getAllDaysInMonth(year, month);
                const schedule = [];
                const guideStats = {}; // Track guide statistics for balancing
                
                // Initialize guide statistics
                guides.forEach(guide => {
                    guideStats[guide.id] = {
                        totalShifts: 0,
                        weekendShifts: 0,
                        conanShifts: 0,
                        lastShiftDate: null,
                        weeklyShifts: {} // Track shifts per week
                    };
                });
                
                // Process each day
                for (const day of days) {
                    const date = day.date;
                    const weekday = day.weekday;
                    const dow = getDayOfWeekLocal(date); // 0=Sun .. 6=Sat
                    
                    // Determine closed-weekend flags strictly as Fri–Sat pair
                    let isClosedFriday = false;
                    let isClosedSaturday = false;
                    if (dow === 5) {
                        // Friday itself or its Saturday linked
                        const saturday = new Date(date + 'T00:00:00');
                        saturday.setDate(saturday.getDate() + 1);
                        const sStr = `${saturday.getFullYear()}-${String(saturday.getMonth()+1).padStart(2,'0')}-${String(saturday.getDate()).padStart(2,'0')}`;
                        isClosedFriday = weekendTypes[date] === 'סופ״ש סגור' || weekendTypes[sStr] === 'סופ״ש סגור';
                    } else if (dow === 6) {
                        const friday = new Date(date + 'T00:00:00');
                        friday.setDate(friday.getDate() - 1);
                        const fStr = `${friday.getFullYear()}-${String(friday.getMonth()+1).padStart(2,'0')}-${String(friday.getDate()).padStart(2,'0')}`;
                        isClosedSaturday = weekendTypes[fStr] === 'סופ״ש סגור';
                    }

                    // Check if there's a manual assignment (sacred - don't change)
                    const existingAssignment = currentSchedule.find(s => s.date === date);
                    if (existingAssignment && existingAssignment.is_manual) {
                        schedule.push(existingAssignment);
                        
                        // Update statistics for manual assignments
                        if (existingAssignment.guide1_id) {
                            updateGuideStats(guideStats, existingAssignment.guide1_id, date, existingAssignment.guide1_role, weekday);
                        }
                        if (existingAssignment.guide2_id) {
                            updateGuideStats(guideStats, existingAssignment.guide2_id, date, existingAssignment.guide2_role, weekday);
                        }
                        continue;
                    }
                    
                    // Special handling for closed Saturday (based on Friday flag)
                    if (dow === 6 && isClosedSaturday) {
                        // Get the previous day's on-call guide
                        const previousDate = new Date(date);
                        previousDate.setDate(previousDate.getDate() - 1);
                        const prevDateStr = previousDate.toISOString().slice(0, 10);
                        
                        const prevAssignment = schedule.find(s => s.date === prevDateStr) || 
                                              currentSchedule.find(s => s.date === prevDateStr);
                        
                        let conanGuide = null;
                        if (prevAssignment && prevAssignment.guide1_role === 'כונן') {
                            conanGuide = guides.find(g => g.id === prevAssignment.guide1_id);
                        }
                        
                        // If we have a conan guide from Friday, use them for Saturday
                        if (conanGuide) {
                            const assignment = {
                                date: date,
                                weekday: weekday,
                                type: weekendType,
                                guide1_id: conanGuide.id,
                                guide1_name: conanGuide.name,
                                guide1_role: 'כונן',
                                guide2_id: null,
                                guide2_name: null,
                                guide2_role: null,
                                is_manual: false,
                                is_locked: false
                            };
                            
                            schedule.push(assignment);
                            updateGuideStats(guideStats, conanGuide.id, date, 'כונן', weekday);
                            continue;
                        }
                    }
                    
                    // Special handling for Saturday night (מוצ״ש) after closed Saturday
                    if (dow === 6 && isClosedSaturday) {
                        // Get the current day's on-call guide (should be the same as Friday)
                        const currentAssignment = schedule.find(s => s.date === date) || 
                                                 currentSchedule.find(s => s.date === date);
                        
                        let conanGuide = null;
                        if (currentAssignment && currentAssignment.guide1_role === 'כונן') {
                            conanGuide = guides.find(g => g.id === currentAssignment.guide1_id);
                        }
                        
                        // If we have a conan guide, keep them and add an additional guide
                        if (conanGuide) {
                            // Get available guides for the additional role
                            const availableGuides = await getAvailableGuidesForDay(date, guides, guideStats, currentSchedule, weekendType);
                            const additionalGuides = availableGuides.filter(g => g.id !== conanGuide.id);
                            const selectedAdditional = selectBestGuides(additionalGuides, 1, guideStats, date, weekday);
                            
                            const assignment = {
                                date: date,
                                weekday: weekday,
                                type: weekendType,
                                guide1_id: conanGuide.id,
                                guide1_name: conanGuide.name,
                                guide1_role: 'כונן',
                                guide2_id: selectedAdditional[0]?.id || null,
                                guide2_name: selectedAdditional[0]?.name || null,
                                guide2_role: 'חפיפה',
                                is_manual: false,
                                is_locked: false
                            };
                            
                            // Update the existing assignment or add new one
                            const existingIndex = schedule.findIndex(s => s.date === date);
                            if (existingIndex >= 0) {
                                schedule[existingIndex] = assignment;
                            } else {
                                schedule.push(assignment);
                            }
                            
                            updateGuideStats(guideStats, conanGuide.id, date, 'כונן', weekday);
                            if (selectedAdditional[0]) {
                                updateGuideStats(guideStats, selectedAdditional[0].id, date, 'חפיפה', weekday);
                            }
                            continue;
                        }
                    }
                    
                    // Determine required guides and roles based on day type
                    let requiredGuides, roles;
                    if (dow === 5 && isClosedFriday) {
                        requiredGuides = 1; roles = ['כונן'];
                    } else if (dow === 6 && isClosedSaturday) {
                        requiredGuides = 2; roles = ['כונן', 'מוצ״ש'];
                    } else {
                        requiredGuides = 2; roles = ['רגיל', 'חפיפה'];
                    }
                    
                    // Get available guides for this day
                    const availableGuides = await getAvailableGuidesForDay(date, guides, guideStats, currentSchedule, weekendType);
                    
                    // Select best guides based on balancing rules
                    const selectedGuides = selectBestGuides(availableGuides, requiredGuides, guideStats, date, weekday);
                    
                    // Create assignment
                    const assignment = {
                        date: date,
                        weekday: weekday,
                        type: (dow === 5 && isClosedFriday) ? 'כונן' : (dow === 6 && isClosedSaturday) ? 'סופ״ש סגור' : 'רגיל',
                        guide1_id: selectedGuides[0]?.id || null,
                        guide1_name: selectedGuides[0]?.name || null,
                        guide1_role: roles[0] || null,
                        guide2_id: selectedGuides[1]?.id || null,
                        guide2_name: selectedGuides[1]?.name || null,
                        guide2_role: roles[1] || null,
                        is_manual: false,
                        is_locked: false
                    };
                    
                    schedule.push(assignment);
                    
                    // Update statistics
                    selectedGuides.forEach((guide, index) => {
                        if (guide) {
                            updateGuideStats(guideStats, guide.id, date, roles[index], weekday);
                        }
                    });
                }
                
                // Save the new schedule
                // Temporarily disabled during scheduler refactor
                const response = await fetch(`${API_BASE}/schedule/auto-assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year, month, schedule })
                });
                const result = await response.json();
                if (result && result.disabled) {
                    showNotification('שיבוץ אוטומטי מושבת זמנית בזמן ריפקטור', 'warning');
                }
                return result;
                
            } catch (error) {
                console.error('Error in auto-scheduling algorithm:', error);
                return { success: false, error: error.message };
            }
        }

        function getRequiredGuidesForDay(weekendType, weekday) {
            // Closed Saturday = 1 on-call guide
            if (weekendType === 'סופ״ש סגור') {
                return { requiredGuides: 1, roles: ['כונן'] };
            }
            
            // Saturday night (מוצ״ש) after closed Saturday = 2 guides (on-call + additional)
            if (weekendType === 'מוצ״ש') {
                return { requiredGuides: 2, roles: ['כונן', 'חפיפה'] };
            }
            
            // Open Saturday/Holiday = 2 guides (regular + overlap)
            if (weekendType === 'שבת פתוחה' || isHoliday(weekendType)) {
                return { requiredGuides: 2, roles: ['רגיל', 'חפיפה'] };
            }
            
            // Regular weekday = 2 guides
            return { requiredGuides: 2, roles: ['רגיל', 'חפיפה'] };
        }

        async function getAvailableGuidesForDay(date, guides, guideStats, currentSchedule, weekendType) {
            const available = [];
            
            for (const guide of guides) {
                if (guide.role !== 'מדריך') continue;
                
                // Check basic availability
                const availability = await checkGuideAvailability(guide.id, date);
                if (!availability.available) continue;
                
                // Check consecutive days rule
                if (hasConsecutiveDayViolation(guide.id, date, guideStats, weekendType)) continue;
                
                // Check weekly limit rule
                if (hasWeeklyLimitViolation(guide.id, date, guideStats)) continue;
                
                // Check on-call limit rule
                if (hasConanLimitViolation(guide.id, date, guideStats)) continue;
                
                available.push(guide);
            }
            
            return available;
        }

        async function checkGuideAvailability(guideId, date) {
            try {
                const response = await fetch(`${API_BASE}/guides/availability/${date}`);
                const availability = await response.json();
                const guideAvailability = availability.find(a => a.guide_id === guideId);
                
                return {
                    available: guideAvailability?.status === 'available',
                    reason: guideAvailability?.reason || null
                };
            } catch (error) {
                console.error('Error checking guide availability:', error);
                return { available: false, reason: 'שגיאה בבדיקת זמינות' };
            }
        }

        function hasConsecutiveDayViolation(guideId, date, guideStats, weekendType) {
            const stats = guideStats[guideId];
            if (!stats || !stats.lastShiftDate) return false;
            
            const lastShift = new Date(stats.lastShiftDate);
            const currentDate = new Date(date);
            const diffDays = Math.ceil((currentDate - lastShift) / (1000 * 60 * 60 * 24));
            
            // Rule: No consecutive days (except on-call on closed Saturday)
            if (diffDays <= 1) {
                // Check if this is an on-call assignment on a closed Saturday
                if (weekendType === 'שבת סגורה') {
                    return false; // Allow consecutive days for on-call on closed Saturday
                }
                return true; // Violation for other cases
            }
            
            return false;
        }

        function hasWeeklyLimitViolation(guideId, date, guideStats) {
            const stats = guideStats[guideId];
            if (!stats) return false;
            
            const weekStart = getWeekStart(date);
            const weekKey = weekStart.toISOString().slice(0, 10);
            
            const weeklyCount = stats.weeklyShifts[weekKey] || 0;
            
            // Rule: Max 2 midweek shifts per guide per week (Sunday-Thursday)
            // Saturday night (מוצ״ש) doesn't count as midweek
            const currentDate = new Date(date);
            const currentWeekday = currentDate.getDay(); // 0=Sunday, 6=Saturday
            
            // Only apply limit to midweek days (Sunday-Thursday, days 0-4)
            if (currentWeekday >= 0 && currentWeekday <= 4) {
                return weeklyCount >= 2;
            }
            
            return false; // No limit for Friday/Saturday
        }

        function hasConanLimitViolation(guideId, date, guideStats) {
            const stats = guideStats[guideId];
            if (!stats) return false;
            
            // Rule: No on-call twice per month
            return stats.conanShifts >= 2;
        }

        function selectBestGuides(availableGuides, requiredCount, guideStats, date, weekday) {
            // Sort guides by score (lower score = better choice for balancing)
            const scoredGuides = availableGuides.map(guide => ({
                ...guide,
                score: calculateGuideScore(guide.id, guideStats, date, weekday)
            }));
            
            scoredGuides.sort((a, b) => a.score - b.score);
            
            return scoredGuides.slice(0, requiredCount);
        }

        function calculateGuideScore(guideId, guideStats, date, weekday) {
            const stats = guideStats[guideId] || { totalShifts: 0, weekendShifts: 0, conanShifts: 0 };
            
            let score = 0;
            
            // Prefer guides with fewer total shifts
            score += stats.totalShifts * 10;
            
            // Prefer guides with fewer weekend shifts
            score += stats.weekendShifts * 5;
            
            // Prefer guides with fewer on-call shifts
            score += stats.conanShifts * 8;
            
            // Prefer guides who haven't worked recently (2-day gap preference)
            if (stats.lastShiftDate) {
                const lastShift = new Date(stats.lastShiftDate);
                const currentDate = new Date(date);
                const diffDays = Math.ceil((currentDate - lastShift) / (1000 * 60 * 60 * 24));
                
                if (diffDays < 2) {
                    score += (2 - diffDays) * 15; // Penalty for recent work
                }
            }
            
            return score;
        }

        function updateGuideStats(guideStats, guideId, date, role, weekday) {
            if (!guideStats[guideId]) {
                guideStats[guideId] = {
                    totalShifts: 0,
                    weekendShifts: 0,
                    conanShifts: 0,
                    lastShiftDate: null,
                    weeklyShifts: {}
                };
            }
            
            const stats = guideStats[guideId];
            stats.totalShifts++;
            stats.lastShiftDate = date;
            
            // Track weekly shifts (only for midweek days - Sunday-Thursday)
            const currentDate = new Date(date);
            const currentWeekday = currentDate.getDay(); // 0=Sunday, 6=Saturday
            
            if (currentWeekday >= 0 && currentWeekday <= 4) {
                const weekStart = getWeekStart(date);
                const weekKey = weekStart.toISOString().slice(0, 10);
                stats.weeklyShifts[weekKey] = (stats.weeklyShifts[weekKey] || 0) + 1;
            }
            
            // Track role-specific shifts
            if (role === 'כונן') {
                stats.conanShifts++;
            }
            
            // Track weekend shifts
            if (weekday === 'שישי' || weekday === 'שבת') {
                stats.weekendShifts++;
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day; // Adjust to Sunday
            return new Date(d.setDate(diff));
        }

        function isHoliday(weekendType) {
            // Add holiday detection logic here
            return weekendType && weekendType.includes('חג');
        }

        async function fetchWeekendTypes(year, month) {
            try {
                const response = await fetch(`${API_BASE}/weekend-types/${year}/${month}`);
                const result = await response.json();
                return result.weekendTypes || {};
            } catch (error) {
                console.error('Error fetching weekend types:', error);
                return {};
            }
        }

        function getAllDaysInMonth(year, month) {
            // Build days using local midnight strings to avoid timezone drift
            const days = [];
            const first = new Date(`${year}-${String(month).padStart(2,'0')}-01T00:00:00`);
            let d = new Date(first);
            while (d.getMonth() === first.getMonth()) {
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const dd = String(d.getDate()).padStart(2,'0');
                const iso = `${y}-${m}-${dd}`;
                days.push({
                    date: iso,
                    weekday: getHebrewWeekday(d.getDay())
                });
                d.setDate(d.getDate()+1);
            }
            return days;
        }

        function getHebrewWeekday(dayIndex) {
            const weekdays = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            return weekdays[dayIndex];
        }

        function saveCurrentDraft() {
            showNotification('פונקציה זו תהיה זמינה בשלב הבא', 'info');
        }

        function loadDraft() {
            showNotification('פונקציה זו תהיה זמינה בשלב הבא', 'info');
        }

        function deleteDraft() {
            showNotification('פונקציה זו תהיה זמינה בשלב הבא', 'info');
        }

        async function clearAllAssignments() {
            console.log('clearAllAssignments function called!');
            // Ask for confirmation first
            const confirmed = confirm('האם אתה בטוח שאתה רוצה לנקות את כל השיבוצים של החודש? פעולה זו לא ניתנת לביטול.');
            
            if (!confirmed) {
                return;
            }
            
            try {
                const [year, month] = currentMonth.split('-');
                console.log('Clearing assignments for:', { year, month, currentMonth });
                
                // Clear all assignments for the month
                const response = await fetch(`${API_BASE}/schedule/clear-month`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ year, month })
                });
                
                console.log('Clear response status:', response.status);
                const result = await response.json();
                console.log('Clear response result:', result);
                
                if (result.success) {
                    showNotification(`כל השיבוצים נוקו בהצלחה (${result.deleted_count || result.changes || 0} שיבוצים)`, 'success');

                    // Reset workflow back to start for this month
                    const monthStr = `${year}-${String(month).padStart(2, '0')}`;
                    const resetResp = await fetch(`${API_BASE}/workflow/reset/${monthStr}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const resetResult = await resetResp.json();
                    console.log('Workflow reset result:', resetResult);

                    // Reload the month schedule and workflow status to update the UI
                    await loadMonthSchedule(year, month);
                    await loadWorkflowStatus(monthStr);

                    // Clear selected guides if any
                    selectedGuides = [];
                    updateSelectedGuidesFromArray();
                } else {
                    showNotification('שגיאה בניקוי השיבוצים', 'error');
                }
            } catch (error) {
                console.error('Error clearing assignments:', error);
                showNotification('שגיאה בניקוי השיבוצים', 'error');
            }
        }

        // Show scheduling statistics with integrated modal
        function showSchedulingStatistics() {
            // Create the statistics modal if it doesn't exist
            if (!document.getElementById('statisticsModal')) {
                createStatisticsModal();
            }
            
            const modal = document.getElementById('statisticsModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Load statistics data
            loadStatisticsData();
        }

        function createStatisticsModal() {
            const modalHTML = `
                <div class="statistics-modal" id="statisticsModal">
                    <div class="statistics-modal-content">
                        <!-- Modal Header -->
                        <div class="statistics-modal-header">
                            <h2 class="statistics-modal-title">📊 סטטיסטיקות ואיזון - ${getHebrewMonth(currentMonth)}</h2>
                            <button class="statistics-close-btn" onclick="closeStatisticsModal()">×</button>
                        </div>

                        <!-- Modal Content -->
                        <div class="statistics-modal-body">
                            <!-- Quick Stats Overview -->
                            <div class="statistics-quick-stats">
                                <div class="statistics-stats-grid">
                                    <div class="statistics-stat-card good">
                                        <div class="statistics-stat-number good" id="stats-assigned-days">--</div>
                                        <div class="statistics-stat-label">ימים שובצו</div>
                                    </div>
                                    <div class="statistics-stat-card warning">
                                        <div class="statistics-stat-number warning" id="stats-manual-auto">--</div>
                                        <div class="statistics-stat-label">ידני/אוטומטי</div>
                                    </div>
                                    <div class="statistics-stat-card good">
                                        <div class="statistics-stat-number good" id="stats-avg-shifts">--</div>
                                        <div class="statistics-stat-label">ממוצע משמרות</div>
                                    </div>
                                    <div class="statistics-stat-card critical">
                                        <div class="statistics-stat-number critical" id="stats-imbalance">--</div>
                                        <div class="statistics-stat-label">חוסר איזון</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Guides Table -->
                            <div class="statistics-guides-table-section">
                                <h3 class="statistics-section-title">
                                    👥 פירוט מדריכים
                                </h3>
                                <div class="statistics-table-container">
                                    <table class="statistics-guides-table">
                                        <thead>
                                            <tr>
                                                <th style="text-align: right;">מדריך</th>
                                                <th>סה"כ</th>
                                                <th>רגיל</th>
                                                <th>חפיפה</th>
                                                <th>כונן</th>
                                                <th>ס"ש</th>
                                                <th>איזון</th>
                                                <th>הפרש</th>
                                                <th>פעולות</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statisticsTableBody">
                                            <tr class="statistics-loading">
                                                <td colspan="9">
                                                    <div class="statistics-loading-spinner"></div>
                                                    טוען נתונים...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Smart Recommendations -->
                            <div class="statistics-recommendations">
                                <h3 class="statistics-section-title">
                                    💡 המלצות חכמות
                                </h3>
                                <div class="statistics-recommendation-list" id="recommendationsList">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeStatisticsModal() {
            const modal = document.getElementById('statisticsModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        async function loadStatisticsData() {
            try {
                showStatisticsLoading(true);
                
                const [year, month] = currentMonth.split('-');
                const response = await fetch(`${API_BASE}/schedule/enhanced-statistics/${year}/${month}`);
                const data = await response.json();
                
                if (data.success) {
                    statisticsData = data;
                    populateStatisticsModal(data);
                } else {
                    showStatisticsError('שגיאה בטעינת הנתונים');
                }
                
            } catch (error) {
                console.error('Error loading statistics:', error);
                showStatisticsError('שגיאה בטעינת הנתונים');
            } finally {
                showStatisticsLoading(false);
            }
        }

        function populateStatisticsModal(data) {
            // Update quick stats
            updateQuickStats(data);
            
            // Update guides table
            updateGuidesTable(data);
            
            // Update recommendations
            updateRecommendations(data);
            
            // Update modal title with current month
            const title = document.querySelector('.statistics-modal-title');
            if (title) {
                title.textContent = `📊 סטטיסטיקות ואיזון - ${getHebrewMonth(currentMonth)}`;
            }
        }

        function updateQuickStats(data) {
            const totalDays = new Date(data.month.split('-')[0], data.month.split('-')[1], 0).getDate();
            const assignedDays = data.day_statistics?.assigned_days || 0;
            const manualDays = data.day_statistics?.manual_days || 0;
            const autoDays = data.day_statistics?.auto_days || 0;
            const avgShifts = data.averages?.shifts_per_guide || 0;
            
            // Calculate imbalance count
            const imbalanceCount = data.guide_statistics.filter(g => 
                Math.abs(g.total_shifts - avgShifts) > 2
            ).length;
            
            // Update stat values
            document.getElementById('stats-assigned-days').textContent = `${assignedDays}/${totalDays}`;
            document.getElementById('stats-manual-auto').textContent = `${manualDays}/${autoDays}`;
            document.getElementById('stats-avg-shifts').textContent = avgShifts.toFixed(1);
            document.getElementById('stats-imbalance').textContent = imbalanceCount;
            
            // Update card status classes based on values
            const assignedCard = document.querySelector('.statistics-stat-card:nth-child(1)');
            const manualCard = document.querySelector('.statistics-stat-card:nth-child(2)');
            const avgCard = document.querySelector('.statistics-stat-card:nth-child(3)');
            const imbalanceCard = document.querySelector('.statistics-stat-card:nth-child(4)');
            
            // Update assigned days status
            assignedCard.className = `statistics-stat-card ${assignedDays === totalDays ? 'good' : assignedDays > totalDays * 0.8 ? 'warning' : 'critical'}`;
            document.getElementById('stats-assigned-days').className = `statistics-stat-number ${assignedDays === totalDays ? 'good' : assignedDays > totalDays * 0.8 ? 'warning' : 'critical'}`;
            
            // Update manual/auto ratio status
            manualCard.className = `statistics-stat-card ${manualDays > autoDays ? 'warning' : 'good'}`;
            document.getElementById('stats-manual-auto').className = `statistics-stat-number ${manualDays > autoDays ? 'warning' : 'good'}`;
            
            // Update imbalance status
            imbalanceCard.className = `statistics-stat-card ${imbalanceCount === 0 ? 'good' : imbalanceCount <= 2 ? 'warning' : 'critical'}`;
            document.getElementById('stats-imbalance').className = `statistics-stat-number ${imbalanceCount === 0 ? 'good' : imbalanceCount <= 2 ? 'warning' : 'critical'}`;
        }

        function updateGuidesTable(data) {
            const tbody = document.getElementById('statisticsTableBody');
            tbody.innerHTML = '';
            
            const avgShifts = data.averages?.shifts_per_guide || 0;
            
            data.guide_statistics.forEach(guide => {
                const row = document.createElement('tr');
                const balanceStatus = getStatisticsBalanceStatus(guide.total_shifts, avgShifts);
                const difference = guide.total_shifts - avgShifts;
                
                row.innerHTML = `
                    <td class="statistics-guide-name">${guide.name}</td>
                    <td><strong>${guide.total_shifts}</strong></td>
                    <td>${guide.regular_shifts || 0}</td>
                    <td>${guide.overlap_shifts || 0}</td>
                    <td>${guide.conan_shifts || 0}</td>
                    <td>${guide.weekend_shifts || 0}</td>
                    <td>
                        <span class="statistics-balance-indicator statistics-balance-${balanceStatus.class}">
                            ${balanceStatus.text}
                        </span>
                    </td>
                    <td style="color: ${difference > 0 ? '#ef4444' : difference < -1 ? '#f59e0b' : '#10b981'}; font-weight: bold;">
                        ${difference > 0 ? '+' : ''}${difference.toFixed(1)}
                    </td>
                    <td>
                        <button class="statistics-guide-btn" onclick="showIndividualGuideStats('${guide.name}')">
                            פירוט
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRecommendations(data) {
            const avgShifts = data.averages?.shifts_per_guide || 0;
            const overloaded = data.guide_statistics.filter(g => g.total_shifts > avgShifts + 2);
            const underloaded = data.guide_statistics.filter(g => g.total_shifts < avgShifts - 2);
            
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            
            // Overloaded guide recommendation
            if (overloaded.length > 0) {
                const guide = overloaded[0];
                const item = createStatisticsRecommendationItem(
                    '⚠️',
                    `<strong>${guide.name}</strong> עם ${(guide.total_shifts - avgShifts).toFixed(1)}+ משמרות מהממוצע - מומלץ להימנע משיבוץ נוסף`,
                    'הוסף אילוץ',
                    () => addConstraintForGuide(guide.name)
                );
                recommendationsList.appendChild(item);
            }
            
            // Underloaded guide recommendation
            if (underloaded.length > 0) {
                const guide = underloaded[0];
                const item = createStatisticsRecommendationItem(
                    '📈',
                    `<strong>${guide.name}</strong> זקוק/ה ל-${Math.abs(guide.total_shifts - avgShifts).toFixed(1)} משמרות נוספות להשגת איזון`,
                    'שבץ עדיפות',
                    () => prioritizeGuideForScheduling(guide.name)
                );
                recommendationsList.appendChild(item);
            }
            
            // Weekend distribution recommendation
            const avgWeekend = data.averages?.weekend_per_guide || 0;
            const weekendUnderloaded = data.guide_statistics.filter(g => (g.weekend_shifts || 0) < avgWeekend - 1);
            
            if (weekendUnderloaded.length > 2) {
                const item = createStatisticsRecommendationItem(
                    '🏖️',
                    `חלוקת סופי שבוע: ${weekendUnderloaded.length} מדריכים מתחת לממוצע`,
                    'צפה בפירוט',
                    () => showWeekendDistribution()
                );
                recommendationsList.appendChild(item);
            }
            
            // Auto-scheduling priority recommendation
            if (underloaded.length > 0) {
                const names = underloaded.slice(0, 3).map(g => g.name).join(', ');
                const item = createStatisticsRecommendationItem(
                    '🎯',
                    `הבא לשיבוץ אוטומטי: <strong>${names}</strong>`,
                    'שמור העדפה',
                    () => saveSchedulingPreference(underloaded.slice(0, 3))
                );
                recommendationsList.appendChild(item);
            }
            
            // If no issues, show success message
            if (overloaded.length === 0 && underloaded.length === 0) {
                const item = createStatisticsRecommendationItem(
                    '✅',
                    'איזון מצוין! כל המדריכים בטווח סביר של משמרות',
                    '',
                    null
                );
                recommendationsList.appendChild(item);
            }
        }

        function createStatisticsRecommendationItem(icon, text, actionText, actionCallback) {
            const item = document.createElement('div');
            item.className = 'statistics-recommendation-item';
            
            const actionButton = actionText ? 
                `<button class="statistics-recommendation-action">${actionText}</button>` : '';
            
            item.innerHTML = `
                <div class="statistics-recommendation-icon">${icon}</div>
                <div class="statistics-recommendation-text">${text}</div>
                ${actionButton}
            `;
            
            if (actionCallback && actionText) {
                const button = item.querySelector('.statistics-recommendation-action');
                if (button) {
                    button.onclick = actionCallback;
                }
            }
            
            return item;
        }

        function getStatisticsBalanceStatus(shifts, average) {
            const diff = shifts - average;
            if (diff > 2) {
                return { class: 'critical', text: 'עומס גבוה' };
            } else if (diff < -2) {
                return { class: 'warning', text: 'עומס נמוך' };
            } else {
                return { class: 'good', text: 'מאוזן' };
            }
        }

        function showStatisticsLoading(show) {
            const loadingRow = document.querySelector('.statistics-loading');
            if (loadingRow) {
                loadingRow.style.display = show ? 'table-row' : 'none';
            }
        }

        function showStatisticsError(message) {
            const tbody = document.getElementById('statisticsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #ef4444; padding: 20px;">
                            ❌ ${message}
                        </td>
                    </tr>
                `;
            }
        }

        function getHebrewMonth(monthString) {
            const [year, month] = monthString.split('-');
            const monthNames = [
                'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
            ];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        // Individual Guide Modal Integration
        function createIndividualGuideModal() {
            if (document.getElementById('individualGuideModal')) {
                return; // Already exists
            }

            const modalHTML = `
                <div class="individual-guide-modal" id="individualGuideModal">
                    <div class="individual-guide-content">
                        <!-- Header Section -->
                        <div class="guide-header">
                            <button class="guide-back-btn" onclick="closeIndividualGuideModal()">← חזור</button>
                            
                            <div class="guide-info">
                                <div class="guide-avatar">👤</div>
                                <h1 class="guide-name" id="individual-guide-name">טוען...</h1>
                                <p class="guide-role" id="individual-guide-role">מדריך</p>
                                <div class="guide-status" id="individual-guide-status">
                                    <span>⏳</span>
                                    <span>טוען נתונים...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Content Body -->
                        <div class="individual-guide-body">
                            <!-- Quick Stats Overview -->
                            <div class="guide-quick-stats">
                                <div class="guide-stats-grid">
                                    <div class="guide-stat-card">
                                        <div class="guide-stat-main" id="individual-total-shifts">--</div>
                                        <div class="guide-stat-label">סה"כ משמרות</div>
                                        <div class="guide-stat-comparison" id="individual-shifts-comparison">טוען...</div>
                                    </div>
                                    <div class="guide-stat-card">
                                        <div class="guide-stat-main" id="individual-weekend-shifts">--</div>
                                        <div class="guide-stat-label">סופי שבוע</div>
                                        <div class="guide-stat-comparison" id="individual-weekend-comparison">טוען...</div>
                                    </div>
                                    <div class="guide-stat-card">
                                        <div class="guide-stat-main" id="individual-conan-shifts">--</div>
                                        <div class="guide-stat-label">כוננויות</div>
                                        <div class="guide-stat-comparison" id="individual-conan-comparison">טוען...</div>
                                    </div>
                                    <div class="guide-stat-card">
                                        <div class="guide-stat-main" id="individual-total-hours">--</div>
                                        <div class="guide-stat-label">שעות עבודה</div>
                                        <div class="guide-stat-comparison" id="individual-salary-factor">טוען...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Monthly Calendar View -->
                            <div class="guide-calendar-section">
                                <div class="calendar-header">
                                    <h2 class="calendar-title">📅 לוח אישי - <span id="individual-calendar-month">טוען...</span></h2>
                                </div>
                                <div class="calendar-mini">
                                    <div class="calendar-grid" id="individual-calendar-grid">
                                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
                                            טוען לוח חודשי...
                                        </div>
                                    </div>
                                    
                                    <div class="calendar-legend">
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #dbeafe;"></div>
                                            <span>משמרת רגילה (<span id="legend-regular-count">0</span>)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #dcfce7;"></div>
                                            <span>חפיפה (<span id="legend-overlap-count">0</span>)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #fef3c7;"></div>
                                            <span>כוננות (<span id="legend-conan-count">0</span>)</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #f3e8ff;"></div>
                                            <span>סוף שבוע (<span id="legend-weekend-count">0</span>)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Breakdown -->
                            <div class="guide-breakdown-section">
                                <h2 class="calendar-title">📈 פילוח מפורט</h2>
                                <div class="breakdown-grid">
                                    <div class="breakdown-card">
                                        <h3 class="breakdown-title">🎯 סוגי משמרות</h3>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>משמרות רגילות</span>
                                                <span id="regular-shifts-breakdown">0/0 (0%)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-regular" id="regular-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>חפיפות</span>
                                                <span id="overlap-shifts-breakdown">0/0 (0%)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-overlap" id="overlap-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>כוננויות</span>
                                                <span id="conan-shifts-breakdown">0/0 (0%)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-conan" id="conan-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="breakdown-card">
                                        <h3 class="breakdown-title">📊 השוואה לצוות</h3>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>משמרות כולל</span>
                                                <span id="total-comparison">0 (ממוצע: 0)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-regular" id="total-comparison-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>סופי שבוע</span>
                                                <span id="weekend-comparison">0 (ממוצע: 0)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-weekend" id="weekend-comparison-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>איזון שכר</span>
                                                <span id="salary-comparison">פקטור 0 (ממוצע: 0)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-conan" id="salary-comparison-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="breakdown-card">
                                        <h3 class="breakdown-title">⏰ דפוסי עבודה</h3>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>ימי חול</span>
                                                <span id="weekday-pattern">0/0 (0%)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-regular" id="weekday-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>סופי שבוע</span>
                                                <span id="weekend-pattern">0/0 (0%)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-weekend" id="weekend-pattern-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>רצף עבודה מקסימלי</span>
                                                <span id="max-consecutive">0 ימים רצופים</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-conan" id="consecutive-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Constraints & Availability -->
                            <div class="guide-constraints-section">
                                <h2 class="calendar-title">🚫 אילוצים וזמינות</h2>
                                <div class="constraints-grid">
                                    <div class="constraint-card">
                                        <h3 class="breakdown-title">📋 אילוצים פעילים</h3>
                                        <div id="active-constraints">
                                            <div style="text-align: center; color: #64748b; padding: 20px;">טוען אילוצים...</div>
                                        </div>
                                    </div>

                                    <div class="constraint-card">
                                        <h3 class="breakdown-title">📊 זמינות כללית</h3>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>זמינות חודשית</span>
                                                <span id="monthly-availability">--/-- ימים (---%)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-overlap" id="monthly-availability-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>זמינות סופי שבוע</span>
                                                <span id="weekend-availability">--/-- סופ"ש (---%)</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-weekend" id="weekend-availability-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="progress-item">
                                            <div class="progress-label">
                                                <span>גמישות שיבוץ</span>
                                                <span id="scheduling-flexibility">טוען...</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill progress-conan" id="flexibility-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="guide-actions-section">
                                <h2 class="calendar-title">⚡ פעולות מהירות</h2>
                                <div class="actions-grid">
                                    <button class="guide-action-btn primary" onclick="addMonthlyConstraint()">
                                        <span>🚫</span>
                                        <span>הוסף אילוץ חודשי</span>
                                    </button>
                                    <button class="guide-action-btn" onclick="addFixedConstraint()">
                                        <span>📅</span>
                                        <span>הוסף אילוץ קבוע</span>
                                    </button>
                                    <button class="guide-action-btn" onclick="addVacation()">
                                        <span>🏖️</span>
                                        <span>רשום חופשה</span>
                                    </button>
                                    <button class="guide-action-btn warning" onclick="limitAutoScheduling()">
                                        <span>⚠️</span>
                                        <span>הגבל שיבוץ אוטומטי</span>
                                    </button>
                                    <button class="guide-action-btn" onclick="sendMessage()">
                                        <span>📧</span>
                                        <span>שלח הודעה</span>
                                    </button>
                                    <button class="guide-action-btn" onclick="exportPersonalReport()">
                                        <span>📊</span>
                                        <span>ייצא דוח אישי</span>
                                    </button>
                                    <button class="guide-action-btn" onclick="viewChangeHistory()">
                                        <span>🔄</span>
                                        <span>היסטוריית שינויים</span>
                                    </button>
                                    <button class="guide-action-btn danger" onclick="cancelAllMonthShifts()">
                                        <span>🗑️</span>
                                        <span>בטל כל שיבוצי החודש</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Global variables for individual guide modal
        let currentIndividualGuide = null;
        let individualGuideData = null;

        // Main function to show individual guide statistics (replaces the existing one)
        async function showIndividualGuideStats(guideName) {
            console.log('Opening individual stats for:', guideName);
            
            // Create modal if it doesn't exist
            createIndividualGuideModal();
            
            currentIndividualGuide = guideName;
            
            // Show modal
            const modal = document.getElementById('individualGuideModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Load individual guide data
            await loadIndividualGuideData(guideName);
        }

        function closeIndividualGuideModal() {
            const modal = document.getElementById('individualGuideModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            currentIndividualGuide = null;
            individualGuideData = null;
        }

        async function loadIndividualGuideData(guideName) {
            try {
                // First, find the guide data in the existing statistics data
                if (statisticsData && statisticsData.guide_statistics) {
                    const guideStats = statisticsData.guide_statistics.find(g => g.name === guideName);
                    if (guideStats) {
                        await populateIndividualGuideModal(guideStats, statisticsData.averages);
                    }
                }
                
                // Also load detailed schedule data for calendar view
                const [year, month] = currentMonth.split('-');
                const scheduleResponse = await fetch(`${API_BASE}/schedule/enhanced/${year}/${month}`);
                const scheduleData = await scheduleResponse.json();
                
                if (scheduleData) {
                    populateIndividualCalendar(guideName, scheduleData);
                }
                
                // Load constraints data
                await loadIndividualConstraints(guideName);
                
            } catch (error) {
                console.error('Error loading individual guide data:', error);
                showNotification('שגיאה בטעינת נתוני המדריך', 'error');
            }
        }

        async function populateIndividualGuideModal(guideStats, averages) {
            // Update header info
            document.getElementById('individual-guide-name').textContent = guideStats.name;
            document.getElementById('individual-guide-role').textContent = `מדריך • ${guideStats.employment_percentage || 100}% משרה`;
            
            // Calculate status
            const avgShifts = averages?.shifts_per_guide || 0;
            const difference = guideStats.total_shifts - avgShifts;
            let statusIcon = '🟢';
            let statusText = 'איזון טוב';
            
            if (difference > 2) {
                statusIcon = '🔴';
                statusText = `עומס גבוה - ${difference.toFixed(1)}+ מהממוצע`;
            } else if (difference < -2) {
                statusIcon = '🟡';
                statusText = `עומס נמוך - ${Math.abs(difference).toFixed(1)}- מהממוצע`;
            }
            
            document.getElementById('individual-guide-status').innerHTML = `
                <span>${statusIcon}</span>
                <span>${statusText}</span>
            `;
            
            // Update quick stats
            document.getElementById('individual-total-shifts').textContent = guideStats.total_shifts;
            document.getElementById('individual-weekend-shifts').textContent = guideStats.weekend_shifts || 0;
            document.getElementById('individual-conan-shifts').textContent = guideStats.conan_shifts || 0;
            document.getElementById('individual-total-hours').textContent = guideStats.total_hours || 0;
            
            // Update comparisons
            const weekendDiff = (guideStats.weekend_shifts || 0) - (averages?.weekend_per_guide || 0);
            const conanDiff = (guideStats.conan_shifts || 0) - (averages?.conan_per_guide || 0);
            
            document.getElementById('individual-shifts-comparison').textContent = 
                difference > 0 ? `${difference.toFixed(1)}+ מהממוצע` : 
                difference < -0.5 ? `${Math.abs(difference).toFixed(1)}- מהממוצע` : 'מאוזן';
            
            document.getElementById('individual-weekend-comparison').textContent = 
                weekendDiff > 0 ? `${weekendDiff.toFixed(1)}+ מהממוצע` : 
                weekendDiff < -0.5 ? `${Math.abs(weekendDiff).toFixed(1)}- מהממוצע` : 'מאוזן';
            
            document.getElementById('individual-conan-comparison').textContent = 
                (guideStats.conan_shifts || 0) >= 2 ? 'המקסימום' : 
                (guideStats.conan_shifts || 0) === 1 ? 'בטווח' : 'ללא כוננות';
            
            document.getElementById('individual-salary-factor').textContent = 
                `פקטור ${(guideStats.salary_factor || 0).toFixed(1)}`;
            
            // Update card classes
            updateIndividualStatCardClass('individual-total-shifts', difference);
            updateIndividualStatCardClass('individual-weekend-shifts', weekendDiff);
            updateIndividualStatCardClass('individual-conan-shifts', (guideStats.conan_shifts || 0) - 1);
            
            // Update breakdown section
            updateIndividualBreakdown(guideStats, averages);
            
            // Update calendar month title
            document.getElementById('individual-calendar-month').textContent = getHebrewMonth(currentMonth);
        }

        function updateIndividualStatCardClass(elementId, difference) {
            const element = document.getElementById(elementId);
            const card = element.closest('.guide-stat-card');
            
            card.classList.remove('critical', 'warning', 'balanced');
            
            if (difference > 2) {
                card.classList.add('critical');
            } else if (difference < -2 || (elementId.includes('conan') && difference < 0)) {
                card.classList.add('warning');
            } else {
                card.classList.add('balanced');
            }
        }

        function updateIndividualBreakdown(guideStats, averages) {
            const totalShifts = guideStats.total_shifts || 0;
            const regularShifts = guideStats.regular_shifts || 0;
            const overlapShifts = guideStats.overlap_shifts || 0;
            const conanShifts = guideStats.conan_shifts || 0;
            const weekendShifts = guideStats.weekend_shifts || 0;
            
            // Update shift types breakdown
            const regularPercentage = totalShifts > 0 ? (regularShifts / totalShifts * 100).toFixed(0) : 0;
            const overlapPercentage = totalShifts > 0 ? (overlapShifts / totalShifts * 100).toFixed(0) : 0;
            const conanPercentage = totalShifts > 0 ? (conanShifts / totalShifts * 100).toFixed(0) : 0;
            
            document.getElementById('regular-shifts-breakdown').textContent = `${regularShifts}/${totalShifts} (${regularPercentage}%)`;
            document.getElementById('overlap-shifts-breakdown').textContent = `${overlapShifts}/${totalShifts} (${overlapPercentage}%)`;
            document.getElementById('conan-shifts-breakdown').textContent = `${conanShifts}/${totalShifts} (${conanPercentage}%)`;
            
            document.getElementById('regular-progress').style.width = `${regularPercentage}%`;
            document.getElementById('overlap-progress').style.width = `${overlapPercentage}%`;
            document.getElementById('conan-progress').style.width = `${conanPercentage}%`;
            
            // Update comparison to team
            const avgTotal = averages?.shifts_per_guide || 0;
            const avgWeekend = averages?.weekend_per_guide || 0;
            const avgSalary = averages?.salary_factor_per_guide || 0;
            
            document.getElementById('total-comparison').textContent = `${totalShifts} (ממוצע: ${avgTotal.toFixed(1)})`;
            document.getElementById('weekend-comparison').textContent = `${weekendShifts} (ממוצע: ${avgWeekend.toFixed(1)})`;
            document.getElementById('salary-comparison').textContent = `פקטור ${(guideStats.salary_factor || 0).toFixed(1)} (ממוצע: ${avgSalary.toFixed(1)})`;
            
            const totalComparisonPercentage = avgTotal > 0 ? Math.min((totalShifts / avgTotal * 50), 100) : 0;
            const weekendComparisonPercentage = avgWeekend > 0 ? Math.min((weekendShifts / avgWeekend * 50), 100) : 0;
            const salaryComparisonPercentage = avgSalary > 0 ? Math.min(((guideStats.salary_factor || 0) / avgSalary * 50), 100) : 0;
            
            document.getElementById('total-comparison-progress').style.width = `${totalComparisonPercentage}%`;
            document.getElementById('weekend-comparison-progress').style.width = `${weekendComparisonPercentage}%`;
            document.getElementById('salary-comparison-progress').style.width = `${salaryComparisonPercentage}%`;
            
            // Update work patterns
            const weekdayShifts = totalShifts - weekendShifts;
            const weekdayPercentage = totalShifts > 0 ? (weekdayShifts / totalShifts * 100).toFixed(0) : 0;
            const weekendPercentage = totalShifts > 0 ? (weekendShifts / totalShifts * 100).toFixed(0) : 0;
            
            document.getElementById('weekday-pattern').textContent = `${weekdayShifts}/${totalShifts} (${weekdayPercentage}%)`;
            document.getElementById('weekend-pattern').textContent = `${weekendShifts}/${totalShifts} (${weekendPercentage}%)`;
            
            document.getElementById('weekday-progress').style.width = `${weekdayPercentage}%`;
            document.getElementById('weekend-pattern-progress').style.width = `${weekendPercentage}%`;
            
            // Mock consecutive days calculation (in real implementation, analyze schedule data)
            const maxConsecutive = Math.floor(Math.random() * 3) + 1;
            document.getElementById('max-consecutive').textContent = `${maxConsecutive} ימים רצופים`;
            document.getElementById('consecutive-progress').style.width = `${Math.min(maxConsecutive * 33, 100)}%`;
            
            // Update legend counts
            document.getElementById('legend-regular-count').textContent = regularShifts;
            document.getElementById('legend-overlap-count').textContent = overlapShifts;
            document.getElementById('legend-conan-count').textContent = conanShifts;
            document.getElementById('legend-weekend-count').textContent = weekendShifts;
        }

        function populateIndividualCalendar(guideName, scheduleData) {
            console.log(`🗓️ Populating individual calendar for: ${guideName}`);
            console.log(`📊 Schedule data contains ${scheduleData.length} entries`);
            
            const calendarGrid = document.getElementById('individual-calendar-grid');
            calendarGrid.innerHTML = '';
            
            // Add header days
            const headerDays = ['א\'', 'ב\'', 'ג\'', 'ד\'', 'ה\'', 'ו\'', 'ש\''];
            headerDays.forEach(day => {
                const headerCell = document.createElement('div');
                headerCell.className = 'calendar-day calendar-header-day';
                headerCell.textContent = day;
                calendarGrid.appendChild(headerCell);
            });
            
            // Get month info
            const [year, month] = currentMonth.split('-');
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const firstDayOfWeek = firstDay.getDay();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add days of month
            let workingDays = 0;
            let totalDays = lastDay.getDate();
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                // Find if this guide worked on this day
                const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const daySchedule = scheduleData.find(d => d.date_str === dateString);
                
                if (day <= 5) { // Debug first few days
                    console.log(`🔍 Day ${day} (${dateString}): schedule found = ${!!daySchedule}, data = `, daySchedule);
                }
                
                if (daySchedule) {
                    let isThisGuide = false;
                    let shiftType = '';
                    let isManual = false;
                    
                    // More robust name matching - trim whitespace and handle case variations
                    const normalizedGuideName = guideName.trim();
                    const guide1Name = (daySchedule.guide1_name || '').trim();
                    const guide2Name = (daySchedule.guide2_name || '').trim();
                    
                    if (guide1Name === normalizedGuideName) {
                        isThisGuide = true;
                        shiftType = daySchedule.guide1_role || 'רגיל';
                        isManual = daySchedule.is_manual;
                    } else if (guide2Name === normalizedGuideName) {
                        isThisGuide = true;
                        shiftType = daySchedule.guide2_role || 'חפיפה';
                        isManual = daySchedule.is_manual;
                    }
                    
                    if (isThisGuide) {
                        workingDays++;
                        console.log(`✅ ${guideName} works on ${dateString}: ${shiftType}`);
                        
                        // Determine CSS class based on shift type and day
                        const dayOfWeek = getDayOfWeekLocal(dateString);
                        const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                        
                        if (isWeekend) {
                            dayCell.classList.add('weekend');
                        } else if (shiftType.includes('כונן')) {
                            dayCell.classList.add('conan');
                        } else if (shiftType.includes('חפיפה')) {
                            dayCell.classList.add('overlap');
                        } else {
                            dayCell.classList.add('regular');
                        }
                        
                        if (isManual) {
                            dayCell.classList.add('manual');
                        }
                        
                        // Add tooltip with shift details
                        dayCell.title = `${shiftType}${isManual ? ' (ידני)' : ' (אוטומטי)'}`;
                    } else {
                        // Guide doesn't work this day - make it clearly empty
                        dayCell.classList.add('empty');
                        dayCell.style.backgroundColor = '#f8f9fa';
                        dayCell.style.color = '#6c757d';
                        dayCell.title = 'לא עובד ביום זה';
                    }
                } else {
                    // No schedule data for this day - completely empty
                    dayCell.classList.add('empty');
                    dayCell.style.backgroundColor = '#f8f9fa';
                    dayCell.style.color = '#6c757d';
                    dayCell.title = 'אין נתונים ליום זה';
                }
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Log summary
            console.log(`📋 Calendar populated for ${guideName}: ${workingDays} working days out of ${totalDays} total days`);
            
            // Update calendar title with guide name and month info
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 
                               'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            const monthName = monthNames[parseInt(month) - 1];
            const calendarMonthElement = document.getElementById('individual-calendar-month');
            if (calendarMonthElement) {
                calendarMonthElement.textContent = `${monthName} ${year} - ${guideName}`;
            }
        }

        async function loadIndividualConstraints(guideName) {
            try {
                // Try to fetch real constraints data from API
                const response = await fetch(`${API_BASE}/constraints/guide/${encodeURIComponent(guideName)}/${currentMonth}`);
                
                let constraints = [];
                if (response.ok) {
                    const data = await response.json();
                    constraints = data.constraints || [];
                } else {
                    // Fallback to mock data
                    constraints = [
                        {
                            type: 'vacation',
                            icon: '🏖️',
                            title: 'חופשה',
                            dates: '15-18 ביולי 2025'
                        },
                        {
                            type: 'fixed',
                            icon: '📅',
                            title: 'אילוץ קבוע',
                            dates: 'כל יום רביעי - לימודים'
                        }
                    ];
                }
                
                const constraintsContainer = document.getElementById('active-constraints');
                constraintsContainer.innerHTML = '';
                
                if (constraints.length === 0) {
                    constraintsContainer.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">אין אילוצים פעילים</div>';
                } else {
                    constraints.forEach(constraint => {
                        const constraintItem = document.createElement('div');
                        constraintItem.className = 'constraint-item';
                        constraintItem.innerHTML = `
                            <div class="constraint-icon constraint-${constraint.type}">${constraint.icon}</div>
                            <div class="constraint-details">
                                <div class="constraint-type">${constraint.title}</div>
                                <div class="constraint-dates">${constraint.dates}</div>
                            </div>
                        `;
                        constraintsContainer.appendChild(constraintItem);
                    });
                }
                
                // Update availability metrics
                const [year, month] = currentMonth.split('-');
                const totalDays = new Date(year, month, 0).getDate();
                const constrainedDays = constraints.length * 2; // Mock calculation
                const availableDays = totalDays - constrainedDays;
                const availabilityPercentage = Math.max(0, (availableDays / totalDays * 100)).toFixed(0);
                
                document.getElementById('monthly-availability').textContent = `${availableDays}/${totalDays} ימים (${availabilityPercentage}%)`;
                document.getElementById('monthly-availability-progress').style.width = `${availabilityPercentage}%`;
                
                // Weekend availability (mock)
                const weekendsInMonth = Math.ceil(totalDays / 7);
                const availableWeekends = Math.max(0, weekendsInMonth - Math.floor(constraints.length / 2));
                const weekendAvailabilityPercentage = Math.max(0, (availableWeekends / weekendsInMonth * 100)).toFixed(0);
                
                document.getElementById('weekend-availability').textContent = `${availableWeekends}/${weekendsInMonth} סופ"ש (${weekendAvailabilityPercentage}%)`;
                document.getElementById('weekend-availability-progress').style.width = `${weekendAvailabilityPercentage}%`;
                
                // Scheduling flexibility
                let flexibility = 'גבוהה - ללא אילוצים';
                let flexibilityPercentage = 95;
                
                if (constraints.length > 2) {
                    flexibility = 'נמוכה - אילוצים רבים';
                    flexibilityPercentage = 30;
                } else if (constraints.length > 0) {
                    flexibility = 'בינונית - יש אילוצים';
                    flexibilityPercentage = 65;
                }
                
                document.getElementById('scheduling-flexibility').textContent = flexibility;
                document.getElementById('flexibility-progress').style.width = `${flexibilityPercentage}%`;
                
            } catch (error) {
                console.error('Error loading constraints:', error);
                
                // Show error state
                const constraintsContainer = document.getElementById('active-constraints');
                constraintsContainer.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">שגיאה בטעינת אילוצים</div>';
            }
        }

        // Action Functions for Individual Guide Modal
        function addMonthlyConstraint() {
            showNotification(`הוספת אילוץ חודשי עבור ${currentIndividualGuide} - בקרוב`, 'info');
            // Here you would open a constraint management modal
        }

        function addFixedConstraint() {
            showNotification(`הוספת אילוץ קבוע עבור ${currentIndividualGuide} - בקרוב`, 'info');
            // Here you would open a fixed constraint modal
        }

        function addVacation() {
            showNotification(`רישום חופשה עבור ${currentIndividualGuide} - בקרוב`, 'info');
            // Here you would open a vacation request modal
        }

        function limitAutoScheduling() {
            showNotification(`הגבלת שיבוץ אוטומטי עבור ${currentIndividualGuide} - מוגדר`, 'success');
            // Here you would set auto-scheduling limitations
        }

        function sendMessage() {
            showNotification(`שליחת הודעה ל${currentIndividualGuide} - בקרוב`, 'info');
            // Here you would open a messaging interface
        }

        function exportPersonalReport() {
            if (!currentIndividualGuide) return;
            
            showNotification(`מייצא דוח אישי עבור ${currentIndividualGuide}...`, 'info');
            
            // Create CSV content for individual guide
            let csvContent = `דוח אישי - ${currentIndividualGuide}\n`;
            csvContent += `חודש,${getHebrewMonth(currentMonth)}\n\n`;
            csvContent += `סה"כ משמרות,${document.getElementById('individual-total-shifts').textContent}\n`;
            csvContent += `סופי שבוע,${document.getElementById('individual-weekend-shifts').textContent}\n`;
            csvContent += `כוננויות,${document.getElementById('individual-conan-shifts').textContent}\n`;
            csvContent += `שעות עבודה,${document.getElementById('individual-total-hours').textContent}\n`;
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `דוח_אישי_${currentIndividualGuide}_${currentMonth}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => {
                showNotification(`דוח אישי עבור ${currentIndividualGuide} יוצא בהצלחה`, 'success');
            }, 1000);
        }

        function viewChangeHistory() {
            showNotification(`היסטוריית שינויים עבור ${currentIndividualGuide} - בקרוב`, 'info');
            // Here you would show change history
        }

        function cancelAllMonthShifts() {
            if (!currentIndividualGuide) return;
            
            const confirmed = confirm(`האם אתה בטוח שברצונך לבטל את כל השיבוצים של ${currentIndividualGuide} לחודש ${getHebrewMonth(currentMonth)}?\n\nפעולה זו לא ניתנת לביטול.`);
            
            if (confirmed) {
                showNotification(`מבטל את כל השיבוצים של ${currentIndividualGuide}...`, 'info');
                
                // Here you would call the API to cancel all shifts for this guide
                setTimeout(() => {
                    showNotification(`כל השיבוצים של ${currentIndividualGuide} בוטלו בהצלחה`, 'success');
                    closeIndividualGuideModal();
                    // Refresh the main statistics modal
                    if (statisticsData) {
                        loadStatisticsData();
                    }
                }, 1500);
            }
        }

        function addConstraintForGuide(guideName) {
            console.log('Add constraint for:', guideName);
            showNotification(`הוספת אילוץ עבור ${guideName} - בקרוב`, 'info');
            // Here you can implement constraint addition functionality
            // For example, open the constraints management modal
        }

        function prioritizeGuideForScheduling(guideName) {
            console.log('Prioritize guide for scheduling:', guideName);
            showNotification(`עדיפות בשיבוץ עבור ${guideName} - מוגדר`, 'success');
            // Here you can implement scheduling priority logic
        }

        function showWeekendDistribution() {
            console.log('Show weekend distribution');
            showNotification('הצגת חלוקת סופי שבוע - בקרוב', 'info');
            // Here you can implement weekend distribution analysis
        }

        function saveSchedulingPreference(guides) {
            console.log('Save scheduling preference for:', guides);
            showNotification('העדפות שיבוץ נשמרו', 'success');
            // Here you can implement preference saving logic
        }

        function exportToExcel() {
            showNotification('פונקציה זו תהיה זמינה בשלב הבא', 'info');
        }

        // Coordinator Rules Management
        async function showCoordinatorRules() {
            try {
                console.log('Fetching coordinator rules...');
                const response = await fetch(`${API_BASE}/coordinator-rules`);
                console.log('Response status:', response.status);
                const rules = await response.json();
                console.log('Rules received:', rules);
                
                // The API returns an array directly, not an object with success/rules
                if (Array.isArray(rules)) {
                    console.log('Displaying rules modal with', rules.length, 'rules');
                    displayCoordinatorRulesModal(rules);
                } else {
                    console.error('Rules is not an array:', rules);
                    showNotification('שגיאה בטעינת חוקי השיבוץ', 'error');
                }
            } catch (error) {
                console.error('Error fetching coordinator rules:', error);
                showNotification('שגיאה בטעינת חוקי השיבוץ', 'error');
            }
        }

        function displayCoordinatorRulesModal(rules) {
            console.log('Creating modal for rules:', rules);
            
            // Remove any existing modals first
            const existingModals = document.querySelectorAll('.modal');
            existingModals.forEach(modal => modal.remove());
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: 12px;
                    max-width: 800px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div class="modal-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #e0e0e0;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border-radius: 12px 12px 0 0;
                    ">
                        <h2 style="margin: 0; font-size: 1.5rem;">חוקי שיבוץ דינאמיים</h2>
                        <span class="close" style="
                            font-size: 24px;
                            cursor: pointer;
                            padding: 5px;
                            border-radius: 50%;
                            transition: background 0.3s;
                        " onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div class="rules-section" style="margin-bottom: 20px;">
                            <div class="rules-header" style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 15px;
                                padding-bottom: 10px;
                                border-bottom: 2px solid #667eea;
                            ">
                                <h3 style="margin: 0; color: #333; font-size: 1.2rem;">חוקים פעילים</h3>
                                <button class="btn btn-success" onclick="addNewRule()" style="
                                    background: #10b981;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                ">
                                    <span class="icon">➕</span>
                                    הוסף חוק חדש
                                </button>
                            </div>
                            <div class="rules-list" style="display: flex; flex-direction: column; gap: 10px;">
                                ${rules.map(rule => `
                                    <div class="rule-item" data-rule-id="${rule.id}" style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        padding: 15px;
                                        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
                                        border-radius: 8px;
                                        border: 1px solid #cbd5e1;
                                    ">
                                        <div class="rule-info" style="flex: 1;">
                                            <div class="rule-type" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                <span class="rule-icon" style="font-size: 18px;">${getRuleIcon(rule.rule_type)}</span>
                                                <span class="rule-title" style="font-weight: 600; color: #374151;">${getRuleTitle(rule.rule_type)}</span>
                                            </div>
                                            <div class="rule-description" style="color: #6b7280; font-size: 14px; margin-bottom: 3px;">${rule.description || ''}</div>
                                            <div class="rule-guides" style="color: #059669; font-weight: 500; font-size: 14px;">
                                                ${rule.guide1_name}${rule.guide2_name ? ` + ${rule.guide2_name}` : ''}
                                            </div>
                                        </div>
                                        <div class="rule-actions" style="display: flex; gap: 5px;">
                                            <button class="btn btn-sm btn-warning" onclick="editRule(${rule.id})" style="
                                                background: #f59e0b;
                                                color: white;
                                                border: none;
                                                padding: 4px 8px;
                                                border-radius: 4px;
                                                cursor: pointer;
                                                font-size: 12px;
                                            ">
                                                <span class="icon">✏️</span>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id})" style="
                                                background: #dc2626;
                                                color: white;
                                                border: none;
                                                padding: 4px 8px;
                                                border-radius: 4px;
                                                cursor: pointer;
                                                font-size: 12px;
                                            ">
                                                <span class="icon">🗑️</span>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('Modal added to body');
            
            // Add click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Add hover effects for close button
            const closeBtn = modal.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('mouseenter', () => {
                    closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                });
                closeBtn.addEventListener('mouseleave', () => {
                    closeBtn.style.background = 'transparent';
                });
            }
        }

        function getRuleIcon(ruleType) {
            console.log('Getting icon for rule type:', ruleType);
            const icons = {
                'no_auto_scheduling': '🤖',
                'no_conan': '🚫',
                'no_together': '👥'
            };
            const icon = icons[ruleType] || '📋';
            console.log('Icon:', icon);
            return icon;
        }

        function getRuleTitle(ruleType) {
            console.log('Getting title for rule type:', ruleType);
            const titles = {
                'no_auto_scheduling': 'לא לשבץ באוטומטי',
                'no_conan': 'לא לשבץ ככונן',
                'no_together': 'לא לעבוד יחד'
            };
            const title = titles[ruleType] || 'חוק לא ידוע';
            console.log('Title:', title);
            return title;
        }

        // Coordinator Rules CRUD Functions
        async function addNewRule() {
            try {
                // First, get all guides for the dropdown
                const guidesResponse = await fetch(`${API_BASE}/guides/enhanced`);
                const guidesResult = await guidesResponse.json();
                
                // The API returns an array directly, not an object with success/guides
                const guides = Array.isArray(guidesResult) ? guidesResult : [];
                
                if (guides.length === 0) {
                    showNotification('שגיאה בטעינת המדריכים', 'error');
                    return;
                }
                
                // Remove any existing modals first
                const existingModals = document.querySelectorAll('.modal');
                existingModals.forEach(modal => modal.remove());
                
                // Create modal for adding new rule
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;
                
                modal.innerHTML = `
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 12px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    ">
                        <div class="modal-header" style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 20px;
                            border-bottom: 1px solid #e0e0e0;
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border-radius: 12px 12px 0 0;
                        ">
                            <h2 style="margin: 0; font-size: 1.5rem;">הוסף חוק חדש</h2>
                            <span class="close" style="
                                font-size: 24px;
                                cursor: pointer;
                                padding: 5px;
                                border-radius: 50%;
                                transition: background 0.3s;
                            " onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <form id="newRuleForm">
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label for="ruleType" style="
                                        display: block;
                                        margin-bottom: 8px;
                                        font-weight: 600;
                                        color: #374151;
                                    ">סוג החוק:</label>
                                    <select id="ruleType" required onchange="updateRuleForm()" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #d1d5db;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        transition: border-color 0.3s;
                                    ">
                                        <option value="">בחר סוג חוק...</option>
                                        <option value="no_auto_scheduling">לא לשבץ באוטומטי</option>
                                        <option value="no_conan">לא לשבץ ככונן</option>
                                        <option value="no_together">לא לעבוד יחד</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label for="guide1" style="
                                        display: block;
                                        margin-bottom: 8px;
                                        font-weight: 600;
                                        color: #374151;
                                    ">מדריך ראשון:</label>
                                    <select id="guide1" required style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #d1d5db;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        transition: border-color 0.3s;
                                    ">
                                        <option value="">בחר מדריך...</option>
                                        ${guides.map(guide => `<option value="${guide.id}">${guide.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group" id="guide2Group" style="display: none; margin-bottom: 20px;">
                                    <label for="guide2" style="
                                        display: block;
                                        margin-bottom: 8px;
                                        font-weight: 600;
                                        color: #374151;
                                    ">מדריך שני:</label>
                                    <select id="guide2" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #d1d5db;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        transition: border-color 0.3s;
                                    ">
                                        <option value="">בחר מדריך...</option>
                                        ${guides.map(guide => `<option value="${guide.id}">${guide.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label for="description" style="
                                        display: block;
                                        margin-bottom: 8px;
                                        font-weight: 600;
                                        color: #374151;
                                    ">תיאור (אופציונלי):</label>
                                    <input type="text" id="description" placeholder="תיאור החוק..." style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #d1d5db;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        transition: border-color 0.3s;
                                    ">
                                </div>
                                
                                <div class="form-actions" style="
                                    display: flex;
                                    gap: 10px;
                                    justify-content: flex-end;
                                    margin-top: 30px;
                                    padding-top: 20px;
                                    border-top: 1px solid #e5e7eb;
                                ">
                                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="
                                        background: #6b7280;
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                    ">ביטול</button>
                                    <button type="submit" class="btn btn-success" style="
                                        background: #10b981;
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                    ">הוסף חוק</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('newRuleForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await submitNewRule();
                });
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                // Add hover effects for close button
                const closeBtn = modal.querySelector('.close');
                if (closeBtn) {
                    closeBtn.addEventListener('mouseenter', () => {
                        closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                    });
                    closeBtn.addEventListener('mouseleave', () => {
                        closeBtn.style.background = 'transparent';
                    });
                }
                
            } catch (error) {
                console.error('Error creating new rule form:', error);
                showNotification('שגיאה ביצירת טופס החוק', 'error');
            }
        }

        function updateRuleForm() {
            const ruleType = document.getElementById('ruleType').value;
            const guide2Group = document.getElementById('guide2Group');
            const guide2 = document.getElementById('guide2');
            
            if (ruleType === 'no_together') {
                guide2Group.style.display = 'block';
                guide2.required = true;
            } else {
                guide2Group.style.display = 'none';
                guide2.required = false;
                guide2.value = '';
            }
        }

        async function submitNewRule() {
            try {
                const ruleType = document.getElementById('ruleType').value;
                const guide1Id = document.getElementById('guide1').value;
                const guide2Id = document.getElementById('guide2').value;
                const description = document.getElementById('description').value;
                
                if (!ruleType || !guide1Id) {
                    showNotification('חובה למלא את כל השדות הנדרשים', 'error');
                    return;
                }
                
                if (ruleType === 'no_together' && !guide2Id) {
                    showNotification('חוק "לא לעבוד יחד" דורש שני מדריכים', 'error');
                    return;
                }
                
                if (guide1Id === guide2Id) {
                    showNotification('לא ניתן לבחור את אותו מדריך פעמיים', 'error');
                    return;
                }
                
                // Get current user info for created_by field
                const currentUser = localStorage.getItem('name') || 'מערכת';
                
                const response = await fetch(`${API_BASE}/coordinator-rules`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rule_type: ruleType,
                        guide1_id: parseInt(guide1Id),
                        guide2_id: guide2Id ? parseInt(guide2Id) : null,
                        description: description || null,
                        created_by: currentUser
                    })
                });
                
                const result = await response.json();
                // The API returns the created rule object directly
                if (result && result.id) {
                    showNotification('החוק נוסף בהצלחה', 'success');
                    // Close the modal
                    document.querySelector('.modal').remove();
                    // Refresh the main rules modal
                    await refreshCurrentRulesModal();
                } else {
                    showNotification(`שגיאה בהוספת החוק: ${result.error || 'שגיאה לא ידועה'}`, 'error');
                }
            } catch (error) {
                console.error('Error submitting new rule:', error);
                showNotification('שגיאה בהוספת החוק', 'error');
            }
        }

        async function editRule(ruleId) {
            showNotification('עריכת חוק - בקרוב', 'info');
        }

        async function deleteRule(ruleId) {
            try {
                const confirmed = confirm('האם אתה בטוח שאתה רוצה למחוק את החוק הזה?');
                if (!confirmed) return;

                const response = await fetch(`${API_BASE}/coordinator-rules/${ruleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                // The API returns {success: true} for successful deletion
                if (result.success) {
                    showNotification('החוק נמחק בהצלחה', 'success');
                    // Refresh the current modal instead of creating a new one
                    refreshCurrentRulesModal();
                } else {
                    showNotification('שגיאה במחיקת החוק', 'error');
                }
            } catch (error) {
                console.error('Error deleting rule:', error);
                showNotification('שגיאה במחיקת החוק', 'error');
            }
        }

        async function refreshCurrentRulesModal() {
            try {
                const response = await fetch(`${API_BASE}/coordinator-rules`);
                const rules = await response.json();
                
                // The API returns an array directly, not an object with success/rules
                if (Array.isArray(rules)) {
                    // Find the current modal and update its content
                    const currentModal = document.querySelector('.modal');
                    if (currentModal) {
                        const modalBody = currentModal.querySelector('.modal-body');
                        if (modalBody) {
                            modalBody.innerHTML = `
                                <div class="rules-section" style="margin-bottom: 20px;">
                                    <div class="rules-header" style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 15px;
                                        padding-bottom: 10px;
                                        border-bottom: 2px solid #667eea;
                                    ">
                                        <h3 style="margin: 0; color: #333; font-size: 1.2rem;">חוקים פעילים</h3>
                                        <button class="btn btn-success" onclick="addNewRule()" style="
                                            background: #10b981;
                                            color: white;
                                            border: none;
                                            padding: 8px 16px;
                                            border-radius: 6px;
                                            cursor: pointer;
                                        ">
                                            <span class="icon">➕</span>
                                            הוסף חוק חדש
                                        </button>
                                    </div>
                                    <div class="rules-list" style="display: flex; flex-direction: column; gap: 10px;">
                                        ${rules.map(rule => `
                                            <div class="rule-item" data-rule-id="${rule.id}" style="
                                                display: flex;
                                                justify-content: space-between;
                                                align-items: center;
                                                padding: 15px;
                                                background: linear-gradient(135deg, #f8fafc, #e2e8f0);
                                                border-radius: 8px;
                                                border: 1px solid #cbd5e1;
                                            ">
                                                <div class="rule-info" style="flex: 1;">
                                                    <div class="rule-type" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span class="rule-icon" style="font-size: 18px;">${getRuleIcon(rule.rule_type)}</span>
                                                        <span class="rule-title" style="font-weight: 600; color: #374151;">${getRuleTitle(rule.rule_type)}</span>
                                                    </div>
                                                    <div class="rule-description" style="color: #6b7280; font-size: 14px; margin-bottom: 3px;">${rule.description || ''}</div>
                                                    <div class="rule-guides" style="color: #059669; font-weight: 500; font-size: 14px;">
                                                        ${rule.guide1_name}${rule.guide2_name ? ` + ${rule.guide2_name}` : ''}
                                                    </div>
                                                </div>
                                                <div class="rule-actions" style="display: flex; gap: 5px;">
                                                    <button class="btn btn-sm btn-warning" onclick="editRule(${rule.id})" style="
                                                        background: #f59e0b;
                                                        color: white;
                                                        border: none;
                                                        padding: 4px 8px;
                                                        border-radius: 4px;
                                                        cursor: pointer;
                                                        font-size: 12px;
                                                    ">
                                                        <span class="icon">✏️</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id})" style="
                                                        background: #dc2626;
                                                        color: white;
                                                        border: none;
                                                        padding: 4px 8px;
                                                        border-radius: 4px;
                                                        cursor: pointer;
                                                        font-size: 12px;
                                                    ">
                                                        <span class="icon">🗑️</span>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing rules modal:', error);
            }
        }

        // =====================================================
        // WORKFLOW FUNCTIONS
        // =====================================================

        // Load workflow status when month changes
        async function loadWorkflowStatus(month) {
            try {
                // Clean the month parameter - remove any extra characters
                const cleanMonth = month.split(':')[0]; // Remove anything after colon
                console.log('Loading workflow status for month:', cleanMonth);
                
                const response = await fetch(`${API_BASE}/workflow/status/${cleanMonth}`);
                workflowStatus = await response.json();
                
                console.log('Workflow status loaded:', workflowStatus);
                updateWorkflowUI();
                
                return workflowStatus;
            } catch (error) {
                console.error('Error loading workflow status:', error);
                showNotification('שגיאה בטעינת סטטוס התהליך', 'error');
            }
        }

        // Update UI based on workflow status
        function updateWorkflowUI() {
            if (!workflowStatus) return;
            
            isFinalized = workflowStatus.is_finalized;
            availableDrafts = workflowStatus.drafts_available || [];
            
            updateWorkflowButtons();
            updateWorkflowPanel();
            
            if (isFinalized) {
                makeInterfaceReadOnly();
            }
        }

        // Update workflow-related buttons in toolbar
        function updateWorkflowButtons() {
            const toolbar = document.querySelector('.toolbar');
            
            // Remove existing workflow section
            const existingWorkflowSection = toolbar.querySelector('.workflow-section');
            if (existingWorkflowSection) {
                existingWorkflowSection.remove();
            }
            
            // Create workflow section
            const workflowSection = document.createElement('div');
            workflowSection.className = 'toolbar-section workflow-section';
            
            if (isFinalized) {
                workflowSection.innerHTML = `
                    <h3>🔒 חודש מאושר</h3>
                    <button class="btn btn-info" onclick="viewOfficialSchedule()">
                        <span class="icon">📋</span>
                        צפה בלוח רשמי
                    </button>
                `;
            } else {
                workflowSection.innerHTML = `
                    <h3>תהליך עבודה</h3>
                    <button class="btn btn-success" onclick="createFirstDraft()" ${workflowStatus.current_draft_version > 0 ? 'style="display:none"' : ''}>
                        <span class="icon">📝</span>
                        טיוטה ראשונה
                    </button>
                    <button class="btn btn-primary" onclick="saveNewDraft()" ${workflowStatus.current_draft_version === 0 ? 'style="display:none"' : ''}>
                        <span class="icon">💾</span>
                        שמור טיוטה חדשה
                    </button>
                    <button class="btn btn-warning" onclick="sendToGuides()" ${workflowStatus.current_draft_version === 0 ? 'style="display:none"' : ''}>
                        <span class="icon">📧</span>
                        שלח למדריכים
                    </button>
                    <button class="btn btn-danger" onclick="finalizeSchedule()" ${workflowStatus.current_draft_version === 0 ? 'style="display:none"' : ''}>
                        <span class="icon">✅</span>
                        אשר לוח רשמי
                    </button>
                `;
            }
            
            // Insert workflow section after automatic scheduling section
            const autoSchedulingSection = toolbar.querySelector('.toolbar-section:first-child');
            if (autoSchedulingSection) {
                autoSchedulingSection.insertAdjacentElement('afterend', workflowSection);
            }
        }

        // Add workflow status panel
        function updateWorkflowPanel() {
            // Remove existing workflow panel
            const existingPanel = document.querySelector('.workflow-status-panel');
            if (existingPanel) {
                existingPanel.remove();
            }
            
            // Create workflow status panel
            const panel = document.createElement('div');
            panel.className = 'workflow-status-panel';
            
            const currentDraft = workflowStatus.current_draft_version;
            
            panel.innerHTML = `
                <div class="workflow-status ${isFinalized ? 'finalized' : 'active'}">
                    <h4>${isFinalized ? '🔒 חודש מאושר' : '📝 תהליך עבודה'} - ${currentMonth}</h4>
                    <p>
                        ${isFinalized 
                            ? 'הלוח אושר ולא ניתן לשינוי' 
                            : `טיוטה נוכחית: ${currentDraft > 0 ? `גרסה ${currentDraft}` : 'לא נוצרה'}`
                        }
                    </p>
                </div>
            `;
            
            // Insert panel after header
            const header = document.querySelector('.header');
            if (header) {
                header.insertAdjacentElement('afterend', panel);
            }
        }

        // Make interface read-only when finalized
        function makeInterfaceReadOnly() {
            const editButtons = document.querySelectorAll('.edit-day-btn');
            editButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        }

        // Create first draft
        async function createFirstDraft() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                const confirmed = confirm('האם אתה בטוח שאתה רוצה ליצור טיוטה ראשונה?');
                if (!confirmed) return;
                
                showNotification('יוצר טיוטה ראשונה...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/create-draft/${cleanMonth}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ created_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`טיוטה ראשונה נוצרה בהצלחה!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`שגיאה ביצירת טיוטה: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error creating first draft:', error);
                showNotification('שגיאה ביצירת טיוטה ראשונה', 'error');
            }
        }

        // Save new draft
        async function saveNewDraft() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                showNotification('שומר טיוטה חדשה...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/create-draft/${cleanMonth}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ created_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`טיוטה חדשה נשמרה בהצלחה!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`שגיאה בשמירת טיוטה: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error saving new draft:', error);
                showNotification('שגיאה בשמירת טיוטה חדשה', 'error');
            }
        }

        // Send to guides
        async function sendToGuides() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                if (workflowStatus.current_draft_version === 0) {
                    showNotification('יש ליצור טיוטה לפני שליחה למדריכים', 'warning');
                    return;
                }
                
                const confirmed = confirm(`האם לשלוח טיוטה גרסה ${workflowStatus.current_draft_version} לכל המדריכים?`);
                if (!confirmed) return;
                
                showNotification('שולח טיוטה למדריכים...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/send-to-guides/${cleanMonth}/${workflowStatus.current_draft_version}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sent_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`נשלח ל-${result.total_recipients} מדריכים בהצלחה!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`שגיאה בשליחה: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error sending to guides:', error);
                showNotification('שגיאה בשליחה למדריכים', 'error');
            }
        }

        // Finalize schedule
        async function finalizeSchedule() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                const confirmed = confirm(`האם אתה בטוח שאתה רוצה לאשר את הלוח לחודש ${cleanMonth} כרשמי?\n\nלאחר אישור לא ניתן יהיה לבצע שינויים!`);
                if (!confirmed) return;
                
                showNotification('מאשר לוח רשמי...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/finalize/${cleanMonth}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ finalized_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`לוח חודש ${cleanMonth} אושר בהצלחה כרשמי!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`שגיאה באישור הלוח: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error finalizing schedule:', error);
                showNotification('שגיאה באישור הלוח הרשמי', 'error');
            }
        }

        // Placeholder functions
        function viewOfficialSchedule() {
            showNotification('מעביר ללוח הרשמי - בקרוב', 'info');
        }

        // Add event listeners for individual guide modal
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('individualGuideModal');
            if (modal && event.target === modal) {
                closeIndividualGuideModal();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('individualGuideModal');
                if (modal && modal.style.display === 'flex') {
                    closeIndividualGuideModal();
                }
            }
        });

        console.log('Individual Guide Modal integration loaded successfully');
    </script>

    </div>

    <!-- Footer -->
    <div id="main-footer"></div>
</body>
</html>