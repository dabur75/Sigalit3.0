<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Test Coordinator Rules</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="header-functions.js"></script>
    <style>
        body {
            font-family: 'Heebo', Arial, sans-serif;
            padding: 20px;
            background: #f8fafd;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .result {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
        }
        .success {
            background: #dcfce7;
            color: #16a34a;
        }
    </style>
</head>
<body>
    <h1>בדיקת חוקי שיבוץ</h1>
    
    <div class="test-section">
        <h2>בדיקת API</h2>
        <button class="btn" onclick="testAPI()">בדוק API</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>בדיקת Modal</h2>
        <button class="btn" onclick="testModal()">פתח Modal</button>
        <div id="modal-result" class="result"></div>
    </div>
    
    <script>
        // Use centralized API base from header-functions.js
        const API_BASE = window.API_BASE_URL;
        
        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            try {
                console.log('Testing coordinator rules API...');
                const response = await fetch(`${API_BASE}/api/coordinator-rules`);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('API response:', data);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `API עובד! קיבלתי ${data.length} חוקים:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                console.error('API test error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `שגיאה ב-API: ${error.message}`;
            }
        }
        
        async function testModal() {
            const resultDiv = document.getElementById('modal-result');
            try {
                console.log('Testing modal creation...');
                
                // Test the showCoordinatorRules function
                await showCoordinatorRules();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = 'Modal נפתח בהצלחה!';
            } catch (error) {
                console.error('Modal test error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `שגיאה ב-Modal: ${error.message}`;
            }
        }
        
        // Copy the functions from scheduler.html
        async function showCoordinatorRules() {
            try {
                console.log('Fetching coordinator rules...');
                const response = await fetch(`${API_BASE}/api/coordinator-rules`);
                console.log('Response status:', response.status);
                const rules = await response.json();
                console.log('Rules received:', rules);
                
                if (Array.isArray(rules)) {
                    console.log('Displaying rules modal with', rules.length, 'rules');
                    displayCoordinatorRulesModal(rules);
                } else {
                    console.error('Rules is not an array:', rules);
                    throw new Error('שגיאה בטעינת חוקי השיבוץ');
                }
            } catch (error) {
                console.error('Error fetching coordinator rules:', error);
                throw error;
            }
        }

        function displayCoordinatorRulesModal(rules) {
            console.log('Creating modal for rules:', rules);
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 800px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #e0e0e0;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border-radius: 12px 12px 0 0;
                    ">
                        <h2 style="margin: 0; font-size: 1.5rem;">חוקי שיבוץ דינאמיים</h2>
                        <span style="font-size: 24px; cursor: pointer; padding: 5px;" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 15px;
                                padding-bottom: 10px;
                                border-bottom: 2px solid #667eea;
                            ">
                                <h3 style="margin: 0; color: #333; font-size: 1.2rem;">חוקים פעילים</h3>
                                <button class="btn" onclick="alert('הוסף חוק חדש')">
                                    ➕ הוסף חוק חדש
                                </button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${rules.map(rule => `
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        padding: 15px;
                                        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
                                        border-radius: 8px;
                                        border: 1px solid #cbd5e1;
                                    ">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                <span style="font-size: 18px;">${getRuleIcon(rule.rule_type)}</span>
                                                <span style="font-weight: 600; color: #374151;">${getRuleTitle(rule.rule_type)}</span>
                                            </div>
                                            <div style="color: #6b7280; font-size: 14px; margin-bottom: 3px;">${rule.description || ''}</div>
                                            <div style="color: #059669; font-weight: 500; font-size: 14px;">
                                                ${rule.guide1_name}${rule.guide2_name ? ` + ${rule.guide2_name}` : ''}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="alert('ערוך חוק')">✏️</button>
                                            <button class="btn" style="padding: 4px 8px; font-size: 12px; background: #dc2626;" onclick="alert('מחק חוק')">🗑️</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('Modal added to body');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getRuleIcon(ruleType) {
            const icons = {
                'no_auto_scheduling': '🤖',
                'no_conan': '🚫',
                'no_together': '👥'
            };
            return icons[ruleType] || '📋';
        }

        function getRuleTitle(ruleType) {
            const titles = {
                'no_auto_scheduling': 'לא לשבץ באוטומטי',
                'no_conan': 'לא לשבץ ככונן',
                'no_together': 'לא לעבוד יחד'
            };
            return titles[ruleType] || 'חוק לא ידוע';
        }
    </script>
</body>
</html>
