<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ניהול אילוצים - סיגלית</title>
  <script src="jewish-holidays-service.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    body { font-family: 'Heebo', Arial, sans-serif; background: #f8fafd;}
    .container { max-width: 950px; margin: 36px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 18px #e4e6eb44; padding: 34px;}
    h2 { color: #3084bb;}
    .tab-bar { display: flex; gap: 10px; margin-bottom: 24px;}
    .tab-btn { padding: 8px 22px; border-radius: 7px 7px 0 0; background: #e3f1fb; color: #2460b2; font-size: 16px; border: none; cursor: pointer;}
    .tab-btn.active { background: #4891ca; color: #fff; font-weight: bold;}
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 8px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    th, td { 
      border: 1px solid #e5e7eb; 
      padding: 12px 16px; 
      text-align: right;
      vertical-align: middle;
    }
    
    th { 
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }
    
    tr:hover {
      background: #f9fafb;
    }
    
    /* Hide empty hour columns when not needed */
    .hour-column {
      display: none;
    }
    
    /* Improve note column */
    .note-column {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Improve action buttons layout */
    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }
    
    .action-buttons .btn {
      padding: 6px 12px;
      font-size: 12px;
      min-width: 60px;
    }
    
    /* Improve constraint tags */
    .constraint-tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-align: center;
      min-width: 50px;
      white-space: nowrap;
    }
    
    /* Constraint Summary Card Styles */
    .constraint-info-header {
      margin-bottom: 20px;
    }
    
    .constraint-summary-card {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
    }
    
    .constraint-summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
    }
    
    .summary-icon {
      font-size: 32px;
      flex-shrink: 0;
    }
    
    .summary-content {
      flex: 1;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }
    
    .summary-month {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 8px;
    }
    
    .summary-count {
      font-size: 24px;
      font-weight: 800;
      color: #0f172a;
    }
    
    .summary-count.at-limit {
      color: #dc2626;
    }
    
    .limit-warning {
      font-size: 14px;
      color: #dc2626;
      font-weight: 600;
    }
    
    .filter-status {
      font-size: 13px;
      color: #64748b;
      margin-top: 8px;
      padding: 4px 8px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 6px;
      display: inline-block;
    }
    
    .summary-progress {
      flex-shrink: 0;
      width: 120px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #3b82f6);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .summary-stats {
      display: flex;
      gap: 16px;
      flex-shrink: 0;
    }
    
    .stat-item {
      text-align: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      border: 1px solid rgba(226, 232, 240, 0.5);
    }
    
    .stat-label {
      display: block;
      font-size: 11px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      display: block;
      font-size: 20px;
      font-weight: 800;
      color: #0f172a;
      margin-top: 4px;
    }
    
    /* Improve table responsiveness */
    @media (max-width: 768px) {
      .hour-column {
        display: none;
      }
      
      .note-column {
        max-width: 120px;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 4px;
      }
      
      .action-buttons .btn {
        min-width: 50px;
        font-size: 11px;
        padding: 4px 8px;
      }
      
      .constraint-summary-card {
        flex-direction: column;
        gap: 16px;
        padding: 20px;
        text-align: center;
      }
      
      .summary-stats {
        justify-content: center;
      }
      
      .summary-progress {
        width: 100%;
        max-width: 200px;
      }
    }
    .btn { background: #4891ca; color: #fff; padding: 6px 17px; border: none; border-radius: 8px; cursor: pointer;}
    .btn:hover { background: #3077b8;}
    .modal { display: none; position:fixed; top:0;right:0;left:0;bottom:0; background:#0004; z-index:99; align-items:center; justify-content:center;}
    .modal .form-content {background:#fff;padding:22px 34px;max-width:400px;border-radius:15px;box-shadow:0 2px 20px #356aad44;}
    .status-approved { 
      color: #16a34a; 
      font-weight: 600;
      background: #f0fdf4;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #bbf7d0;
    }
    
    .status-pending { 
      color: #ca8a04; 
      font-weight: 600;
      background: #fefce8;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #fef08a;
    }
    
    .status-declined { 
      color: #dc2626; 
      font-weight: 600;
      background: #fef2f2;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #fecaca;
    }
    .vacation-constraint { background: #f0f8ff !important; }
    .vacation-constraint td { color: #2e7d32; }
    
    /* Month Navigation Styles */
    .month-nav {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .month-nav button {
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .month-nav button:hover {
      transform: scale(1.1);
    }
    
    .month-display {
      font-weight: bold;
      font-size: 16px;
      min-width: 120px;
      text-align: center;
      padding: 8px 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    .today-btn {
      background: #28a745 !important;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .today-btn:hover {
      background: #218838 !important;
    }
    
    /* Guide Filter Styles */
    .guide-filter-section {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .guide-filter-section label {
      font-weight: bold;
      color: #495057;
      white-space: nowrap;
    }
    
    .guide-filter-section select {
      padding: 6px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      min-width: 150px;
      background: white;
      cursor: pointer;
    }
    
    .guide-filter-section select:focus {
      outline: none;
      border-color: #4891ca;
      box-shadow: 0 0 0 2px rgba(72, 145, 202, 0.2);
    }
    
    .clear-filter-btn {
      background: #6c757d !important;
      color: white;
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .clear-filter-btn:hover {
      background: #5a6268 !important;
    }
    
    .filter-active {
      background: #e3f2fd !important;
      border-color: #2196f3 !important;
    }
    
    /* Bulk Operations Styles */
    .bulk-operations-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .bulk-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .bulk-checkbox-label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: bold;
      color: #495057;
    }

    .bulk-checkbox-label input {
      width: 18px;
      height: 18px;
      accent-color: #4891ca; /* Customize checkbox color */
    }

    .selected-count {
      font-weight: bold;
      color: #4891ca;
    }

    .bulk-delete-btn {
      background: #d03d3d;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .bulk-delete-btn:hover {
      background: #c03939;
    }

    .bulk-delete-btn:disabled {
      background: #e0e0e0;
      color: #888;
      cursor: not-allowed;
    }
    
    @media (max-width: 700px) {
      .container { max-width: 99%; padding: 7px;}
      table, th, td { font-size: 15px;}
      .tab-bar { flex-direction: column; gap: 4px;}
      .month-nav { 
        flex-direction: column; 
        gap: 8px; 
        margin-top: 10px;
      }
      .month-display { min-width: 100px; }
      .guide-filter-section {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .guide-filter-section select {
        min-width: auto;
        width: 100%;
      }
      .bulk-operations-section {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .bulk-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
    
    /* Modern Modal Styles */
    .modal.modern-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    
    .modern-modal {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 0 24px;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 24px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      margin: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      background: #f5f5f5;
      color: #333;
    }
    
    /* Modern Form Styles */
    .modern-form {
      padding: 0 24px 24px 24px;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .label-icon {
      color: #6b7280;
    }
    
    .modern-select,
    .modern-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
      color: #374151;
    }
    
    .modern-select:focus,
    .modern-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .modern-select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 40px;
    }
    
    .modern-textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    /* Date Input Group */
    .date-input-group {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-width: 0; /* Prevent flex item overflow */
      width: 100%;
    }
    
    .date-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .date-picker-btn {
      position: absolute;
      right: 12px;
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .date-picker-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    /* Add extra padding to inputs with date picker buttons */
    .date-input-wrapper .modern-input {
      padding-right: 48px;
      min-width: 0; /* Prevent input overflow */
      overflow: hidden; /* Hide any overflow */
      width: 100%;
    }
    
    /* Date Range Styles */
    .date-range-inputs {
      margin-top: 16px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    
    .date-range-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
    }
    
    /* Responsive design for date range */
    @media (max-width: 768px) {
      .date-range-row {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }
    
    @media (max-width: 480px) {
      .date-range-inputs {
        padding: 16px;
      }
      
      .date-range-row {
        gap: 16px;
      }
    }
    
    .date-range-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 6px;
      display: block;
      white-space: nowrap; /* Prevent label wrapping */
    }
    
    /* Ensure proper spacing in date range inputs */
    .date-range-inputs .date-input-group {
      margin-bottom: 8px;
    }
    
    .date-range-inputs .date-input-group:last-child {
      margin-bottom: 0;
    }
    
    /* Checkbox Styles */
    .checkbox-label {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modern-checkbox {
      display: none;
    }
    
    .checkmark {
      position: relative;
      display: inline-block;
      width: 20px;
      height: 20px;
      background: white;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      margin-right: 8px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .modern-checkbox:checked + .checkmark {
      background: #3b82f6;
      border-color: #3b82f6;
    }
    
    .modern-checkbox:checked + .checkmark::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 2px;
      width: 6px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    
    /* Form Info */
    .form-info {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 16px;
      background: #eff6ff;
      border-radius: 12px;
      border: 1px solid #dbeafe;
      margin-bottom: 24px;
      font-size: 13px;
      color: #1e40af;
      line-height: 1.5;
    }
    
    .info-icon {
      color: #3b82f6;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    /* Form Actions */
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      justify-content: center;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    
    .btn-secondary:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }
    
    /* Date Picker Styles */
    .date-picker {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      padding: 20px;
      z-index: 1001;
      min-width: 320px;
      border: 1px solid #e5e7eb;
      margin-top: 8px;
    }
    
    .date-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .date-picker-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
    }
    
    .date-picker-nav {
      display: flex;
      gap: 8px;
    }
    
    .date-picker-nav-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      min-height: 32px;
    }
    
    .date-picker-nav-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .date-picker-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .date-picker-weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      padding: 10px 6px;
      min-height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .date-picker-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    
    .date-picker-day {
      text-align: center;
      padding: 10px 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      color: #374151;
      min-height: 36px;
      min-width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    
    .date-picker-day:hover {
      background: #f3f4f6;
    }
    
    .date-picker-day.selected {
      background: #3b82f6;
      color: white;
    }
    
    .date-picker-day.other-month {
      color: #d1d5db;
    }
    
    .date-picker-day.today {
      background: #fef3c7;
      color: #92400e;
      font-weight: 600;
    }
    
    .date-picker-day.has-holiday {
      border: 2px solid #d97706;
      background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
    }
    
    .date-picker-day {
      position: relative;
      flex-direction: column;
      gap: 2px;
    }
    
    .day-number {
      flex-shrink: 0;
    }
    
    .holiday-indicator {
      font-size: 10px;
      line-height: 1;
      position: absolute;
      top: 2px;
      right: 2px;
      z-index: 1;
    }
    
    .date-picker-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .date-picker-footer-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      min-width: 60px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .date-picker-footer-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .date-picker-footer-btn.primary {
      background: #3b82f6;
      color: white;
    }
    
    .date-picker-footer-btn.primary:hover {
      background: #2563eb;
    }
    
    /* Responsive design for date picker */
    @media (max-width: 480px) {
      .date-picker {
        min-width: 280px;
        padding: 16px;
        left: -20px;
      }
      
      .date-picker-day {
        min-height: 32px;
        min-width: 32px;
        padding: 8px 4px;
        font-size: 13px;
      }
      
      .date-picker-weekday {
        padding: 8px 4px;
        font-size: 11px;
      }
    }
    
    /* Constraint Tags and Buttons */
.constraint-tag {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
  text-align: center;
  min-width: 60px;
}

.constraint-tag-monthly {
  background-color: #ffc107;
  color: #212529;
}

.constraint-tag-fixed {
  background-color: #17a2b8;
  color: white;
}

.constraint-tag-vacation {
  background-color: #28a745;
  color: white;
}

.btn-edit {
  background-color: #007bff;
  color: white;
  margin-right: 5px;
}

.btn-delete {
  background-color: #dc3545;
  color: white;
}

.btn-edit:hover {
  background-color: #0056b3;
}

.btn-delete:hover {
  background-color: #c82333;
}

/* Monthly Calendar View Styles */
    .monthly-calendar {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-top: 20px;
    }
    
    .calendar-header {
      background: #4891ca;
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .calendar-header h3 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: #e9ecef;
    }
    
    .calendar-weekday {
      background: #f8f9fa;
      padding: 16px 12px;
      text-align: center;
      font-weight: 600;
      color: #495057;
      border-bottom: 1px solid #dee2e6;
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .calendar-day {
      background: white;
      padding: 16px 12px;
      min-height: 100px;
      border: 1px solid #e9ecef;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }
    
    .calendar-day:hover {
      background: #f8f9fa;
      transform: scale(1.02);
    }
    
    .calendar-day.other-month {
      background: #f8f9fa;
      color: #adb5bd;
    }
    
    .calendar-day.today {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    
    .calendar-day.has-constraint {
      background: #fff3cd;
      border-color: #ffc107;
    }
    
    .calendar-day.has-fixed {
      background: #d1ecf1;
      border-color: #17a2b8;
    }
    
    .calendar-day.has-vacation {
      background: #d4edda;
      border-color: #28a745;
    }
    
    .calendar-day.has-holiday {
      background: linear-gradient(135deg, #fff7ed, #fed7aa);
      border-color: #d97706;
    }
    
    .calendar-day.has-multiple {
      background: linear-gradient(45deg, #fff3cd 25%, #d1ecf1 25%, #d1ecf1 50%, #d4edda 50%, #d4edda 75%, #fff3cd 75%);
      border-color: #6c757d;
    }
    
    .day-number {
      font-weight: 600;
      color: #495057;
      margin-bottom: 4px;
    }
    
    .constraint-indicator {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      margin: 1px;
      display: inline-block;
      color: white;
      font-weight: 500;
    }
    
    .constraint-indicator.monthly {
      background: #ffc107;
      color: #212529;
    }
    
    .constraint-indicator.fixed {
      background: #17a2b8;
    }
    
    .constraint-indicator.vacation {
      background: #28a745;
    }
    
    .constraint-indicator.holiday {
      background: #d97706;
      color: white;
    }
    
    .holiday-title {
      font-size: 10px;
      color: #d97706;
      font-weight: 600;
      text-align: center;
      margin: 2px 0;
      line-height: 1.2;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
    <div id="main-header"></div>
<div class="container">
  <h2>ניהול אילוצים</h2>
  <div class="tab-bar">
    <button class="tab-btn active" id="tab-monthly" onclick="switchTab('monthly')">אילוצים חודשיים</button>
    <button class="tab-btn" id="tab-fixed" onclick="switchTab('fixed')">אילוצים קבועים</button>
    <button class="tab-btn" id="tab-vacation" onclick="switchTab('vacation')">חופשות</button>
    <button class="tab-btn" id="tab-monthly-view" onclick="switchTab('monthly-view')">תצוגה חודשית</button>
  </div>
  <div id="month-indicator" style="text-align: center; margin-bottom: 15px; font-size: 18px; color: #666; font-weight: 500;"></div>

  <!-- אילוצים חודשיים -->
  <div id="monthly-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <button class="btn" onclick="openConstraintForm()">הוסף אילוץ חודשי</button>
      <div class="month-nav">
        <button class="btn" style="background: #6c757d;" onclick="previousMonth()">◀</button>
        <span id="current-month-display" class="month-display"></span>
        <button class="btn" style="background: #6c757d;" onclick="nextMonth()">▶</button>
        <button class="btn today-btn" onclick="goToCurrentMonth()">היום</button>
      </div>
    </div>
    
    <!-- Guide Filter -->
    <div class="guide-filter-section" id="guide-filter-container">
      <label>סנן לפי מדריך:</label>
      <select id="guide-filter" onchange="filterConstraints()">
        <option value="">כל המדריכים</option>
      </select>
      <button class="clear-filter-btn" onclick="clearGuideFilter()">נקה סינון</button>
    </div>
    
    <!-- Bulk Operations -->
    <div class="bulk-operations-section" id="bulk-operations-container">
      <div class="bulk-controls">
        <label class="bulk-checkbox-label">
          <input type="checkbox" id="select-all-constraints" onchange="toggleAllConstraints()">
          <span>בחר הכל</span>
        </label>
        <span id="selected-count" class="selected-count">0 נבחרו</span>
        <button id="bulk-delete-btn" class="bulk-delete-btn" onclick="bulkDeleteConstraints()" disabled>
          מחק נבחרים (<span id="delete-count">0</span>)
        </button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width: 50px;">
            <input type="checkbox" id="header-checkbox" onchange="toggleAllConstraints()">
          </th>
          <th>שם מדריך</th>
          <th>סוג</th>
          <th>תאריך</th>
          <th class="hour-column">משעה</th>
          <th class="hour-column">עד שעה</th>
          <th>הערה</th>
          <th style="width: 140px;">פעולות</th>
        </tr>
      </thead>
      <tbody id="constraints-tbody">
        <tr><td colspan="8" style="text-align:center; padding: 40px;">טוען...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- אילוצים קבועים -->
  <div id="fixed-section" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <button class="btn" onclick="openFixedForm()" id="addFixedBtn" style="display:none;">הוסף אילוץ קבוע</button>
      <div class="guide-filter-section" id="fixed-guide-filter-container">
        <label>סנן לפי מדריך:</label>
        <select id="fixed-guide-filter" onchange="filterFixedConstraints()">
          <option value="">כל המדריכים</option>
        </select>
        <button class="clear-filter-btn" onclick="clearFixedGuideFilter()">נקה סינון</button>
      </div>
    </div>
    
    <!-- Fixed Constraints Bulk Operations -->
    <div class="bulk-operations-section" id="fixed-bulk-operations-container">
      <div class="bulk-controls">
        <label class="bulk-checkbox-label">
          <input type="checkbox" id="select-all-fixed" onchange="toggleAllFixedConstraints()">
          <span>בחר הכל</span>
        </label>
        <span id="fixed-selected-count" class="selected-count">0 נבחרו</span>
        <button id="fixed-bulk-delete-btn" class="bulk-delete-btn" onclick="bulkDeleteFixedConstraints()" disabled>
          מחק נבחרים (<span id="fixed-delete-count">0</span>)
        </button>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th style="width: 50px;">
            <input type="checkbox" id="fixed-header-checkbox" onchange="toggleAllFixedConstraints()">
          </th>
          <th>שם מדריך</th>
          <th>סוג</th>
          <th>יום בשבוע</th>
          <th class="hour-column">משעה</th>
          <th class="hour-column">עד שעה</th>
          <th>הערה</th>
          <th style="width: 140px;">פעולות</th>
        </tr>
      </thead>
      <tbody id="fixed-tbody">
        <tr><td colspan="8" style="text-align:center;">טוען...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- לשונית חופשות -->
  <div id="vacation-section" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <button class="btn" onclick="openVacationForm()">הגש בקשת חופשה</button>
      <div class="guide-filter-section" id="vacation-guide-filter-container">
        <label>סנן לפי מדריך:</label>
        <select id="vacation-guide-filter" onchange="filterVacations()">
          <option value="">כל המדריכים</option>
        </select>
        <button class="clear-filter-btn" onclick="clearVacationGuideFilter()">נקה סינון</button>
      </div>
    </div>
    
    <!-- Vacations Bulk Operations -->
    <div class="bulk-operations-section" id="vacation-bulk-operations-container">
      <div class="bulk-controls">
        <label class="bulk-checkbox-label">
          <input type="checkbox" id="select-all-vacations" onchange="toggleAllVacations()">
          <span>בחר הכל</span>
        </label>
        <span id="vacation-selected-count" class="selected-count">0 נבחרו</span>
        <button id="vacation-bulk-delete-btn" class="bulk-delete-btn" onclick="bulkDeleteVacations()" disabled>
          מחק נבחרים (<span id="vacation-delete-count">0</span>)
        </button>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th style="width: 50px;">
            <input type="checkbox" id="vacation-header-checkbox" onchange="toggleAllVacations()">
          </th>
          <th>שם מדריך</th>
          <th>סוג</th>
          <th>מתאריך</th>
          <th>עד תאריך</th>
          <th>הערה</th>
          <th>סטטוס</th>
          <th>הערת רכז</th>
          <th style="width: 140px;">פעולות</th>
        </tr>
      </thead>
      <tbody id="vacation-tbody">
        <tr><td colspan="9" style="text-align:center;">טוען...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Monthly View Section -->
  <div id="monthly-view-section" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div class="guide-filter-section">
        <label>בחר מדריך:</label>
        <select id="monthly-view-guide" onchange="loadMonthlyView()">
          <option value="">בחר מדריך...</option>
        </select>
      </div>
      <div class="month-nav">
        <button class="btn" style="background: #6c757d;" onclick="previousMonthView()">◀</button>
        <span id="monthly-view-month-display" class="month-display"></span>
        <button class="btn" style="background: #6c757d;" onclick="nextMonthView()">▶</button>
        <button class="btn today-btn" onclick="goToCurrentMonthView()">היום</button>
      </div>
    </div>
    
    <div id="monthly-calendar-container">
      <!-- Calendar will be rendered here -->
    </div>
    
    <!-- Calendar Legend -->
    <div class="calendar-legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #ffc107;"></div>
        <span>אילוצים חודשיים</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #17a2b8;"></div>
        <span>אילוצים קבועים</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #28a745;"></div>
        <span>חופשות</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #d97706;"></div>
        <span>חגים יהודיים</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #6c757d;"></div>
        <span>משולב</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal for adding monthly constraint -->
<div id="constraintModal" class="modal" style="display: none;">
  <div class="modal-content modern-modal">
    <div class="modal-header">
      <h3 class="modal-title">הוסף אילוץ חודשי</h3>
      <button class="close-btn" onclick="closeConstraintForm()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    
    <form id="constraintForm" class="modern-form">
      <div class="form-group">
        <label class="form-label">
          <svg class="label-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          מדריך
        </label>
        <select id="constraintGuide" class="form-select modern-select" required>
          <option value="">בחר מדריך...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">
          <svg class="label-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 2V5M16 2V5M3.5 4H20.5C21.3284 4 22 4.67157 22 5.5V19.5C22 20.3284 21.3284 21 20.5 21H3.5C2.67157 21 2 20.3284 2 19.5V5.5C2 4.67157 2.67157 4 3.5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 10H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          תאריך
        </label>
        <div class="date-input-group">
          <div class="date-input-wrapper">
            <input type="text" id="constraintDate" class="form-input modern-input" placeholder="בחר תאריך" readonly required onclick="openDatePicker()">
            <button type="button" class="date-picker-btn" onclick="openDatePicker()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 2V5M16 2V5M3.5 4H20.5C21.3284 4 22 4.67157 22 5.5V19.5C22 20.3284 21.3284 21 20.5 21H3.5C2.67157 21 2 20.3284 2 19.5V5.5C2 4.67157 2.67157 4 3.5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 10H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label checkbox-label">
          <input type="checkbox" id="dateRangeCheckbox" class="modern-checkbox" onchange="toggleDateRange()">
          <span class="checkmark"></span>
          <svg class="label-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 2V5M16 2V5M3.5 4H20.5C21.3284 4 22 4.67157 22 5.5V19.5C22 20.3284 21.3284 21 20.5 21H3.5C2.67157 21 2 20.3284 2 19.5V5.5C2 4.67157 2.67157 4 3.5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 10H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          טווח תאריכים
        </label>
        <div id="dateRangeInputs" class="date-range-inputs" style="display: none;">
          <div class="date-range-row">
            <div class="date-input-group">
              <label class="date-range-label">מתאריך</label>
              <div class="date-input-wrapper">
                <input type="text" id="dateStart" class="form-input modern-input" placeholder="תאריך התחלה" readonly>
                <button type="button" class="date-picker-btn" onclick="openDatePicker('start')">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 2V5M16 2V5M3.5 4H20.5C21.3284 4 22 4.67157 22 5.5V19.5C22 20.3284 21.3284 21 20.5 21H3.5C2.67157 21 2 20.3284 2 19.5V5.5C2 4.67157 2.67157 4 3.5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 10H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="date-input-group">
              <label class="date-range-label">עד תאריך</label>
              <div class="date-input-wrapper">
                <input type="text" id="dateEnd" class="form-input modern-input" placeholder="תאריך סיום" readonly>
                <button type="button" class="date-picker-btn" onclick="openDatePicker('end')">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 2V5M16 2V5M3.5 4H20.5C21.3284 4 22 4.67157 22 5.5V19.5C22 20.3284 21.3284 21 20.5 21H3.5C2.67157 21 2 20.3284 2 19.5V5.5C2 4.67157 2.67157 4 3.5 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 10H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">
          <svg class="label-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          הערה
        </label>
        <textarea id="constraintNote" class="form-textarea modern-textarea" placeholder="הוסף הערה או פרטים נוספים..." rows="3"></textarea>
      </div>
      
      <div class="form-info">
        <svg class="info-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        ניתן לבחור תאריך בודד או לסמן טווח תאריכים. יווצר אילוץ לכל יום בטווח.
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeConstraintForm()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ביטול
        </button>
        <button type="submit" class="btn btn-primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H16L21 8V19C21 20.1046 20.1046 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          שמור
        </button>
      </div>
    </form>
  </div>
</div>

<!-- טופס הוספת/עריכת אילוץ קבוע -->
<div class="modal" id="fixed-form-modal">
  <div class="form-content">
    <h3 id="fixed-form-title">הוסף אילוץ קבוע</h3>
    <form id="fixed-form">
      <div>
        <label>מדריך:
          <select id="fixed-guideId"></select>
        </label>
      </div>
      <div>
        <label>יום בשבוע:
          <select id="weekday">
            <option value="0">ראשון</option>
            <option value="1">שני</option>
            <option value="2">שלישי</option>
            <option value="3">רביעי</option>
            <option value="4">חמישי</option>
            <option value="5">שישי</option>
            <option value="6">שבת</option>
          </select>
        </label>
      </div>
      <div>
        <label>משעה: <input id="fixed-hourStart" type="time"></label>
      </div>
      <div>
        <label>עד שעה: <input id="fixed-hourEnd" type="time"></label>
      </div>
      <div>
        <label>הערה: <input id="fixed-note" maxlength="50"></label>
      </div>
      <div style="margin-top:10px;text-align:left;">
        <button class="btn" type="submit">שמור</button>
        <button type="button" class="btn" style="background:#ccc;color:#222;" onclick="closeFixedForm()">X</button>
      </div>
    </form>
  </div>
</div>

<!-- טופס בקשת חופשה -->
<div class="modal" id="vacation-form-modal">
  <div class="form-content">
    <h3 id="vacation-form-title">הגש בקשת חופשה</h3>
    <form id="vacation-form">
      <div>
        <label>מדריך:
          <select id="vac-guideId"></select>
        </label>
      </div>
      <div>
        <label>מתאריך: <input id="vac-dateStart" type="date" required></label>
      </div>
      <div>
        <label>עד תאריך: <input id="vac-dateEnd" type="date" required></label>
      </div>
      <div>
        <label>הערה: <input id="vac-note" maxlength="50"></label>
      </div>
      <div style="margin-top:10px;text-align:left;">
        <button class="btn" type="submit">שלח</button>
        <button type="button" class="btn" style="background:#ccc;color:#222;" onclick="closeVacationForm()">X</button>
      </div>
    </form>
  </div>
</div>

<!-- טופס רכז - אישור/דחייה -->
<div class="modal" id="approve-modal">
  <div class="form-content">
    <h3 id="approve-form-title">אשר/דחה חופשה</h3>
    <form id="approve-form">
      <div style="margin-bottom:7px;">
        <label>סטטוס:
          <select id="approve-status">
            <option value="approved">מאושר</option>
            <option value="declined">נדחה</option>
          </select>
        </label>
      </div>
      <div>
        <label>הערת רכז: <input id="approve-note" maxlength="60"></label>
      </div>
      <div style="margin-top:10px;text-align:left;">
        <button class="btn" type="submit">שמור</button>
        <button type="button" class="btn" style="background:#ccc;color:#222;" onclick="closeApproveModal()">X</button>
      </div>
    </form>
  </div>
</div>

<!-- Beautiful Date Picker Component -->
<div id="datePicker" class="date-picker" style="display: none;">
  <div class="date-picker-header">
    <div class="date-picker-title" id="datePickerTitle">September 2025</div>
    <div class="date-picker-nav">
      <button class="date-picker-nav-btn" onclick="changeMonth(-1)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button class="date-picker-nav-btn" onclick="changeMonth(1)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div class="date-picker-weekdays">
    <div class="date-picker-weekday">S</div>
    <div class="date-picker-weekday">M</div>
    <div class="date-picker-weekday">T</div>
    <div class="date-picker-weekday">W</div>
    <div class="date-picker-weekday">T</div>
    <div class="date-picker-weekday">F</div>
    <div class="date-picker-weekday">S</div>
  </div>
  
  <div class="date-picker-days" id="datePickerDays">
    <!-- Days will be populated by JavaScript -->
  </div>
  
  <div class="date-picker-footer">
    <button class="date-picker-footer-btn" onclick="clearDate()">Clear</button>
    <button class="date-picker-footer-btn primary" onclick="selectToday()">Today</button>
  </div>
</div>

<script>
const weekdays = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
    
    // פונקציה לקבלת הנתונים הנוכחיים
    function getCurrentUserData() {
        return {
            role: localStorage.getItem('role'),
            guideId: Number(localStorage.getItem('guideId')),
            name: localStorage.getItem('name')
        };
    }
    
    // בדיקה - הדפס את הנתונים לקונסול
    const userData = getCurrentUserData();
    console.log('User Data:', userData);

    // אתחול ראשוני
    document.addEventListener("DOMContentLoaded", function() {
        initializeMonthNavigation();
        renderConstraints();
        renderFixedConstraints();
        renderVacations();
    });
    
    // וודא שהפונקציה renderHeaderUser נקראת אחרי שהכל נטען
    window.addEventListener('load', function() {
        console.log('Window loaded, calling renderHeaderUser...');
        setTimeout(() => {
          renderHeaderUser();
        }, 500);
    });

// --- Month Navigation ---
let currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format

function initializeMonthNavigation() {
    updateMonthDisplay();
    populateGuideFilter(); // Populate the guide filter dropdown
}

function updateMonthDisplay() {
    const monthNames = [
        "ינואר", "פברואר", "מרץ", "אפריל", "מאי", "יוני",
        "יולי", "אוגוסט", "ספטמבר", "אוקטובר", "נובמבר", "דצמבר"
    ];
    
    const [year, month] = currentMonth.split('-');
    const monthIndex = parseInt(month) - 1;
    const monthName = monthNames[monthIndex];
    const hebrewYear = parseInt(year);
    
    document.getElementById('current-month-display').textContent = `${monthName} ${hebrewYear}`;
    document.getElementById('month-indicator').textContent = `חודש נוכחי: ${monthName} ${hebrewYear}`;
}

// --- Guide Filter Functions ---
let selectedGuideFilter = ''; // Store the currently selected guide filter
let selectedFixedGuideFilter = ''; // Store the currently selected guide filter for fixed constraints
let selectedVacationGuideFilter = ''; // Store the currently selected guide filter for vacations
let selectedConstraintIds = new Set(); // Store selected constraint IDs for bulk operations

async function populateGuideFilter() {
    try {
        const guides = await fetchGuides();
        
        // Populate monthly constraints filter
        const filterSelect = document.getElementById('guide-filter');
        filterSelect.innerHTML = '<option value="">כל המדריכים</option>';
        guides.forEach(guide => {
            const option = document.createElement('option');
            option.value = guide.id;
            option.textContent = guide.name;
            filterSelect.appendChild(option);
        });
        
        // Populate fixed constraints filter
        const fixedFilterSelect = document.getElementById('fixed-guide-filter');
        fixedFilterSelect.innerHTML = '<option value="">כל המדריכים</option>';
        guides.forEach(guide => {
            const option = document.createElement('option');
            option.value = guide.id;
            option.textContent = guide.name;
            fixedFilterSelect.appendChild(option);
        });
        
        // Populate vacations filter
        const vacationFilterSelect = document.getElementById('vacation-guide-filter');
        vacationFilterSelect.innerHTML = '<option value="">כל המדריכים</option>';
        guides.forEach(guide => {
            const option = document.createElement('option');
            option.value = guide.id;
            option.textContent = guide.name;
            vacationFilterSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error populating guide filter:', error);
    }
}

function filterConstraints() {
    const filterSelect = document.getElementById('guide-filter');
    selectedGuideFilter = filterSelect.value;
    
    // Update visual feedback
    updateFilterVisualState();
    
    renderConstraints(); // Re-render with the filter applied
}

function clearGuideFilter() {
    const filterSelect = document.getElementById('guide-filter');
    filterSelect.value = '';
    selectedGuideFilter = '';
    
    // Update visual feedback
    updateFilterVisualState();
    
    renderConstraints(); // Re-render without filter
}

function updateFilterVisualState() {
    const filterContainer = document.getElementById('guide-filter-container');
    if (selectedGuideFilter) {
        filterContainer.classList.add('filter-active');
    } else {
        filterContainer.classList.remove('filter-active');
    }
}

// Fixed constraints filter functions
function filterFixedConstraints() {
    const filterSelect = document.getElementById('fixed-guide-filter');
    selectedFixedGuideFilter = filterSelect.value;
    
    // Update visual feedback
    updateFixedFilterVisualState();
    
    renderFixedConstraints(); // Re-render with the filter applied
}

function clearFixedGuideFilter() {
    const filterSelect = document.getElementById('fixed-guide-filter');
    filterSelect.value = '';
    selectedFixedGuideFilter = '';
    
    // Update visual feedback
    updateFixedFilterVisualState();
    
    renderFixedConstraints(); // Re-render without filter
}

function updateFixedFilterVisualState() {
    const filterContainer = document.getElementById('fixed-guide-filter-container');
    if (selectedFixedGuideFilter) {
        filterContainer.classList.add('filter-active');
    } else {
        filterContainer.classList.remove('filter-active');
    }
}

// Vacation filter functions
function filterVacations() {
    const filterSelect = document.getElementById('vacation-guide-filter');
    selectedVacationGuideFilter = filterSelect.value;
    
    // Update visual feedback
    updateVacationFilterVisualState();
    
    renderVacations(); // Re-render with the filter applied
}

function clearVacationGuideFilter() {
    const filterSelect = document.getElementById('vacation-guide-filter');
    filterSelect.value = '';
    selectedVacationGuideFilter = '';
    
    // Update visual feedback
    updateVacationFilterVisualState();
    
    renderVacations(); // Re-render without filter
}

function updateVacationFilterVisualState() {
    const filterContainer = document.getElementById('vacation-guide-filter-container');
    if (selectedVacationGuideFilter) {
        filterContainer.classList.add('filter-active');
    } else {
        filterContainer.classList.remove('filter-active');
    }
}

// --- Bulk Operations Functions ---
function toggleAllConstraints() {
    const headerCheckbox = document.getElementById('header-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-constraints');
    const isChecked = headerCheckbox.checked;
    
    // Update both header checkboxes
    headerCheckbox.checked = isChecked;
    selectAllCheckbox.checked = isChecked;
    
    // Select/deselect all visible constraint checkboxes
    const constraintCheckboxes = document.querySelectorAll('#constraints-tbody input[type="checkbox"]');
    constraintCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        if (isChecked) {
            selectedConstraintIds.add(parseInt(checkbox.value));
        } else {
            selectedConstraintIds.delete(parseInt(checkbox.value));
        }
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const constraintCheckboxes = document.querySelectorAll('#constraints-tbody input[type="checkbox"]:checked');
    const selectedCount = constraintCheckboxes.length;
    
    // Update the selected count display
    document.getElementById('selected-count').textContent = `${selectedCount} נבחרו`;
    document.getElementById('delete-count').textContent = selectedCount;
    
    // Update the bulk delete button state
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    bulkDeleteBtn.disabled = selectedCount === 0;
    
    // Update the selectedConstraintIds set
    selectedConstraintIds.clear();
    constraintCheckboxes.forEach(checkbox => {
        selectedConstraintIds.add(parseInt(checkbox.value));
    });
    
    // Update header checkbox state
    const headerCheckbox = document.getElementById('header-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-constraints');
    const totalCheckboxes = document.querySelectorAll('#constraints-tbody input[type="checkbox"]').length;
    
    if (selectedCount === 0) {
        headerCheckbox.checked = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === totalCheckboxes) {
        headerCheckbox.checked = true;
        selectAllCheckbox.checked = true;
    } else {
        headerCheckbox.checked = false;
        selectAllCheckbox.checked = false;
    }
}

async function bulkDeleteConstraints() {
    if (selectedConstraintIds.size === 0) {
        alert('לא נבחרו אילוצים למחיקה');
        return;
    }
    
    const confirmMessage = `האם אתה בטוח שברצונך למחוק ${selectedConstraintIds.size} אילוצים? פעולה זו אינה הפיכה.`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        const deletePromises = Array.from(selectedConstraintIds).map(id => 
            apiFetch(`/api/constraints/${id}`, { method: 'DELETE' })
        );
        
        await Promise.all(deletePromises);
        
        // Clear selection and refresh
        selectedConstraintIds.clear();
        updateSelectedCount();
        renderConstraints();
        
        alert(`נמחקו בהצלחה ${deletePromises.length} אילוצים`);
    } catch (error) {
        console.error('Error deleting constraints:', error);
        alert('שגיאה במחיקת האילוצים. אנא נסה שוב.');
    }
}

// Fixed Constraints Bulk Operations
let selectedFixedConstraintIds = new Set();

function toggleAllFixedConstraints() {
    const headerCheckbox = document.getElementById('fixed-header-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-fixed');
    const isChecked = headerCheckbox.checked;
    
    headerCheckbox.checked = isChecked;
    selectAllCheckbox.checked = isChecked;
    
    const constraintCheckboxes = document.querySelectorAll('#fixed-tbody input[type="checkbox"]');
    constraintCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        if (isChecked) {
            selectedFixedConstraintIds.add(parseInt(checkbox.value));
        } else {
            selectedFixedConstraintIds.delete(parseInt(checkbox.value));
        }
    });
    
    updateFixedSelectedCount();
}

function updateFixedSelectedCount() {
    const constraintCheckboxes = document.querySelectorAll('#fixed-tbody input[type="checkbox"]:checked');
    const selectedCount = constraintCheckboxes.length;
    
    document.getElementById('fixed-selected-count').textContent = `${selectedCount} נבחרו`;
    document.getElementById('fixed-delete-count').textContent = selectedCount;
    
    const bulkDeleteBtn = document.getElementById('fixed-bulk-delete-btn');
    bulkDeleteBtn.disabled = selectedCount === 0;
    
    selectedFixedConstraintIds.clear();
    constraintCheckboxes.forEach(checkbox => {
        selectedFixedConstraintIds.add(parseInt(checkbox.value));
    });
    
    const headerCheckbox = document.getElementById('fixed-header-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-fixed');
    const totalCheckboxes = document.querySelectorAll('#fixed-tbody input[type="checkbox"]').length;
    
    if (selectedCount === 0) {
        headerCheckbox.checked = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === totalCheckboxes) {
        headerCheckbox.checked = true;
        selectAllCheckbox.checked = true;
    } else {
        headerCheckbox.checked = false;
        selectAllCheckbox.checked = false;
    }
}

async function bulkDeleteFixedConstraints() {
    if (selectedFixedConstraintIds.size === 0) {
        alert('לא נבחרו אילוצים קבועים למחיקה');
        return;
    }
    
    const confirmMessage = `האם אתה בטוח שברצונך למחוק ${selectedFixedConstraintIds.size} אילוצים קבועים? פעולה זו אינה הפיכה.`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        const deletePromises = Array.from(selectedFixedConstraintIds).map(id => 
            apiFetch(`/api/fixed-constraints/${id}`, { method: 'DELETE' })
        );
        
        await Promise.all(deletePromises);
        
        selectedFixedConstraintIds.clear();
        updateFixedSelectedCount();
        renderFixedConstraints();
        
        alert(`נמחקו בהצלחה ${deletePromises.length} אילוצים קבועים`);
    } catch (error) {
        console.error('Error deleting fixed constraints:', error);
        alert('שגיאה במחיקת האילוצים הקבועים. אנא נסה שוב.');
    }
}

// Vacations Bulk Operations
let selectedVacationIds = new Set();

function toggleAllVacations() {
    const headerCheckbox = document.getElementById('vacation-header-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-vacations');
    const isChecked = headerCheckbox.checked;
    
    headerCheckbox.checked = isChecked;
    selectAllCheckbox.checked = isChecked;
    
    const vacationCheckboxes = document.querySelectorAll('#vacation-tbody input[type="checkbox"]');
    vacationCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        if (isChecked) {
            selectedVacationIds.add(parseInt(checkbox.value));
        } else {
            selectedVacationIds.delete(parseInt(checkbox.value));
        }
    });
    
    updateVacationSelectedCount();
}

function updateVacationSelectedCount() {
    const vacationCheckboxes = document.querySelectorAll('#vacation-tbody input[type="checkbox"]:checked');
    const selectedCount = vacationCheckboxes.length;
    
    document.getElementById('vacation-selected-count').textContent = `${selectedCount} נבחרו`;
    document.getElementById('vacation-delete-count').textContent = selectedCount;
    
    const bulkDeleteBtn = document.getElementById('vacation-bulk-delete-btn');
    bulkDeleteBtn.disabled = selectedCount === 0;
    
    selectedVacationIds.clear();
    vacationCheckboxes.forEach(checkbox => {
        selectedVacationIds.add(parseInt(checkbox.value));
    });
    
    const headerCheckbox = document.getElementById('vacation-header-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-vacations');
    const totalCheckboxes = document.querySelectorAll('#vacation-tbody input[type="checkbox"]').length;
    
    if (selectedCount === 0) {
        headerCheckbox.checked = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === totalCheckboxes) {
        headerCheckbox.checked = true;
        selectAllCheckbox.checked = true;
    } else {
        headerCheckbox.checked = false;
        selectAllCheckbox.checked = false;
    }
}

async function bulkDeleteVacations() {
    if (selectedVacationIds.size === 0) {
        alert('לא נבחרו חופשות למחיקה');
        return;
    }
    
    const confirmMessage = `האם אתה בטוח שברצונך למחוק ${selectedVacationIds.size} חופשות? פעולה זו אינה הפיכה.`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        const deletePromises = Array.from(selectedVacationIds).map(id => 
            apiFetch(`/api/vacations/${id}`, { method: 'DELETE' })
        );
        
        await Promise.all(deletePromises);
        
        selectedVacationIds.clear();
        updateVacationSelectedCount();
        renderVacations();
        
        alert(`נמחקו בהצלחה ${deletePromises.length} חופשות`);
    } catch (error) {
        console.error('Error deleting vacations:', error);
        alert('שגיאה במחיקת החופשות. אנא נסה שוב.');
    }
}

function previousMonth() {
    const [year, month] = currentMonth.split('-').map(Number);
    if (month === 1) {
        currentMonth = `${year - 1}-12`;
    } else {
        currentMonth = `${year}-${(month - 1).toString().padStart(2, '0')}`;
    }
    updateMonthDisplay();
    renderConstraints();
}

function nextMonth() {
    const [year, month] = currentMonth.split('-').map(Number);
    if (month === 12) {
        currentMonth = `${year + 1}-01`;
    } else {
        currentMonth = `${year}-${(month + 1).toString().padStart(2, '0')}`;
    }
    updateMonthDisplay();
    renderConstraints();
}

function goToCurrentMonth() {
    currentMonth = new Date().toISOString().slice(0, 7);
    updateMonthDisplay();
    renderConstraints();
}

// --- אילוצים חודשיים ---
async function fetchGuides() {
  const res = await apiFetch('/api/guides');
  return await res.json();
}
async function fetchConstraints() {
  const res = await apiFetch('/api/constraints');
  return await res.json();
}
async function renderConstraints() {
  const constraints = await fetchConstraints();
  const guides = await fetchGuides();
  const tbody = document.getElementById('constraints-tbody');
  const userData = getCurrentUserData();
  
  // Filter constraints by selected month
  let list = constraints.filter(c => c.date && c.date.startsWith(currentMonth));
  
  if (userData.role === "מדריך") {
    list = list.filter(c => c.guideId == userData.guideId);
  }

  // Apply guide filter if a guide is selected
  if (selectedGuideFilter) {
    list = list.filter(c => c.guideId == selectedGuideFilter);
  }
  
  // הצג מידע על מספר האילוצים למדריך
  let constraintInfo = "";
  if (userData.role === "מדריך") {
    const constraintCount = list.length;
    const maxConstraints = 14;
    const isAtLimit = constraintCount >= maxConstraints;
    constraintInfo = `
      <div class="constraint-summary-card guide-view">
        <div class="summary-icon">📊</div>
        <div class="summary-content">
          <div class="summary-title">אילוצים חודשיים</div>
          <div class="summary-month">${currentMonth}</div>
          <div class="summary-count ${isAtLimit ? 'at-limit' : ''}">
            ${constraintCount}/${maxConstraints}
            ${isAtLimit ? ' <span class="limit-warning">(הגעת למגבלה!)</span>' : ''}
          </div>
        </div>
        <div class="summary-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${(constraintCount / maxConstraints) * 100}%"></div>
          </div>
        </div>
      </div>
    `;
  } else {
    // Show filter status for coordinators
    const totalConstraints = constraints.filter(c => c.date && c.date.startsWith(currentMonth)).length;
    const filteredCount = list.length;
    let filterStatus = '';
    let filterIcon = '🔍';
    
    if (selectedGuideFilter) {
      const selectedGuide = guides.find(g => g.id == selectedGuideFilter);
      filterStatus = selectedGuide?.name || 'לא ידוע';
      filterIcon = '👤';
    }
    
    constraintInfo = `
      <div class="constraint-summary-card coordinator-view">
        <div class="summary-icon">📋</div>
        <div class="summary-content">
          <div class="summary-title">אילוצים חודשיים</div>
          <div class="summary-month">${currentMonth}</div>
          <div class="summary-count">
            ${filteredCount}/${totalConstraints}
          </div>
          ${filterStatus ? `<div class="filter-status">${filterIcon} מסונן לפי: ${filterStatus}</div>` : ''}
        </div>
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-label">סה"כ</span>
            <span class="stat-value">${totalConstraints}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">מוצג</span>
            <span class="stat-value">${filteredCount}</span>
          </div>
        </div>
      </div>
    `;
  }
  
  // Render constraints
  tbody.innerHTML = '';
  
  // Add or update constraint info header above the table
  let constraintInfoContainer = document.querySelector('.constraint-info-header');
  
  if (!constraintInfoContainer) {
    // Create new container if it doesn't exist
    constraintInfoContainer = document.createElement('div');
    constraintInfoContainer.className = 'constraint-info-header';
    
    // Insert the info header before the table
    const table = document.querySelector('#monthly-section table');
    table.parentNode.insertBefore(constraintInfoContainer, table);
  }
  
  // Update the content
  constraintInfoContainer.innerHTML = constraintInfo;
  
  if (!list.length) {
    tbody.innerHTML += `<tr><td colspan="8" style="text-align:center; padding: 40px; color: #6b7280;">אין אילוצים חודשיים</td></tr>`;
    // Hide bulk operations when no constraints
    document.getElementById('bulk-operations-container').style.display = 'none';
    return;
  }
  
  // Show bulk operations when there are constraints
  document.getElementById('bulk-operations-container').style.display = 'flex';
  
  list.forEach(c => {
    const g = guides.find(g => g.id == c.guideId);
    const rowClass = c.guideId == userData.guideId ? 'style="background-color: #f0f8ff;"' : '';
    
    // Create constraint type tag
    const typeTag = `<span class="constraint-tag constraint-tag-monthly">חודשי</span>`;
    
    tbody.innerHTML += `
      <tr ${rowClass}>
        <td><input type="checkbox" value="${c.id}" onchange="updateSelectedCount()"></td>
        <td>${g.name}</td>
        <td>${typeTag}</td>
        <td>${c.date}</td>
        <td class="hour-column">${c.hourStart || '-'}</td>
        <td class="hour-column">${c.hourEnd || '-'}</td>
        <td class="note-column" title="${c.note || ''}">${c.note || ''}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-edit" onclick="editConstraint(${c.id})">ערוך</button>
            <button class="btn btn-delete" onclick="deleteConstraint(${c.id})">מחק</button>
          </div>
        </td>
      </tr>
    `;
  });
  
  // Reset bulk operations state after rendering
  selectedConstraintIds.clear();
  updateSelectedCount();
}

// --- אילוצים קבועים ---
async function fetchFixedConstraints() {
  const res = await apiFetch('/api/fixed-constraints');
  return await res.json();
}
async function renderFixedConstraints() {
  const fixed = await fetchFixedConstraints();
  const guides = await fetchGuides();
  const tbody = document.getElementById('fixed-tbody');
  const userData = getCurrentUserData();
  
  // הצג/הסתר כפתור הוספת אילוץ קבוע לפי התפקיד
  const addFixedBtn = document.getElementById('addFixedBtn');
  if (addFixedBtn) {
    addFixedBtn.style.display = userData.role === "רכז" ? "inline-block" : "none";
  }
  
  // אם מדריך, הצג רק אילוצים שלו
  let list = fixed;
  if (userData.role === "מדריך") {
    list = fixed.filter(f => f.guideId == userData.guideId);
  }
  
  // Apply fixed guide filter if a guide is selected
  if (selectedFixedGuideFilter) {
    list = list.filter(f => f.guideId == selectedFixedGuideFilter);
  }

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">אין אילוצים קבועים</td></tr>`;
    // Hide bulk operations when no constraints
    document.getElementById('fixed-bulk-operations-container').style.display = 'none';
    return;
  }
  
  // Show bulk operations when there are constraints
  document.getElementById('fixed-bulk-operations-container').style.display = 'flex';
  
  tbody.innerHTML = "";
  list.forEach(c => {
    let g = guides.find(g=>g.id==c.guideId) || {name:"[לא ידוע]"};
    let actions = "";
    // רק רכז יכול לערוך/למחוק אילוצים קבועים
    if (userData.role === "רכז") {
      actions = `
        <button class="btn btn-edit" onclick="editFixed(${c.id})">ערוך</button>
        <button class="btn btn-delete" onclick="deleteFixed(${c.id})">מחק</button>
      `;
    } else {
      actions = `<span style="color:#888; font-size:0.9em;">לקריאה בלבד</span>`;
    }
    
    // Create constraint type tag
    const typeTag = `<span class="constraint-tag constraint-tag-fixed">קבוע</span>`;
    
    tbody.innerHTML += `
    <tr>
      <td><input type="checkbox" value="${c.id}" onchange="updateFixedSelectedCount()"></td>
      <td>${g.name}</td>
      <td>${typeTag}</td>
      <td>${weekdays[Number(c.weekday)]}</td>
      <td class="hour-column">${c.hourStart||"-"}</td>
      <td class="hour-column">${c.hourEnd||"-"}</td>
      <td class="note-column" title="${c.note||""}">${c.note||""}</td>
      <td>
        <div class="action-buttons">
          ${actions}
        </div>
      </td>
    </tr>`;
  });
  
  // Reset bulk operations state after rendering
  selectedFixedConstraintIds.clear();
  updateFixedSelectedCount();
}

// --- חופשות ---
async function fetchVacations() {
  const res = await apiFetch('/api/vacations');
  return await res.json();
}
async function renderVacations() {
  const vacations = await fetchVacations();
  const guides = await fetchGuides();
  const tbody = document.getElementById('vacation-tbody');
  const userData = getCurrentUserData();
  let list = vacations;
  if (userData.role === "מדריך") {
    list = vacations.filter(v=>v.guideId==userData.guideId);
  }
  
  // Apply vacation guide filter if a guide is selected
  if (selectedVacationGuideFilter) {
    list = list.filter(v => v.guideId == selectedVacationGuideFilter);
  }

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">אין חופשות</td></tr>`;
    // Hide bulk operations when no vacations
    document.getElementById('vacation-bulk-operations-container').style.display = 'none';
    return;
  }
  
  // Show bulk operations when there are vacations
  document.getElementById('vacation-bulk-operations-container').style.display = 'flex';
  
  tbody.innerHTML = "";
  list.forEach(v => {
    let g = guides.find(g=>g.id==v.guideId) || {name:"[לא ידוע]"};
    let statusClass = "status-" + (v.status || "pending");
    let statusLabel = v.status === "approved" ? "מאושר" :
                      v.status === "declined" ? "נדחה" : "ממתין";
    let actions = "";
if (userData.role === "רכז" && v.status === "pending") {
  actions += `<button class="btn btn-edit" onclick="approveVacation(${v.id})">אשר/דחה</button> `;
}
if (userData.role === "רכז") {
  actions += `<button class="btn btn-delete" onclick="deleteVacation(${v.id})">מחק</button>`;
    }
    
    // Create constraint type tag
    const typeTag = `<span class="constraint-tag constraint-tag-vacation">חופשה</span>`;
    
    tbody.innerHTML += `
    <tr>
      <td><input type="checkbox" value="${v.id}" onchange="updateVacationSelectedCount()"></td>
      <td>${g.name}</td>
      <td>${typeTag}</td>
      <td>${v.dateStart}</td>
      <td>${v.dateEnd}</td>
      <td class="note-column" title="${v.note||""}">${v.note||""}</td>
      <td class="${statusClass}">${statusLabel}</td>
      <td class="note-column" title="${v.responseNote||""}">${v.responseNote||""}</td>
      <td>
        <div class="action-buttons">
          ${actions}
        </div>
      </td>
    </tr>`;
  });
  
  // Reset bulk operations state after rendering
  selectedVacationIds.clear();
  updateVacationSelectedCount();
}

// --- טאבים ---
function switchTab(tab) {
  document.getElementById('monthly-section').style.display = tab === 'monthly' ? '' : 'none';
  document.getElementById('fixed-section').style.display = tab === 'fixed' ? '' : 'none';
  document.getElementById('vacation-section').style.display = tab === 'vacation' ? '' : 'none';
  document.getElementById('monthly-view-section').style.display = tab === 'monthly-view' ? '' : 'none';
  document.getElementById('tab-monthly').classList.toggle('active', tab === 'monthly');
  document.getElementById('tab-fixed').classList.toggle('active', tab === 'fixed');
  document.getElementById('tab-vacation').classList.toggle('active', tab === 'vacation');
  document.getElementById('tab-monthly-view').classList.toggle('active', tab === 'monthly-view');
  
  // Refresh the appropriate section when switching tabs
  if (tab === 'monthly') {
    renderConstraints();
  } else if (tab === 'fixed') {
    renderFixedConstraints();
  } else if (tab === 'vacation') {
    renderVacations();
  } else if (tab === 'monthly-view') {
    initializeMonthlyView();
  }
}

function toggleDateRange() {
  const checked = document.getElementById('dateRangeCheckbox').checked;
  const dateRangeInputs = document.getElementById('dateRangeInputs');
  const singleDateInput = document.getElementById('constraintDate');
  
  if (checked) {
    // Show date range inputs
    dateRangeInputs.style.display = 'block';
    // Clear single date when switching to range
    singleDateInput.value = '';
    singleDateInput.disabled = true;
  } else {
    // Hide date range inputs
    dateRangeInputs.style.display = 'none';
    // Clear range dates and re-enable single date
    document.getElementById('dateStart').value = '';
    document.getElementById('dateEnd').value = '';
    singleDateInput.disabled = false;
  }
}
// --- טופס אילוץ חודשי ---
function openConstraintForm(constraint=null) {
  document.getElementById('constraintModal').style.display='flex';
  
  // Populate guide dropdown
  fetchGuides().then(guides => {
    const select = document.getElementById('constraintGuide');
    select.innerHTML = '<option value="">בחר מדריך...</option>';
    const userData = getCurrentUserData();
    
    guides.forEach(g => {
      let selected = (constraint && g.id == constraint.guideId) || 
                    (userData.role === "מדריך" && g.id == userData.guideId) ? "selected" : "";
      select.innerHTML += `<option value="${g.id}" ${selected}>${g.name}</option>`;
    });
    
    select.disabled = (userData.role === "מדריך");
  });
  
  // Set default date to current month if no constraint is being edited
  let defaultDate = '';
  if (constraint) {
    defaultDate = constraint.date;
  } else {
    // Set to first day of current month
    defaultDate = currentMonth + '-01';
  }
  
  document.getElementById('constraintDate').value = defaultDate;
  document.getElementById('constraintNote').value = constraint ? constraint.note || '' : '';
  document.getElementById('dateRangeCheckbox').checked = false;
  
  // Initialize date range state
  document.getElementById('dateStart').value = '';
  document.getElementById('dateEnd').value = '';
  document.getElementById('dateRangeInputs').style.display = 'none';
  document.getElementById('constraintDate').disabled = false;
  
  document.getElementById('constraintForm').onsubmit = async function(e) {
    e.preventDefault();
    const userData = getCurrentUserData();
    
    // Validate form
    const guideId = Number(document.getElementById('constraintGuide').value);
    const note = document.getElementById('constraintNote').value;
    const isRange = document.getElementById('dateRangeCheckbox').checked;
    
    if (!guideId) {
      alert('יש לבחור מדריך');
      return;
    }
    
    let days = [];
    
    if (isRange) {
      // Use period start and end dates for range constraints
      const periodStart = document.getElementById('dateStart').value;
      const periodEnd = document.getElementById('dateEnd').value;
      
      if (!periodStart || !periodEnd) {
        alert('יש לבחור תאריך התחלה ותאריך סיום לטווח');
        return;
      }
      
      const start = new Date(periodStart);
      const end = new Date(periodEnd);
      if (start > end) {
        alert('תאריך ההתחלה חייב להיות לפני תאריך הסיום');
        return;
      }
      
      // Generate all dates in range
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        days.push(new Date(d).toISOString().split('T')[0]);
      }
    } else {
      // Use single date field for single date constraints
      const singleDate = document.getElementById('constraintDate').value;
      if (!singleDate) {
        alert('יש לבחור תאריך');
        return;
      }
      days = [singleDate];
    }
    
    try {
      console.log('Creating constraints for days:', days);
      console.log('Guide ID:', guideId, 'Note:', note);
      
      // Create constraints for each day
      const promises = days.map(date => 
        apiFetch('/api/constraints', {
          method: 'POST',
          body: JSON.stringify({
            guideId: guideId,
            date: date,
            note: note
          })
        })
      );
      
      await Promise.all(promises);
      
      closeConstraintForm();
      renderConstraints();
      alert(`נוצרו ${days.length} אילוצים בהצלחה`);
    } catch (error) {
      console.error('Error creating constraints:', error);
      alert('שגיאה ביצירת האילוצים. אנא נסה שוב.');
    }
  };
}
function closeConstraintForm() { document.getElementById('constraintModal').style.display='none'; }
async function editConstraint(id) {
  const constraints = await fetchConstraints();
  const c = constraints.find(x=>x.id==id);
  if (c) openConstraintForm(c);
}
async function deleteConstraint(id) {
  if (!confirm("למחוק את האילוץ?")) return;
  await apiFetch('/api/constraints/'+id, {method:'DELETE'});
  renderConstraints();
}

// --- טופס אילוץ קבוע (רק רכז) ---
function openFixedForm(fixed=null) {
  const userData = getCurrentUserData();
  if (userData.role==="מדריך") return;
  document.getElementById('fixed-form-modal').style.display='flex';
  document.getElementById('fixed-form-title').textContent = fixed ? 'ערוך אילוץ קבוע' : 'הוסף אילוץ קבוע';
  fetchGuides().then(guides=>{
    let select = document.getElementById('fixed-guideId');
    select.innerHTML = "";
    guides.forEach(g=>{
      let selected = (fixed && g.id==fixed.guideId) ? "selected" : "";
      select.innerHTML += `<option value="${g.id}" ${selected}>${g.name}</option>`;
    });
    select.disabled = false;
  });
  document.getElementById('weekday').value = fixed ? fixed.weekday : '0';
  document.getElementById('fixed-hourStart').value = fixed ? fixed.hourStart||'' : '';
  document.getElementById('fixed-hourEnd').value = fixed ? fixed.hourEnd||'' : '';
  document.getElementById('fixed-note').value = fixed ? fixed.note||'' : '';
  document.getElementById('fixed-form').onsubmit = async function(e){
    e.preventDefault();
    const obj = {
  guideId: Number(document.getElementById('fixed-guideId').value),
  weekday: Number(document.getElementById('weekday').value),
  hourStart: document.getElementById('fixed-hourStart').value,
  hourEnd: document.getElementById('fixed-hourEnd').value,
  note: document.getElementById('fixed-note').value
  };

    if (fixed && fixed.id) {
      await apiFetch('/api/fixed-constraints/'+fixed.id, {
        method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj)
      });
    } else {
      await apiFetch('/api/fixed-constraints', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj)
      });
    }
    closeFixedForm();
    renderFixedConstraints();
  }
}
function closeFixedForm() { document.getElementById('fixed-form-modal').style.display='none'; }
async function editFixed(id) {
  const fixed = await fetchFixedConstraints();
  const f = fixed.find(x=>x.id==id);
  if (f) openFixedForm(f);
}
async function deleteFixed(id) {
  if (!confirm("למחוק את האילוץ?")) return;
  await apiFetch('/api/fixed-constraints/'+id, {method:'DELETE'});
  renderFixedConstraints();
}

// --- טופס חופשה ---
function openVacationForm(vacation=null) {
  document.getElementById('vacation-form-modal').style.display='flex';
  document.getElementById('vacation-form-title').textContent = vacation ? 'ערוך בקשת חופשה' : 'הגש בקשת חופשה';
  fetchGuides().then(guides=>{
    let select = document.getElementById('vac-guideId');
    select.innerHTML = "";
    const userData = getCurrentUserData();
    guides.forEach(g=>{
      let selected = (vacation && g.id==vacation.guideId) || (userData.role==="מדריך" && g.id==userData.guideId) ? "selected" : "";
      select.innerHTML += `<option value="${g.id}" ${selected}>${g.name}</option>`;
    });
    select.disabled = (userData.role==="מדריך");
  });
  
  // Set default dates to current month if no vacation is being edited
  let defaultStartDate = '';
  let defaultEndDate = '';
  if (vacation) {
    defaultStartDate = vacation.dateStart;
    defaultEndDate = vacation.dateEnd;
  } else {
    // Set to current month
    defaultStartDate = currentMonth + '-01';
    // Set end date to last day of current month
    const [year, month] = currentMonth.split('-').map(Number);
    const lastDay = new Date(year, month, 0).getDate();
    defaultEndDate = currentMonth + '-' + lastDay.toString().padStart(2, '0');
  }
  
  document.getElementById('vac-dateStart').value = defaultStartDate;
  document.getElementById('vac-dateEnd').value = defaultEndDate;
  document.getElementById('vac-note').value = vacation ? vacation.note||'' : '';
  document.getElementById('vacation-form').onsubmit = async function(e){
    e.preventDefault();
    const obj = {
      guideId: Number(document.getElementById('vac-guideId').value),
      dateStart: document.getElementById('vac-dateStart').value,
      dateEnd: document.getElementById('vac-dateEnd').value,
      note: document.getElementById('vac-note').value,
      status: "pending"
    };
    if (vacation && vacation.id) {
      await apiFetch('/api/vacations/'+vacation.id, {
        method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj)
      });
    } else {
      await apiFetch('/api/vacations', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj)
      });
    }
    closeVacationForm();
    await renderVacations();
  }
}
function closeVacationForm() { document.getElementById('vacation-form-modal').style.display='none'; }
async function approveVacation(id) {
  const vacations = await fetchVacations();
  const vac = vacations.find(x=>x.id==id);
  if (!vac) return;
  document.getElementById('approve-modal').style.display = 'flex';
  document.getElementById('approve-status').value = vac.status === "approved" ? "approved" : "declined";
  document.getElementById('approve-note').value = vac.responseNote || '';
  document.getElementById('approve-form').onsubmit = async function(e){
    e.preventDefault();
    const newStatus = document.getElementById('approve-status').value;
    vac.status = newStatus;
    vac.responseNote = document.getElementById('approve-note').value;
    
    // אם החופשה אושרה, הוסף אותה כאילוצים
    if (newStatus === "approved") {
      const guides = await fetchGuides();
      const guide = guides.find(g => g.id == vac.guideId);
      if (guide) {
        // הוסף אילוץ לכל יום בחופשה
        const startDate = new Date(vac.dateStart);
        const endDate = new Date(vac.dateEnd);
        
        for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
          const dateStr = date.toISOString().slice(0,10);
          const vacationConstraint = {
            guideId: vac.guideId,
            date: dateStr,
            hourStart: "00:00",
            hourEnd: "23:59",
            note: `חופשה מאושרת: ${vac.note || ""}`,
            type: "vacation"
          };
          
          await apiFetch('/api/constraints', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(vacationConstraint)
          });
        }
      }
    }
    
    await apiFetch('/api/vacations/'+vac.id, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(vac)
    });
    closeApproveModal();
    renderVacations();
    renderConstraints(); // רענן גם את רשימת האילוצים
  }
}
function closeApproveModal() {
  document.getElementById('approve-modal').style.display='none';
}

async function deleteVacation(id) {
  if (!confirm("למחוק את בקשת החופשה?")) return;
  await apiFetch('/api/vacations/' + id, { method: 'DELETE' });
  renderVacations();
}

// Initialize the Jewish holidays service
const jewishHolidays = new JewishHolidaysService();

// --- Date Picker Functions ---
let currentDatePickerMonth = new Date();
let currentDatePickerTarget = null;

function openDatePicker(target = 'main') {
  currentDatePickerTarget = target;
  const datePicker = document.getElementById('datePicker');
  const targetInput = target === 'start' ? document.getElementById('dateStart') : 
                     target === 'end' ? document.getElementById('dateEnd') : 
                     document.getElementById('constraintDate');
  
  // Position the date picker relative to the input
  const rect = targetInput.getBoundingClientRect();
  datePicker.style.left = rect.left + 'px';
  datePicker.style.top = (rect.bottom + 8) + 'px';
  
  // Set current month to the input's value or current month
  if (targetInput.value) {
    const inputDate = new Date(targetInput.value);
    if (!isNaN(inputDate.getTime())) {
      currentDatePickerMonth = new Date(inputDate.getFullYear(), inputDate.getMonth(), 1);
    }
  }
  
  renderDatePicker();
  datePicker.style.display = 'block';
  
  // Close date picker when clicking outside
  setTimeout(() => {
    document.addEventListener('click', closeDatePickerOnOutsideClick);
  }, 100);
}

function closeDatePickerOnOutsideClick(event) {
  const datePicker = document.getElementById('datePicker');
  if (!datePicker.contains(event.target)) {
    datePicker.style.display = 'none';
    document.removeEventListener('click', closeDatePickerOnOutsideClick);
  }
}

function changeMonth(delta) {
  currentDatePickerMonth.setMonth(currentDatePickerMonth.getMonth() + delta);
  renderDatePicker();
}

async function renderDatePicker() {
  const title = document.getElementById('datePickerTitle');
  const daysContainer = document.getElementById('datePickerDays');
  
  const year = currentDatePickerMonth.getFullYear();
  const month = currentDatePickerMonth.getMonth();
  
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  
  title.textContent = `${monthNames[month]} ${year}`;
  
  // Get holidays for this month
  const holidays = await jewishHolidays.getHolidaysForMonth(year, month + 1);
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  let html = '';
  const today = new Date();
  
  for (let i = 0; i < 42; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    
    const isCurrentMonth = currentDate.getMonth() === month;
    const isToday = currentDate.toDateString() === today.toDateString();
    const isSelected = isDateSelected(currentDate);
    
    // Use local date string to avoid timezone issues
    const localDateString = currentDate.getFullYear() + '-' + 
                           String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(currentDate.getDate()).padStart(2, '0');
    
    // Check for Jewish holidays on this date
    const dayHolidays = holidays[localDateString] || [];
    const hasHoliday = dayHolidays.length > 0;
    
    let classes = 'date-picker-day';
    if (!isCurrentMonth) classes += ' other-month';
    if (isToday) classes += ' today';
    if (isSelected) classes += ' selected';
    if (hasHoliday) classes += ' has-holiday';
    
    // Create holiday indicators
    let holidayIndicators = '';
    let holidayTitle = '';
    if (hasHoliday) {
      const primaryHoliday = dayHolidays[0];
      const icon = jewishHolidays.getHolidayIcon(primaryHoliday.category);
      const color = jewishHolidays.getHolidayColor(primaryHoliday.category);
      holidayTitle = primaryHoliday.titleHeb || primaryHoliday.title;
      
      holidayIndicators = `<div class="holiday-indicator" style="color: ${color}" title="${holidayTitle}">${icon}</div>`;
    }
    
    html += `<div class="${classes}" onclick="selectDate('${localDateString}')">
      <span class="day-number">${currentDate.getDate()}</span>
      ${holidayTitle ? `<div class="holiday-title">${holidayTitle}</div>` : ''}
      ${holidayIndicators}
    </div>`;
  }
  
  daysContainer.innerHTML = html;
}

function isDateSelected(date) {
  const targetInput = currentDatePickerTarget === 'start' ? document.getElementById('dateStart') : 
                     currentDatePickerTarget === 'end' ? document.getElementById('dateEnd') : 
                     document.getElementById('constraintDate');
  
  if (!targetInput.value) return false;
  
  const selectedDate = new Date(targetInput.value);
  return date.toDateString() === selectedDate.toDateString();
}

function selectDate(dateString) {
  const targetInput = currentDatePickerTarget === 'start' ? document.getElementById('dateStart') : 
                     currentDatePickerTarget === 'end' ? document.getElementById('dateEnd') : 
                     document.getElementById('constraintDate');
  
  targetInput.value = dateString;
  
  // Close date picker
  document.getElementById('datePicker').style.display = 'none';
  document.removeEventListener('click', closeDatePickerOnOutsideClick);
  
  // Re-render to update selection
  renderDatePicker();
}

function clearDate() {
  const targetInput = currentDatePickerTarget === 'start' ? document.getElementById('dateStart') : 
                     currentDatePickerTarget === 'end' ? document.getElementById('dateEnd') : 
                     document.getElementById('constraintDate');
  
  targetInput.value = '';
  document.getElementById('datePicker').style.display = 'none';
  document.removeEventListener('click', closeDatePickerOnOutsideClick);
}

function selectToday() {
  // Use local date to avoid timezone issues
  const today = new Date();
  const localDateString = today.getFullYear() + '-' + 
                         String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(today.getDate()).padStart(2, '0');
  selectDate(localDateString);
}

// --- Monthly View Functions ---
let monthlyViewMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
let selectedGuideForView = null;

function initializeMonthlyView() {
  // Populate guide dropdown
  populateMonthlyViewGuideDropdown();
  // Set current month
  monthlyViewMonth = new Date().toISOString().slice(0, 7);
  updateMonthlyViewMonthDisplay();
}

function populateMonthlyViewGuideDropdown() {
  fetchGuides().then(guides => {
    const select = document.getElementById('monthly-view-guide');
    select.innerHTML = '<option value="">בחר מדריך...</option>';
    guides.forEach(guide => {
      const option = document.createElement('option');
      option.value = guide.id;
      option.textContent = guide.name;
      select.appendChild(option);
    });
  });
}

function updateMonthlyViewMonthDisplay() {
  const monthNames = [
    "ינואר", "פברואר", "מרץ", "אפריל", "מאי", "יוני",
    "יולי", "אוגוסט", "ספטמבר", "אוקטובר", "נובמבר", "דצמבר"
  ];
  
  const [year, month] = monthlyViewMonth.split('-');
  const monthIndex = parseInt(month) - 1;
  const monthName = monthNames[monthIndex];
  const hebrewYear = parseInt(year);
  
  document.getElementById('monthly-view-month-display').textContent = `${monthName} ${hebrewYear}`;
}

function previousMonthView() {
  const [year, month] = monthlyViewMonth.split('-');
  const date = new Date(parseInt(year), parseInt(month) - 1, 1);
  date.setMonth(date.getMonth() - 1);
  const newYear = date.getFullYear();
  const newMonth = String(date.getMonth() + 1).padStart(2, '0');
  monthlyViewMonth = `${newYear}-${newMonth}`;
  updateMonthlyViewMonthDisplay();
  if (selectedGuideForView) {
    loadMonthlyView();
  }
}

function nextMonthView() {
  const [year, month] = monthlyViewMonth.split('-');
  const date = new Date(parseInt(year), parseInt(month) - 1, 1);
  date.setMonth(date.getMonth() + 1);
  const newYear = date.getFullYear();
  const newMonth = String(date.getMonth() + 1).padStart(2, '0');
  monthlyViewMonth = `${newYear}-${newMonth}`;
  updateMonthlyViewMonthDisplay();
  if (selectedGuideForView) {
    loadMonthlyView();
  }
}

function goToCurrentMonthView() {
  monthlyViewMonth = new Date().toISOString().slice(0, 7);
  updateMonthlyViewMonthDisplay();
  if (selectedGuideForView) {
    loadMonthlyView();
  }
}

async function loadMonthlyView() {
  const guideSelect = document.getElementById('monthly-view-guide');
  const guideId = guideSelect.value;
  
  if (!guideId) {
    document.getElementById('monthly-calendar-container').innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">בחר מדריך כדי להציג את התצוגה החודשית</p>';
    return;
  }
  
  selectedGuideForView = guideId;
  
  try {
    // Fetch all data for the selected guide and month
    const [constraints, fixedConstraints, vacations] = await Promise.all([
      fetchConstraints(),
      fetchFixedConstraints(),
      fetchVacations()
    ]);
    
    // Filter data for the selected guide and month
    const guideConstraints = constraints.filter(c => c.guideId == guideId);
    const guideFixedConstraints = fixedConstraints.filter(f => f.guideId == guideId);
    const guideVacations = vacations.filter(v => v.guideId == guideId);
    
    // Render the calendar
    renderMonthlyCalendar(guideConstraints, guideFixedConstraints, guideVacations);
    
  } catch (error) {
    console.error('Error loading monthly view:', error);
    document.getElementById('monthly-calendar-container').innerHTML = '<p style="text-align: center; color: #d32f2f; margin-top: 20px;">שגיאה בטעינת התצוגה החודשית</p>';
  }
}

async function renderMonthlyCalendar(constraints, fixedConstraints, vacations) {
  const container = document.getElementById('monthly-calendar-container');
  
  const [year, month] = monthlyViewMonth.split('-');
  const monthIndex = parseInt(month) - 1;
  const monthNames = [
    "ינואר", "פברואר", "מרץ", "אפריל", "מאי", "יוני",
    "יולי", "אוגוסט", "ספטמבר", "אוקטובר", "נובמבר", "דצמבר"
  ];
  
  // Get Jewish holidays for this month
  const holidays = await jewishHolidays.getHolidaysForMonth(parseInt(year), parseInt(month));
  
  // Create calendar HTML
  let html = `
    <div class="monthly-calendar">
      <div class="calendar-header">
        <h3>${monthNames[monthIndex]} ${year}</h3>
      </div>
      <div class="calendar-grid">
  `;
  
  // Add weekday headers
  const weekdays = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
  weekdays.forEach(day => {
    html += `<div class="calendar-weekday">${day}</div>`;
  });
  
  // Get first day of month and number of days
  const firstDay = new Date(parseInt(year), monthIndex, 1);
  const lastDay = new Date(parseInt(year), monthIndex + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  const today = new Date();
  
  // Generate calendar days
  for (let i = 0; i < 42; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    
    const isCurrentMonth = currentDate.getMonth() === monthIndex;
    const isToday = currentDate.toDateString() === today.toDateString();
    const dateString = currentDate.toISOString().split('T')[0];
    
    // Check what constraints exist for this date
    const dayConstraints = constraints.filter(c => c.date === dateString);
    const dayFixedConstraints = fixedConstraints.filter(f => {
      const dayOfWeek = currentDate.getDay();
      return f.weekday == dayOfWeek;
    });
    const dayVacations = vacations.filter(v => {
      const start = new Date(v.dateStart);
      const end = new Date(v.dateEnd);
      return currentDate >= start && currentDate <= end;
    });
    
    // Check for Jewish holidays
    const dayHolidays = holidays[dateString] || [];
    const hasHoliday = dayHolidays.length > 0;
    
    // Determine day classes and indicators
    let dayClasses = 'calendar-day';
    let indicators = '';
    
    if (!isCurrentMonth) dayClasses += ' other-month';
    if (isToday) dayClasses += ' today';
    if (hasHoliday) dayClasses += ' has-holiday';
    
    // Add holiday indicators first
    if (hasHoliday) {
      dayHolidays.forEach(holiday => {
        const icon = jewishHolidays.getHolidayIcon(holiday.category);
        const color = jewishHolidays.getHolidayColor(holiday.category);
        const title = holiday.titleHeb || holiday.title;
        indicators += `<span class="constraint-indicator holiday" style="background-color: ${color}; color: white;" title="${title}">${icon}</span>`;
      });
    }
    
    // Add constraint indicators
    if (dayConstraints.length > 0 || dayFixedConstraints.length > 0 || dayVacations.length > 0) {
      if (dayConstraints.length > 0 && dayFixedConstraints.length > 0 && dayVacations.length > 0) {
        dayClasses += ' has-multiple';
        indicators += '<span class="constraint-indicator monthly">ח</span>';
        indicators += '<span class="constraint-indicator fixed">ק</span>';
        indicators += '<span class="constraint-indicator vacation">ו</span>';
      } else if (dayConstraints.length > 0 && dayFixedConstraints.length > 0) {
        dayClasses += ' has-multiple';
        indicators += '<span class="constraint-indicator monthly">ח</span>';
        indicators += '<span class="constraint-indicator fixed">ק</span>';
      } else if (dayConstraints.length > 0 && dayVacations.length > 0) {
        dayClasses += ' has-multiple';
        indicators += '<span class="constraint-indicator monthly">ח</span>';
        indicators += '<span class="constraint-indicator vacation">ו</span>';
      } else if (dayFixedConstraints.length > 0 && dayVacations.length > 0) {
        dayClasses += ' has-multiple';
        indicators += '<span class="constraint-indicator fixed">ק</span>';
        indicators += '<span class="constraint-indicator vacation">ו</span>';
      } else if (dayConstraints.length > 0) {
        dayClasses += ' has-constraint';
        indicators += '<span class="constraint-indicator monthly">ח</span>';
      } else if (dayFixedConstraints.length > 0) {
        dayClasses += ' has-fixed';
        indicators += '<span class="constraint-indicator fixed">ק</span>';
      } else if (dayVacations.length > 0) {
        dayClasses += ' has-vacation';
        indicators += '<span class="constraint-indicator vacation">ו</span>';
      }
    }
    
    // Create holiday title for the day
    let holidayTitle = '';
    if (hasHoliday) {
      const primaryHoliday = dayHolidays[0];
      holidayTitle = primaryHoliday.titleHeb || primaryHoliday.title;
    }
    
    html += `
      <div class="${dayClasses}" onclick="openConstraintFormForDate('${dateString}')">
        <div class="day-number">${currentDate.getDate()}</div>
        ${holidayTitle ? `<div class="holiday-title">${holidayTitle}</div>` : ''}
        ${indicators}
      </div>
    `;
  }
  
  html += `
      </div>
    </div>
  `;
  
  container.innerHTML = html;
}

function openConstraintFormForDate(dateString) {
  // Open the constraint form with the selected date pre-filled
  openConstraintForm();
  
  // Set the date in the form
  setTimeout(() => {
    document.getElementById('constraintDate').value = dateString;
    // Set the guide if one is selected
    if (selectedGuideForView) {
      document.getElementById('constraintGuide').value = selectedGuideForView;
      // Switch to monthly tab to show the form
      switchTab('monthly');
    }
  }, 100);
}

</script>
    <div id="main-footer"></div>
    <script src="header-functions.js"></script>
    <script>
    // HEADER
    fetch('header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-header').innerHTML = html;
        // וודא שהאלמנטים קיימים לפני קריאת הפונקציה
        setTimeout(() => {
          console.log('Header loaded, calling renderHeaderUser...');
          console.log('header-user element:', document.getElementById('header-user'));
          console.log('header-role element:', document.getElementById('header-role'));
          renderHeaderUser();
        }, 100);
      });
    // FOOTER
    fetch('footer.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-footer').innerHTML = html;
      });
    </script>
</body>
</html>
