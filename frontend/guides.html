<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול מדריכים - סיגלית</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Heebo', Arial, sans-serif;
            background: #f4f8fb;
            margin: 0; padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1080px;
            margin: 38px auto;
            background: #fff;
            border-radius: 22px;
            box-shadow: 0 6px 30px #d6e3f544;
            padding: 38px 32px 32px 32px;
            position: relative;
        }
        h2 {
            margin: 0 0 28px 0;
            color: #2576c4;
            font-size: 2.2rem;
            letter-spacing: -1.5px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 18px;
            background: #f7fafd;
            border-radius: 18px;
            overflow: hidden;
        }
        th, td {
            border-bottom: 1px solid #e1ecf5;
            padding: 12px 10px;
            text-align: right;
            font-size: 1.06rem;
        }
        th {
            background: #eaf3fb;
            color: #3575b6;
            font-size: 1.1rem;
        }
        tr:last-child td { border-bottom: none; }
        tr {
            transition: background 0.14s;
        }
        tr:hover {
            background: #f0f7ff !important;
        }
        tr:nth-child(even) td {
            background: #f7fafd;
        }
        .btn {
            background: linear-gradient(94deg,#36a6ec 0,#21b3b6 100%);
            color: #fff;
            border: none;
            padding: 9px 26px;
            border-radius: 19px;
            font-size: 1.08rem;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.19s, box-shadow 0.18s;
            margin: 3px 0;
            box-shadow: 0 2px 6px #b7d6f722;
        }
        .btn:hover {
            background: linear-gradient(94deg,#238dc8 0,#1c8a89 100%);
            box-shadow: 0 2px 16px #7ec3fc33;
        }
        .icon-btn {
            background: #e8f0fa;
            border-radius: 7px;
            color: #2561b2;
            border: none;
            padding: 5px 12px;
            margin: 0 2px;
            font-size: 1.06em;
            cursor: pointer;
            transition: background 0.15s;
            box-shadow: 0 1px 5px #e4e8f7cc;
        }
        .icon-btn:hover { background: #d8e8fb; }
        .flex-row {
            display: flex;
            gap: 22px;
            align-items: center;
            margin-bottom: 10px;
        }
        .info {
            color: #3285c8;
            background: #e9f3fb;
            border-radius: 11px;
            padding: 4px 15px;
            font-size: 16px;
            margin-right: 12px;
        }
        .actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .view-link, .edit-link, .del-link, .view-link:visited {
            color: #2778c3;
            text-decoration: underline;
            font-weight: 500;
            font-size: 1.04em;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0 7px;
            border-radius: 7px;
        }
        .del-link { color: #e34242; }
        .edit-link { color: #30b57d; }
        .view-link:hover, .edit-link:hover, .del-link:hover { text-decoration: none; opacity: 0.85;}
        .percent-input {
            width: 64px;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid #c6e0f5;
            font-size: 1rem;
            background: #f7fbfc;
            transition: border 0.13s;
        }
        .percent-input:focus { border-color: #2780c1; }
        .badge {
            background: #e6f7ed;
            color: #238d4e;
            font-size: 0.99rem;
            padding: 5px 12px;
            border-radius: 13px;
            font-weight: bold;
        }
        .badge.coordinator { background: #e8f5fe; color: #2186c4; }
        .badge.regular { background: #e6f7ed; color: #238d4e; }
        .badge.overlap { background: #fff3cd; color: #856404; }
        .badge.oncall { background: #f8d7da; color: #721c24; }
        
        .availability-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .availability-green { background: #28a745; }
        .availability-yellow { background: #ffc107; }
        .availability-red { background: #dc3545; }
        
        .stats-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #007bff;
            font-size: 0.9rem;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            align-items: center;
        }
        .stats-row span:first-child {
            font-weight: 500;
            color: #495057;
        }
        .stats-row span:last-child {
            font-weight: bold;
            color: #007bff;
        }
        .constraint-badge {
            background: #e9ecef;
            color: #495057;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px;
            display: inline-block;
        }
        .constraints-section {
            margin-top: 8px;
            padding: 8px;
            background: #fff3cd;
            border-radius: 6px;
            border-left: 3px solid #ffc107;
        }
        .constraints-section strong {
            color: #856404;
            font-size: 0.9rem;
        }
        
        .stats-toggle {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin: 2px;
        }
        .stats-toggle:hover {
            background: #0056b3;
        }
        .stats-dropdown {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            z-index: 1000;
            min-width: 200px;
            margin-top: 5px;
        }
        .stats-dropdown.show {
            display: block;
        }
        .stats-container {
            position: relative;
        }
        #guide-form-modal {
            display: none;
            position: fixed;
            top: 0; right: 0; left: 0; bottom: 0;
            background: #263b5050;
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        #guide-form-modal .modal-content {
            background: #fff;
            padding: 26px 32px 18px 32px;
            max-width: 420px;
            border-radius: 18px;
            box-shadow: 0 2px 28px #66b4ff33;
            margin: auto;
            animation: appear 0.27s cubic-bezier(.44,1.7,.6,1.01);
        }
        @keyframes appear {
            from { opacity: 0; transform: translateY(25px);}
            to { opacity: 1; transform: none;}
        }
        #guide-form input, #guide-form select {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #bed6e7;
            margin-top: 4px;
            width: 96%;
            font-size: 1rem;
            margin-bottom: 10px;
            background: #f8fafc;
        }
        #guide-form label {
            font-weight: 500;
            color: #366488;
        }
        #guide-form button[type="submit"] { width: 80px;}
        @media (max-width: 700px) {
            .container { max-width: 99%; padding: 9px;}
            th, td { font-size: 15px; padding: 8px 4px;}
            h2 { font-size: 1.2rem; }
            .flex-row { flex-direction: column; gap: 8px;}
            #guide-form-modal .modal-content { padding: 14px 7px; }
            
            /* Mobile table improvements */
            table { font-size: 0.8rem; }
            .stats-card { padding: 8px; font-size: 0.8rem; }
            .constraints-section { padding: 6px; font-size: 0.8rem; }
            .constraint-badge { font-size: 0.7rem; padding: 1px 4px; }
            .availability-status { width: 8px; height: 8px; }
            .stats-toggle { font-size: 0.7rem; padding: 3px 6px; }
            .stats-dropdown { min-width: 180px; padding: 8px; }
        }
    </style>
</head>
<body>
    <div id="main-header"></div>

    <div class="container">
        <div class="flex-row">
            <h2>ניהול מדריכים</h2>
            <button class="btn" onclick="showAddForm()">הוסף מדריך חדש</button>
            <span class="info">? מה זה "אחוז משרה"</span>
            <button class="icon-btn" title='הסבר על אחוז משרה' onclick="alert('אחוז משרה = יחס עבודה שבועי. 100% זה משרה מלאה, 50% זה חצי משרה וכו׳.')">ℹ️</button>
        </div>
        <table id="guides-table">
            <thead>
                <tr>
                    <th>שם</th>
                    <th>טלפון</th>
                    <th>אימייל</th>
                    <th>תפקיד</th>
                    <th>סוג שיבוץ</th>
                    <th>זמינות</th>
                    <th>סטטיסטיקות</th>
                    <th>אחוז משרה ?</th>
                    <th>פעולות</th>
                </tr>
            </thead>
            <tbody id="guides-tbody">
                <tr><td colspan="9" style="text-align:center;">טוען...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- טופס הוספה/עריכה קופץ -->
    <div id="guide-form-modal">
        <div class="modal-content">
            <h3 id="form-title">הוסף מדריך</h3>
            <form id="guide-form">
                <label>שם:
                    <input id="name" required autocomplete="off" maxlength="32">
                </label>
                <label>טלפון:
                    <input id="phone" required autocomplete="off" maxlength="20">
                </label>
                <label>אימייל:
                    <input id="email" required type="email" autocomplete="off" maxlength="40">
                </label>
                <label>סיסמה:
                    <input id="password" type="password" autocomplete="off" maxlength="24" placeholder="בחר סיסמה">
                </label>
                <label>תפקיד:
                    <select id="role">
                        <option value="מדריך">מדריך</option>
                        <option value="רכז">רכז</option>
                        <option value="רכזת">רכזת</option>
                        <option value="מדריכה">מדריכה</option>
                    </select>
                </label>
                <label>סוג שיבוץ:
                    <select id="assignment_type">
                        <option value="regular">רגיל</option>
                        <option value="overlap">חפיפה</option>
                        <option value="oncall">כונן</option>
                    </select>
                </label>
                <label>אחוז משרה:
                    <input id="percent" type="number" min="1" max="200" value="100" required class="percent-input" style="width:60px;display:inline-block">%
                </label>
                <div style="text-align:left;">
                    <button class="btn" type="submit">שמור</button>
                    <button type="button" class="btn" style="background:#eee;color:#444;margin-right:10px;" onclick="closeGuideForm()">X</button>
                </div>
            </form>
        </div>
    </div>
    <div id="main-footer"></div>

    <script>
    // HEADER
    fetch('header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-header').innerHTML = html;
        renderHeaderUser();
      });
    // FOOTER
    fetch('footer.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-footer').innerHTML = html;
      });
    // --- קריאת נתונים ---
    async function fetchGuides() {
        const res = await fetch('http://localhost:4000/api/guides/enhanced');
        return await res.json();
    }
    
    async function fetchGuideConstraints(guideId) {
        try {
            const res = await fetch(`http://localhost:4000/api/constraints?user_id=${guideId}`);
            return await res.json();
        } catch (error) {
            console.error('Error fetching constraints:', error);
            return [];
        }
    }
    async function renderGuides() {
        const guides = await fetchGuides();
        const tbody = document.getElementById('guides-tbody');
        if (!guides.length) {
            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">אין מדריכים</td></tr>`;
            return;
        }
        tbody.innerHTML = "";
        const userRole = localStorage.getItem('role');
        
        for (const g of guides) {
            const constraints = await fetchGuideConstraints(g.id);
            const assignmentType = g.assignment_type || 'regular';
            const assignmentTypeText = {
                'regular': 'רגיל',
                'overlap': 'חפיפה', 
                'oncall': 'כונן'
            }[assignmentType];
            
            const availabilityStatus = getAvailabilityStatus(g);
            const statsHtml = generateStatsHtml(g);
            const constraintsHtml = generateConstraintsHtml(constraints);
            
            tbody.innerHTML += `
            <tr>
                <td>${g.name}</td>
                <td>${g.phone || '-'}</td>
                <td>${g.email || '-'}</td>
                <td>
                    <span class="badge${g.role === 'רכז' || g.role === 'רכזת' ? ' coordinator' : ''}">${g.role}</span>
                </td>
                <td>
                    <span class="badge ${assignmentType}">${assignmentTypeText}</span>
                </td>
                <td>
                    <span class="availability-status availability-${availabilityStatus}"></span>
                    ${availabilityStatus === 'green' ? 'זמין' : availabilityStatus === 'yellow' ? 'מוגבל' : 'לא זמין'}
                </td>
                <td>
                    <div class="stats-container">
                        <button class="stats-toggle" onclick="toggleStats(${g.id})" title="לחץ לצפייה בסטטיסטיקות ואילוצים">
                            📊 ${g.total_shifts || 0} משמרות
                            <span class="availability-status availability-${availabilityStatus}" style="margin-left: 4px;"></span>
                            ${constraints && constraints.length > 0 ? '⚠️' : ''}
                        </button>
                        <div id="stats-${g.id}" class="stats-dropdown">
                            <div class="stats-card">
                                <div class="stats-row">
                                    <span>משמרות:</span>
                                    <span>${g.total_shifts || 0}</span>
                                </div>
                                <div class="stats-row">
                                    <span>ידניות:</span>
                                    <span>${g.manual_shifts || 0}</span>
                                </div>
                                <div class="stats-row">
                                    <span>אוטומטיות:</span>
                                    <span>${g.auto_shifts || 0}</span>
                                </div>
                            </div>
                            ${constraintsHtml}
                        </div>
                    </div>
                </td>
                <td>
                    <input class="percent-input" type="number" value="${g.percent || 100}" min="1" max="200" onchange="updatePercent(${g.id}, this.value)" ${userRole!=='רכז'&&userRole!=='רכזת'?'disabled':''}>% 
                </td>
                <td class="actions">
                    ${userRole==='רכז'||userRole==='רכזת' ? `
                    <button class="edit-link" onclick="editGuide(${g.id})">ערוך</button>
                    <button class="del-link" onclick="deleteGuide(${g.id}); return false;">מחק</button>
                    <button class="icon-btn" onclick="changePassword(${g.id})" title="שנה סיסמא">🔒</button>
                    <button class="icon-btn" onclick="manageConstraints(${g.id})" title="ניהול אילוצים">📅</button>
                    ` : `<span style='color:#888;'>—</span>`}
                </td>
            </tr>
            `;
        }
    }
    renderGuides();

    // -- ניהול טופס הוספה/עריכה --
    function showAddForm() {
        openGuideForm();
    }
    function editGuide(id) {
        fetch('http://localhost:4000/api/guides')
        .then(r=>r.json())
        .then(guides=>{
            const guide = guides.find(g=>g.id==id);
            if (!guide) return;
            openGuideForm(guide);
        });
    }
    function openGuideForm(guide=null) {
        document.getElementById('guide-form-modal').style.display='flex';
        document.getElementById('form-title').textContent = guide ? 'ערוך מדריך' : 'הוסף מדריך';
        document.getElementById('name').value = guide ? guide.name : '';
        document.getElementById('phone').value = guide ? guide.phone : '';
        document.getElementById('email').value = guide ? guide.email : '';
        document.getElementById('role').value = guide ? guide.role : 'מדריך';
        document.getElementById('assignment_type').value = guide ? (guide.assignment_type || 'regular') : 'regular';
        document.getElementById('percent').value = guide ? (guide.percent||100) : 100;
        document.getElementById('password').value = ''; // מתחיל ריק תמיד

        document.getElementById('guide-form').onsubmit = async function(e){
            e.preventDefault();
            const password = document.getElementById('password').value.trim();
            let g = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                role: document.getElementById('role').value,
                assignment_type: document.getElementById('assignment_type').value,
                percent: Number(document.getElementById('percent').value)
            };
            if (password) g.password = password; // אם הוזנה סיסמה חדשה - שמור
            else if (guide && guide.password) g.password = guide.password; // אם עריכה ולא שינו - שמור ישנה

            if (guide) { // עדכון
                await fetch('http://localhost:4000/api/guides/'+guide.id, {
                    method:'PUT',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(g)
                });
            } else { // חדש
                if (!g.password) {
                    alert("נא לבחור סיסמה");
                    return;
                }
                await fetch('http://localhost:4000/api/guides', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(g)
                });
            }
            closeGuideForm();
            renderGuides();
        };
    }
    function closeGuideForm() {
        document.getElementById('guide-form-modal').style.display='none';
    }
    async function deleteGuide(id) {
        if (!confirm("למחוק את המדריך?")) return;
        await fetch('http://localhost:4000/api/guides/'+id, {method:'DELETE'});
        renderGuides();
    }
    async function updatePercent(id, val) {
        val = Number(val);
        if (!val) return;
        let guides = await fetch('http://localhost:4000/api/guides').then(r=>r.json());
        let guide = guides.find(g=>g.id==id);
        if (guide) {
            guide.percent = val;
            await fetch('http://localhost:4000/api/guides/'+id, {
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(guide)
            });
        }
    }
    function showConstraints(id) {
        alert('כאן תוכל להציג את האילוצים למדריך #' + id + ' (מימוש בעתיד)');
    }
    function openConstraintForm(id) {
        alert('כאן תוכל להוסיף אילוץ למדריך #' + id + ' (מימוש בעתיד)');
    }
    function getAvailabilityStatus(guide) {
        // Simple availability logic based on constraints and workload
        if (guide.total_shifts > 12) return 'red';
        if (guide.total_shifts > 8) return 'yellow';
        return 'green';
    }
    
    function generateStatsHtml(guide) {
        return `
            <div class="stats-card">
                <div class="stats-row">
                    <span>משמרות:</span>
                    <span>${guide.total_shifts || 0}</span>
                </div>
                <div class="stats-row">
                    <span>ידניות:</span>
                    <span>${guide.manual_shifts || 0}</span>
                </div>
                <div class="stats-row">
                    <span>אוטומטיות:</span>
                    <span>${guide.auto_shifts || 0}</span>
                </div>
            </div>
        `;
    }
    
    function generateConstraintsHtml(constraints) {
        if (!constraints || constraints.length === 0) {
            return '<div class="constraints-section" style="background: #d4edda; border-left-color: #28a745;"><strong>אין אילוצים</strong> ✅</div>';
        }
        
        // Group constraints by type
        const vacations = constraints.filter(c => c.type === 'vacation');
        const regularConstraints = constraints.filter(c => c.type !== 'vacation');
        
        let html = '<div class="constraints-section">';
        html += '<strong>אילוצים:</strong><br>';
        
        if (vacations.length > 0) {
            html += '<div style="margin: 4px 0;"><strong>חופשות:</strong> ';
            html += vacations.map(c => `
                <span class="constraint-badge">
                    🏖️ ${c.description || c.date}
                </span>
            `).join('');
            html += '</div>';
        }
        
        if (regularConstraints.length > 0) {
            html += '<div style="margin: 4px 0;"><strong>אילוצים אחרים:</strong> ';
            html += regularConstraints.map(c => `
                <span class="constraint-badge">
                    🚫 ${c.description || c.date}
                </span>
            `).join('');
            html += '</div>';
        }
        
        html += '</div>';
        return html;
    }
    
    function manageConstraints(guideId) {
        // Open constraints management modal
        alert(`ניהול אילוצים למדריך #${guideId} - ייפתח בקרוב`);
    }
    
    function toggleStats(guideId) {
        const dropdown = document.getElementById(`stats-${guideId}`);
        const isVisible = dropdown.classList.contains('show');
        
        // Close all other dropdowns first
        document.querySelectorAll('.stats-dropdown').forEach(d => {
            d.classList.remove('show');
        });
        
        // Toggle current dropdown
        if (!isVisible) {
            dropdown.classList.add('show');
        }
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.stats-container')) {
            document.querySelectorAll('.stats-dropdown').forEach(d => {
                d.classList.remove('show');
            });
        }
    });
    
    function changePassword(id) {
        const newPassword = prompt('הזן סיסמה חדשה:');
        if (newPassword && newPassword.trim()) {
            // TODO: Implement password change API
            alert('שינוי סיסמה ייפתח בקרוב');
        }
    }
    </script>
    <script src="header-functions.js"></script>
</body>
</html>
