<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>משימות - סיגלית</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #f7fafd; font-family: 'Heebo', Arial, sans-serif; }
        .container { max-width: 900px; margin: 36px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 18px #e4e6eb44; padding: 36px;}
        h2 { margin: 0 0 18px 0;}
        .tabs { display: flex; gap: 24px; margin-bottom: 20px;}
        .tab-btn { background: #e7f1fa; color: #3682c6; border: none; padding: 10px 24px; border-radius: 10px 10px 0 0; font-size: 17px; cursor: pointer;}
        .tab-btn.active, .tab-btn:hover { background: #4891ca; color: #fff; }
        .task-row { display: flex; align-items: center; gap: 12px; margin-bottom: 9px; background: #f8fafd; border-radius: 7px; padding: 9px 9px;}
        .task-row.done { background: #e6f8e6; color: #6b6b6b;}
        .task-row .task-text { flex: 2; }
        .task-row .task-meta { font-size: 13px; color: #555; margin-right: 7px;}
        .btn { background: #4891ca; color: #fff; padding: 7px 16px; border: none; border-radius: 7px; cursor: pointer; font-size: 16px;}
        .btn-small { padding: 3px 8px; font-size: 13px;}
        .btn:disabled { opacity: 0.6; }
        .task-actions { display: flex; gap: 4px;}
        .move-date { font-size: 13px; border-radius: 6px; border: 1px solid #bed6e7; padding: 2px 6px;}
        .date-label { color: #226199; font-size: 15px; font-weight: bold; margin-left: 7px;}
        @media (max-width:700px) {
            .container { max-width:99vw; padding:10px;}
            .tabs { flex-direction: column; gap: 7px;}
            .task-row { flex-direction: column; align-items: flex-start;}
        }
    </style>
</head>
<body>
    <div id="main-header"></div>
    <div class="container">
        <h2>ניהול משימות</h2>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('open')">פתוחות</button>
            <button class="tab-btn" onclick="switchTab('my-tasks')">המשימות שלי</button>
            <button class="tab-btn" onclick="switchTab('closed')">סגורות</button>
        </div>
        <div id="open-tasks-section">
            <form id="add-task-form" style="margin-bottom:22px; display: flex; gap:14px;">
                <input type="text" id="task-input" placeholder="כתוב משימה חדשה..." required style="flex:2;padding:9px;border-radius:8px;border:1px solid #bdd9f6;">
                <input type="date" id="task-date" required style="flex:1;padding:9px;border-radius:8px;border:1px solid #bdd9f6;">
                <select id="task-assignee" style="flex:1;padding:9px;border-radius:8px;border:1px solid #bdd9f6;">
                    <option value="">לא משויך</option>
                </select>
                <button class="btn" type="submit" style="flex:1;">הוסף</button>
            </form>
            
            <!-- Quick assign section -->
            <div style="margin-bottom:15px; padding:12px; background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef;">
                <h4 style="margin:0 0 8px 0; color:#4891ca;">הקצאת משימות מהירה</h4>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="quick-task-text" placeholder="משימה מהירה..." style="flex:2;padding:6px;border-radius:6px;border:1px solid #bdd9f6;">
                    <select id="quick-assignee" style="flex:1;padding:6px;border-radius:6px;border:1px solid #bdd9f6;">
                        <option value="">בחר מדריך...</option>
                    </select>
                    <button class="btn btn-small" onclick="createQuickTask()" style="flex:1;">צור משימה מהירה</button>
                </div>
            </div>
            
            <div style="margin-bottom:13px; display: flex; align-items: center; gap: 10px;">
                <span class="date-label">הצג משימות ליום:</span>
                <input type="date" id="filter-date" style="font-size:15px;padding:3px 8px;border-radius:6px;border:1px solid #b7d1e6;">
                <button class="btn btn-small" id="show-all-btn" type="button">הצג הכל</button>
                <span id="open-tasks-count" style="margin-right:auto; color:#4891ca; font-weight:bold;"></span>
            </div>
            <div id="open-tasks-list"></div>
        </div>
        
        <div id="my-tasks-section" style="display:none;">
            <div style="margin-bottom:13px; display: flex; align-items: center; gap: 10px;">
                <span class="date-label">הצג משימות ליום:</span>
                <input type="date" id="my-tasks-filter-date" style="font-size:15px;padding:3px 8px;border-radius:6px;border:1px solid #b7d1e6;">
                <button class="btn btn-small" id="my-tasks-show-all-btn" type="button">הצג הכל</button>
                <span id="my-tasks-count" style="margin-right:auto; color:#4891ca; font-weight:bold;"></span>
            </div>
            <div id="my-tasks-list"></div>
        </div>
        
        <div id="closed-tasks-section" style="display:none;">
            <div style="margin-bottom:13px;">
                <span class="date-label">סנן לפי חודש:</span>
                <input type="month" id="filter-month" style="font-size:15px;padding:3px 8px;border-radius:6px;border:1px solid #b7d1e6;">
            </div>
            <div id="closed-tasks-list"></div>
        </div>
    </div>
    <div id="main-footer"></div>

    <script>
    // פונקציה לקבלת הנתונים הנוכחיים
    function getCurrentUserData() {
        return {
            role: localStorage.getItem('role') || "מדריך",
            guide: localStorage.getItem('guide') || "",
            name: localStorage.getItem('name'),
            userId: localStorage.getItem('userId')
        };
    }
    
    // בדיקה - הדפס את הנתונים לקונסול
    const userData = getCurrentUserData();
    console.log('Tasks page - User Data:', userData);

    // טעינת מדריכים לבחירה
    async function loadGuides() {
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        try {
            const res = await fetch(`${API_BASE_URL}/api/users`);
            const users = await res.json();
            
            // Populate regular assignee dropdown
            const select = document.getElementById('task-assignee');
            select.innerHTML = '<option value="">לא משויך</option>';
            users.forEach(user => {
                select.innerHTML += `<option value="${user.id}">${user.name} (${user.role})</option>`;
            });
            
            // Populate quick assignee dropdown
            const quickSelect = document.getElementById('quick-assignee');
            quickSelect.innerHTML = '<option value="">בחר מדריך...</option>';
            users.forEach(user => {
                quickSelect.innerHTML += `<option value="${user.id}">${user.name} (${user.role})</option>`;
            });
        } catch (error) {
            console.error('Error loading guides:', error);
        }
    }

    // יצירת משימה מהירה
    async function createQuickTask() {
        const text = document.getElementById('quick-task-text').value.trim();
        const assignedToId = document.getElementById('quick-assignee').value;
        
        if (!text) {
            alert('אנא כתוב תיאור למשימה');
            return;
        }
        
        if (!assignedToId) {
            alert('אנא בחר מדריך להקצאה');
            return;
        }
        
        const userData = getCurrentUserData();
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        
        try {
            await fetch(`${API_BASE_URL}/api/tasks`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ 
                    text, 
                    creator_id: userData.userId || null, 
                    assigned_to_id: assignedToId,
                    shift_date: new Date().toISOString().slice(0,10), 
                    status: "פתוחה", 
                    created_at: new Date().toISOString() 
                })
            });
            
            // Clear the form
            document.getElementById('quick-task-text').value = "";
            document.getElementById('quick-assignee').value = "";
            
            // Refresh the lists
            renderOpenTasks();
            renderMyTasks();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: #3db66b; color: white; padding: 10px 15px; 
                border-radius: 5px; z-index: 1000; font-size: 14px;
            `;
            successMsg.textContent = 'משימה נוצרה בהצלחה!';
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
            
        } catch (error) {
            console.error('Error creating quick task:', error);
            alert('שגיאה ביצירת המשימה');
        }
    }

    // הצג לשונית
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
        if(tab==='open') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('open-tasks-section').style.display = '';
            document.getElementById('my-tasks-section').style.display = 'none';
            document.getElementById('closed-tasks-section').style.display = 'none';
            renderOpenTasks();
        } else if (tab === 'my-tasks') {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('open-tasks-section').style.display = 'none';
            document.getElementById('my-tasks-section').style.display = '';
            document.getElementById('closed-tasks-section').style.display = 'none';
            renderMyTasks();
        } else {
            document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
            document.getElementById('open-tasks-section').style.display = 'none';
            document.getElementById('my-tasks-section').style.display = 'none';
            document.getElementById('closed-tasks-section').style.display = '';
            renderClosedTasks();
        }
    }

    // הוספת משימה
    document.getElementById('add-task-form').onsubmit = async function(e) {
        e.preventDefault();
        const text = document.getElementById('task-input').value.trim();
        const shiftDate = document.getElementById('task-date').value || new Date().toISOString().slice(0,10);
        const assignedToId = document.getElementById('task-assignee').value;
        if (!text || !shiftDate) return;
        const userData = getCurrentUserData();
        let creator = userData.guide || "מערכת";
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        await fetch(`${API_BASE_URL}/api/tasks`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ 
                text, 
                creator_id: userData.userId || null, 
                assigned_to_id: assignedToId || null,
                shift_date: shiftDate, 
                status: "פתוחה", 
                created_at: new Date().toISOString() 
            })
        });
        document.getElementById('task-input').value = "";
        document.getElementById('task-date').value = new Date().toISOString().slice(0,10);
        document.getElementById('task-assignee').value = "";
        renderOpenTasks();
    };

    // משימות פתוחות
    async function renderOpenTasks() {
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        const res = await fetch(`${API_BASE_URL}/api/tasks?open_only=true`);
        let tasks = await res.json();
        let filterDate = document.getElementById('filter-date').value;
        // הצג כל משימה שאינה "בוצע"
        let filtered = tasks.filter(t => t.status !== "בוצע");
        // אם המשתמש בחר תאריך, סנן לפי תאריך, אחרת הצג הכל
        if (filterDate) {
            filtered = filtered.filter(t => t.shift_date === filterDate);
        }
        filtered.sort((a, b) => a.created_at.localeCompare(b.created_at));
        const list = document.getElementById('open-tasks-list');
        const userData = getCurrentUserData();
        document.getElementById('open-tasks-count').textContent = filtered.length ? `סה"כ ${filtered.length} משימות פתוחות` : '';
        if (!filtered.length) {
            list.innerHTML = "<div style='color:#888; margin:22px 0;'>אין משימות פתוחות לתצוגה</div>";
            return;
        }
        list.innerHTML = "";
        filtered.forEach(t=>{
            const assigneeTag = t.assigned_to_name ? `<span style="background:#4891ca; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:8px;">${t.assigned_to_name}</span>` : '';
            list.innerHTML += `
            <div class="task-row">
                <span class="task-text">${t.text}${assigneeTag}</span>
                <span class="task-meta">[${t.creator_name || 'לא ידוע'}]</span>
                <span class="task-meta">${formatDate(t.shift_date)}</span>
                <div class="task-actions">
                    <button class="btn btn-small" onclick="closeTask(${t.id})">בוצע</button>
                    <button class="btn btn-small" style="background:#c6ceec;color:#223;" onclick="moveTaskDate(${t.id})">העבר יום</button>
                    ${userData.role==="רכז"? `<button class="btn btn-small" style="background:#e68787;color:#222;" onclick="deleteTask(${t.id})">מחק</button>`:""}
                </div>
            </div>
            `;
        });
    }

    // סגירת משימה
    async function closeTask(id) {
        const userData = getCurrentUserData();
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        const res = await fetch(`${API_BASE_URL}/api/tasks/`+id, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ status: "בוצע", closed_at: new Date().toISOString(), closed_by_id: userData.userId || null })
        });
        renderOpenTasks();
    }

    // העברת משימה
    function moveTaskDate(id) {
        // Create a nice popup for date selection
        const popup = document.createElement('div');
        popup.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;
        
        popup.innerHTML = `
            <div style="
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                text-align: center;
                min-width: 300px;
            ">
                <h3 style="margin: 0 0 20px 0; color: #4891ca;">העבר משימה ליום אחר</h3>
                <input type="date" id="new-task-date" style="
                    padding: 10px;
                    border: 2px solid #bdd9f6;
                    border-radius: 8px;
                    font-size: 16px;
                    margin-bottom: 20px;
                    width: 100%;
                ">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="confirmMoveTask(${id})" style="
                        background: #4891ca;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                    ">אישור</button>
                    <button onclick="closeMovePopup()" style="
                        background: #e0e0e0;
                        color: #333;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                    ">ביטול</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(popup);
        
        // Set today's date as default
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('new-task-date').value = today;
    }

    // Confirm move task
    async function confirmMoveTask(id) {
        const newDate = document.getElementById('new-task-date').value;
        if (!newDate) {
            alert('אנא בחר תאריך');
            return;
        }
        
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        await fetch(`${API_BASE_URL}/api/tasks/`+id, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ shift_date: newDate })
        });
        
        closeMovePopup();
        renderOpenTasks();
    }

    // Close move popup
    function closeMovePopup() {
        const popup = document.querySelector('div[style*="position: fixed"]');
        if (popup) {
            popup.remove();
        }
    }

    // מחיקה
    async function deleteTask(id) {
        if (!confirm("למחוק את המשימה?")) return;
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        await fetch(`${API_BASE_URL}/api/tasks/`+id, {method:'DELETE'});
        renderOpenTasks();
    }

    // משימות סגורות
    async function renderClosedTasks() {
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        const res = await fetch(`${API_BASE_URL}/api/tasks/all`);
        let tasks = await res.json();
        let filterMonth = document.getElementById('filter-month').value || new Date().toISOString().slice(0,7);
        // הצג כל משימה שסטטוס שלה "בוצע" או "סגורה"
        let filtered = tasks.filter(t => (t.status === "בוצע" || t.status === "סגורה"));
        // אם המשתמש בחר חודש, סנן לפי חודש
        if (filterMonth) {
            filtered = filtered.filter(t => {
                if (!t.shift_date) return false;
                // Handle both date formats
                let taskDate = t.shift_date;
                if (taskDate.includes('.')) {
                    // Israeli format: dd.mm.yyyy
                    let parts = taskDate.split('.');
                    if (parts.length === 3) {
                        taskDate = `${parts[2]}-${parts[1].padStart(2, '0')}`;
                    }
                } else if (taskDate.includes('-')) {
                    // ISO format: yyyy-mm-dd
                    taskDate = taskDate.slice(0, 7);
                }
                return taskDate === filterMonth;
            });
        }
        filtered.sort((a, b) => (b.closed_at || '').localeCompare(a.closed_at || ''));
        const list = document.getElementById('closed-tasks-list');
        if (!filtered.length) {
            list.innerHTML = "<div style='color:#888; margin:22px 0;'>אין משימות סגורות לחודש זה</div>";
            return;
        }
        list.innerHTML = `<div style='color:#4891ca; margin-bottom:15px; font-weight:bold;'>נמצאו ${filtered.length} משימות סגורות</div>`;
        filtered.forEach(t=>{
            list.innerHTML += `
            <div class="task-row done">
                <span class="task-text">${t.text}</span>
                <span class="task-meta">[${t.creator_name || 'לא ידוע'}]</span>
                <span class="task-meta">${formatDate(t.shift_date)}</span>
                <span class="task-meta">סגר: ${t.closed_by_name || "לא ידוע"}</span>
            </div>
            `;
        });
    }

    // משימות שלי
    async function renderMyTasks() {
        const userData = getCurrentUserData();
        if (!userData.userId) {
            document.getElementById('my-tasks-list').innerHTML = "<div style='color:#888; margin:22px 0;'>יש להתחבר כדי לראות משימות משוייכות</div>";
            return;
        }
        
        const API_BASE_URL = (location.port === '8080') ? 'http://localhost:4000' : '';
        const res = await fetch(`${API_BASE_URL}/api/tasks/assigned/${userData.userId}?open_only=true`);
        let tasks = await res.json();
        let filterDate = document.getElementById('my-tasks-filter-date').value;
        
        // הצג כל משימה שאינה "בוצע"
        let filtered = tasks.filter(t => t.status !== "בוצע");
        
        // אם המשתמש בחר תאריך, סנן לפי תאריך, אחרת הצג הכל
        if (filterDate) {
            filtered = filtered.filter(t => {
                if (!t.shift_date) return false;
                // Convert Israeli date format to ISO for comparison
                let taskDate = t.shift_date;
                if (taskDate.includes('.')) {
                    let parts = taskDate.split('.');
                    if (parts.length === 3) {
                        taskDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
                return taskDate === filterDate;
            });
        }
        
        filtered.sort((a, b) => a.created_at.localeCompare(b.created_at));
        const list = document.getElementById('my-tasks-list');
        const countElement = document.getElementById('my-tasks-count');
        
        countElement.textContent = filtered.length ? `סה"כ ${filtered.length} משימות משוייכות אליי` : '';
        
        if (!filtered.length) {
            list.innerHTML = "<div style='color:#888; margin:22px 0;'>אין משימות משוייכות אליי</div>";
            return;
        }
        
        list.innerHTML = "";
        filtered.forEach(t=>{
            list.innerHTML += `
            <div class="task-row">
                <span class="task-text">${t.text}</span>
                <span class="task-meta">[${t.creator_name || 'לא ידוע'}]</span>
                <span class="task-meta">${formatDate(t.shift_date)}</span>
                <div class="task-actions">
                    <button class="btn btn-small" onclick="closeTask(${t.id})">בוצע</button>
                    <button class="btn btn-small" style="background:#c6ceec;color:#223;" onclick="moveTaskDate(${t.id})">העבר יום</button>
                </div>
            </div>
            `;
        });
    }

    // תצוגת תאריך
    function formatDate(d) {
        if (!d) return "";
        
        // Handle Israeli date format (dd.mm.yyyy)
        if (d.includes('.')) {
            let arr = d.split(".");
            if (arr.length === 3) {
                return `${arr[0]}/${arr[1]}/${arr[2]}`;
            }
        }
        
        // Handle ISO date format (yyyy-mm-dd)
        if (d.includes('-')) {
            let arr = d.split("-");
            if (arr.length === 3) {
                return `${arr[2]}/${arr[1]}/${arr[0]}`;
            }
        }
        
        // Fallback - return as is
        return d;
    }

    // אתחול תאריכים
    document.addEventListener("DOMContentLoaded", ()=>{
        document.getElementById('task-date').value = new Date().toISOString().slice(0,10);
        document.getElementById('filter-date').value = '';
        document.getElementById('filter-date').onchange = renderOpenTasks;
        document.getElementById('my-tasks-filter-date').value = '';
        document.getElementById('my-tasks-filter-date').onchange = renderMyTasks;
        document.getElementById('filter-month').value = new Date().toISOString().slice(0,7);
        document.getElementById('filter-month').onchange = renderClosedTasks;
        loadGuides();
        renderOpenTasks();
        renderMyTasks();
    });
    
    // UX: כפתור הצג הכל
    document.addEventListener('DOMContentLoaded', function() {
        const showAllBtn = document.getElementById('show-all-btn');
        if (showAllBtn) {
            showAllBtn.onclick = function() {
                document.getElementById('filter-date').value = '';
                renderOpenTasks();
            };
        }
        const filterDate = document.getElementById('filter-date');
        if (filterDate) {
            filterDate.onchange = renderOpenTasks;
        }
        
        // My Tasks show all button
        const myTasksShowAllBtn = document.getElementById('my-tasks-show-all-btn');
        if (myTasksShowAllBtn) {
            myTasksShowAllBtn.onclick = function() {
                document.getElementById('my-tasks-filter-date').value = '';
                renderMyTasks();
            };
        }
        const myTasksFilterDate = document.getElementById('my-tasks-filter-date');
        if (myTasksFilterDate) {
            myTasksFilterDate.onchange = renderMyTasks;
        }
    });
    
    // וודא שהפונקציה renderHeaderUser נקראת אחרי שהכל נטען
    window.addEventListener('load', function() {
        console.log('Window loaded, calling renderHeaderUser...');
        setTimeout(() => {
          renderHeaderUser();
        }, 500);
    });

    // HEADER
    fetch('header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-header').innerHTML = html;
        // וודא שהאלמנטים קיימים לפני קריאת הפונקציה
        setTimeout(() => {
          console.log('Header loaded, calling renderHeaderUser...');
          console.log('header-user element:', document.getElementById('header-user'));
          console.log('header-role element:', document.getElementById('header-role'));
          renderHeaderUser();
        }, 100);
      });
    // FOOTER
    fetch('footer.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('main-footer').innerHTML = html;
      });

    </script>
    <script src="header-functions.js"></script>
</body>
</html>

